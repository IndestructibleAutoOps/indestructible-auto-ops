apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  name: gl-quantum-naming-policy
  namespace: governance
  labels:
    gl-version: v10.0.0
    tier: quantum-naming
spec:
  validationFailureAction: enforce
  background: true
  rules:
    - name: enforce-deployment-naming
      match:
        resources:
          kinds:
            - Deployment
      validate:
        message: "Deployment name must follow pattern: (dev|staging|prod)-[a-z0-9-]+-deploy-vX.Y.Z"
        pattern:
          metadata:
            name: "^(dev|staging|prod)-[a-z0-9-]+-deploy-v[0-9]+\\.[0-9]+\\.[0-9]+"
            
    - name: enforce-service-naming
      match:
        resources:
          kinds:
            - Service
      validate:
        message: "Service name must follow pattern: (dev|staging|prod)-[a-z0-9-]+-svc-vX.Y.Z"
        pattern:
          metadata:
            name: "^(dev|staging|prod)-[a-z0-9-]+-svc-v[0-9]+\\.[0-9]+\\.[0-9]+"
            
    - name: enforce-ingress-naming
      match:
        resources:
          kinds:
            - Ingress
      validate:
        message: "Ingress name must follow pattern: (dev|staging|prod)-[a-z0-9-]+-ing-vX.Y.Z"
        pattern:
          metadata:
            name: "^(dev|staging|prod)-[a-z0-9-]+-ing-v[0-9]+\\.[0-9]+\\.[0-9]+"
            
    - name: require-standard-labels
      match:
        resources:
          kinds:
            - Deployment
            - Service
            - Ingress
            - ConfigMap
            - Secret
      validate:
        message: "Missing required standard labels"
        pattern:
          metadata:
            labels:
              app.kubernetes.io/name: ".*"
              app.kubernetes.io/version: ".*"
              app.kubernetes.io/managed-by: ".*"
              machinenativeops.gl/environment: ".*"
              machinenativeops.gl/tier: ".*"
              
    - name: enforce-environment-values
      match:
        resources:
          kinds:
            - Deployment
            - Service
            - Ingress
            - ConfigMap
            - Secret
      validate:
        message: "machinenativeops.gl/environment label must be one of: dev, staging, prod"
        pattern:
          metadata:
            labels:
              machinenativeops.gl/environment: "^(dev|staging|prod)$"