# 瀏覽器操作員完整部署、運營與監控指南 v1.0\n\n## 執行摘要\n\n本指南涵蓋瀏覽器操作員一站式集成系統的完整部署、運營與監控流程。從基礎設施準備、系統配置、到生產運維與問題排查，提供具體的操作步驟、最佳實踐與應急預案。本指南適用於系統管理員、DevOps 工程師與運維團隊。\n\n---\n\n## 第一部分：部署架構\n\n### 部署拓撲\n\n系統採用多層高可用架構，支持水平擴展與故障轉移。\n\n```\n┌─────────────────────────────────────────────────────────┐\n│          外部負載均衡器 (AWS NLB/ALB)                  │\n│     SSL/TLS 終止、流量分配、健康檢查                   │\n└─────────────────────────────────────────────────────────┘\n                     ↓ (TCP:443, TCP:6379, TCP:9092)\n        ┌───────────────────────────────────────┐\n        │    Kubernetes 集群（3 個 Master）    │\n        │   高可用 etcd、API Server、Controller│\n        └───────────────────────────────────────┘\n        ↓\n    ┌─────────────────────────────────────┐\n    │   工作節點池（3-10 個節點）         │\n    ├─────────────────────────────────────┤\n    │  • API Pod (3 副本)                 │\n    │  • Policy Engine Pod (3 副本)       │\n    │  • Audit Service Pod (3 副本)       │\n    │  • Browser Operator Pod (3-6 副本)  │\n    │  • Monitoring Pod (2 副本)          │\n    │  • Event Processor Pod (3 副本)     │\n    └─────────────────────────────────────┘\n        ↓\n    ┌─────────────────────────────────────┐\n    │   儲存層                            │\n    ├─────────────────────────────────────┤\n    │  • Redis Cluster (6 個節點)         │\n    │  • Elasticsearch (3 個節點)         │\n    │  • PostgreSQL (1 Master + 2 Replica)│\n    │  • Vault HSM Integration            │\n    └─────────────────────────────────────┘\n        ↓\n    ┌─────────────────────────────────────┐\n    │   外部服務                          │\n    ├─────────────────────────────────────┤\n    │  • AWS CloudHSM (金鑰存儲)         │\n    │  • AWS CloudWatch (監控)            │\n    │  • DataDog/New Relic (APM)          │\n    │  • PagerDuty (告警升報)             │\n    └─────────────────────────────────────┘\n```\n\n### 前置需求\n\n**硬體需求**\n\n| 組件 | 最小配置 | 建議配置 | 高負載配置 |\n|-----|---------|--------|----------|\n| **API 節點** | 2 CPU, 4 GB RAM | 4 CPU, 8 GB RAM | 8 CPU, 16 GB RAM |\n| **Policy Engine** | 2 CPU, 4 GB RAM | 4 CPU, 8 GB RAM | 8 CPU, 16 GB RAM |\n| **Redis Master** | 4 CPU, 8 GB RAM | 8 CPU, 16 GB RAM | 16 CPU, 64 GB RAM |\n| **Elasticsearch** | 4 CPU, 8 GB RAM | 8 CPU, 16 GB RAM | 16 CPU, 32 GB RAM |\n| **PostgreSQL** | 4 CPU, 8 GB RAM | 8 CPU, 16 GB RAM | 16 CPU, 32 GB RAM |\n\n**軟體需求**\n\n- Kubernetes 1.26+\n- Docker 20.10+\n- Python 3.10+\n- Redis 7.0+\n- Elasticsearch 8.0+\n- PostgreSQL 14+\n\n**網路需求**\n\n- 帶寬：最少 1 Gbps\n- 延遲：內部 < 5ms，外部 < 100ms\n- 丟包率：< 0.1%\n- DNS 解析可靠性：99.9%+\n\n---\n\n## 第二部分：系統配置\n\n### 環境變數配置\n\n**關鍵配置文件** (`/etc/browser-operator/config.env`)\n\n```bash\n# 核心配置\nENVIRONMENT=production\nDEBUG=false\nLOG_LEVEL=INFO\n\n# Redis 配置\nREDIS_URL=redis://redis-master:6379/0\nREDIS_CLUSTER_ENABLED=true\nREDIS_CLUSTER_NODES=redis-node-1:6379,redis-node-2:6379,redis-node-3:6379\nREDIS_PASSWORD=<SECURE_PASSWORD>\nREDIS_POOL_SIZE=100\nREDIS_TIMEOUT=5000\n\n# 資料庫配置\nDATABASE_URL=postgresql://user:password@postgres-master:5432/browser_operator\nDATABASE_POOL_SIZE=50\nDATABASE_POOL_TIMEOUT=30\nDATABASE_REPLICATION_LAG_ALERT=5000  # 毫秒\n\n# Elasticsearch 配置\nELASTICSEARCH_HOSTS=elasticsearch-1:9200,elasticsearch-2:9200,elasticsearch-3:9200\nELASTICSEARCH_INDEX_PREFIX=browser_operator\nELASTICSEARCH_SHARDS=5\nELASTICSEARCH_REPLICAS=2\n\n# 事件系統\nKAFKA_BROKERS=kafka-1:9092,kafka-2:9092,kafka-3:9092\nKAFKA_TOPICS=browser.session,browser.operation,security.violation\nKAFKA_GROUP_ID=browser_operator\nKAFKA_CONSUMER_THREADS=10\n\n# 密鑰管理 (HSM)\nHSM_TYPE=CloudHSM  # 或 Luna, SoftHSM\nHSM_ENDPOINT=cloudhsm.ap-southeast-1.amazonaws.com\nHSM_CLUSTER_ID=cluster-abc123def\nHSM_CREDENTIALS_PATH=/secrets/hsm_credentials\nHSM_PIN=<SECURE_PIN>\n\n# MFA 配置\nMFA_PROVIDER=Okta\nMFA_ISSUER=IndestructibleAutoOps\nMFA_TOTP_WINDOW=30\n\n# 會話配置\nSESSION_TIMEOUT_MINUTES=30\nMAX_CONCURRENT_SESSIONS=3\nMAX_OPERATIONS_PER_HOUR=10000\n\n# 安全配置\nENCRYPTION_KEY_ROTATION_DAYS=90\nAUDIT_LOG_RETENTION_YEARS=10\nTLS_MIN_VERSION=1.3\nTLS_CIPHERS=TLS_AES_256_GCM_SHA384:TLS_CHACHA20_POLY1305_SHA256\n\n# 監控配置\nMETRICS_PORT=9090\nMETRICS_PATH=/metrics\nHEALTH_CHECK_PATH=/health\nLIVENESS_PROBE_INTERVAL=10\nREADINESS_PROBE_INTERVAL=5\n\n# 告警配置\nALERT_EMAIL_SMTP=smtp.example.com:587\nALERT_SLACK_WEBHOOK=https://hooks.slack.com/services/...\nALERT_PD_INTEGRATION_KEY=<KEY>\nALERT_ESCALATION_THRESHOLD_CRITICAL=2  # 升報為關鍵\nALERT_ESCALATION_THRESHOLD_HIGH=5      # 升報為高\n```\n\n### Kubernetes 部署清單\n\n**API 服務部署** (`deployments/api-server.yaml`)\n\n```yaml\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: browser-operator-api\n  namespace: browser-operator\nspec:\n  replicas: 3\n  strategy:\n    type: RollingUpdate\n    rollingUpdate:\n      maxSurge: 1\n      maxUnavailable: 0\n  selector:\n    matchLabels:\n      app: browser-operator-api\n  template:\n    metadata:\n      labels:\n        app: browser-operator-api\n        version: v1.0\n    spec:\n      serviceAccountName: browser-operator\n      securityContext:\n        runAsNonRoot: true\n        runAsUser: 1000\n        fsGroup: 1000\n      \n      containers:\n      - name: api-server\n        image: browser-operator:v1.0\n        imagePullPolicy: IfNotPresent\n        \n        ports:\n        - name: http\n          containerPort: 8080\n        - name: metrics\n          containerPort: 9090\n        \n        env:\n        - name: ENVIRONMENT\n          value: \"production\"\n        - name: REDIS_URL\n          valueFrom:\n            configMapKeyRef:\n              name: browser-operator-config\n              key: redis_url\n        - name: DATABASE_URL\n          valueFrom:\n            secretKeyRef:\n              name: browser-operator-secrets\n              key: database_url\n        - name: HSM_PIN\n          valueFrom:\n            secretKeyRef:\n              name: browser-operator-secrets\n              key: hsm_pin\n        \n        resources:\n          requests:\n            memory: \"4Gi\"\n            cpu: \"2\"\n          limits:\n            memory: \"8Gi\"\n            cpu: \"4\"\n        \n        livenessProbe:\n          httpGet:\n            path: /health/live\n            port: 8080\n          initialDelaySeconds: 30\n          periodSeconds: 10\n          timeoutSeconds: 5\n          failureThreshold: 3\n        \n        readinessProbe:\n          httpGet:\n            path: /health/ready\n            port: 8080\n          initialDelaySeconds: 10\n          periodSeconds: 5\n          timeoutSeconds: 3\n          failureThreshold: 2\n        \n        volumeMounts:\n        - name: hsm-credentials\n          mountPath: /secrets/hsm_credentials\n          readOnly: true\n        - name: tls-certs\n          mountPath: /etc/tls\n          readOnly: true\n      \n      volumes:\n      - name: hsm-credentials\n        secret:\n          secretName: hsm-credentials\n      - name: tls-certs\n        secret:\n          secretName: tls-certs\n      \n      affinity:\n        podAntiAffinity:\n          preferredDuringSchedulingIgnoredDuringExecution:\n          - weight: 100\n            podAffinityTerm:\n              labelSelector:\n                matchExpressions:\n                - key: app\n                  operator: In\n                  values:\n                  - browser-operator-api\n              topologyKey: kubernetes.io/hostname\n```\n\n---\n\n## 第三部分：操作員工作手冊\n\n### 啟動與初始化\n\n**第一步：檢查前置條件**\n\n```bash\n# 檢查 Kubernetes 集群狀態\nkubectl cluster-info\nkubectl get nodes\n\n# 檢查命名空間\nkubectl create namespace browser-operator\nkubectl config set-context --current --namespace=browser-operator\n\n# 檢查儲存類\nkubectl get storageclass\n\n# 檢查外部服務可達性\ntelnet redis-cluster.example.com 6379\ntelnet elasticsearch.example.com 9200\ntelnet postgres.example.com 5432\n```\n\n**第二步：部署基礎設施**\n\n```bash\n# 1. 建立命名空間與 RBAC\nkubectl apply -f namespaces/browser-operator.yaml\nkubectl apply -f rbac/\n\n# 2. 部署配置和機密\nkubectl create configmap browser-operator-config \\\n  --from-file=config/config.env \\\n  --namespace=browser-operator\n\nkubectl create secret generic browser-operator-secrets \\\n  --from-file=config/secrets.txt \\\n  --namespace=browser-operator\n\n# 3. 部署存儲\nkubectl apply -f storage/pvc.yaml\n\n# 4. 初始化資料庫\nkubectl run db-init \\\n  --image=browser-operator:v1.0 \\\n  --command -- python /app/scripts/init_database.py\n\n# 5. 初始化 Elasticsearch 索引\nkubectl run es-init \\\n  --image=browser-operator:v1.0 \\\n  --command -- python /app/scripts/init_elasticsearch.py\n```\n\n**第三步：部署應用**\n\n```bash\n# 1. 部署 API 服務\nkubectl apply -f deployments/api-server.yaml\nkubectl apply -f services/api-service.yaml\n\n# 2. 部署政策引擎\nkubectl apply -f deployments/policy-engine.yaml\n\n# 3. 部署審計服務\nkubectl apply -f deployments/audit-service.yaml\n\n# 4. 部署監控\nkubectl apply -f deployments/monitoring.yaml\n\n# 5. 驗證部署\nkubectl rollout status deployment/browser-operator-api\nkubectl get pods\n```\n\n**第四步：驗證系統**\n\n```bash\n# 檢查 Pod 狀態\nkubectl get pods -o wide\n\n# 檢查服務\nkubectl get svc\n\n# 檢查日誌\nkubectl logs -f deployment/browser-operator-api\n\n# 測試 API 連接\nkubectl port-forward svc/browser-operator-api 8080:8080\ncurl http://localhost:8080/health\n\n# 驗證會話管理\nkubectl exec -it <pod-name> -- redis-cli -h redis-master info\n```\n\n### 日常操作\n\n**監控系統健康**\n\n```bash\n# 1. 檢查資源使用\nkubectl top nodes\nkubectl top pods\n\n# 2. 查看事件\nkubectl get events --sort-by='.lastTimestamp'\n\n# 3. 檢查副本集狀態\nkubectl get rs\nkubectl describe rs <rs-name>\n\n# 4. 監控持久存儲\nkubectl get pvc\nkubectl df -h\n\n# 5. 檢查 Redis 狀態\nredis-cli -h redis-master --latency\nredis-cli -h redis-master info memory\nredis-cli -h redis-master info replication\n```\n\n**執行維護任務**\n\n```bash\n# 1. 更新應用（藍綠部署）\nkubectl set image deployment/browser-operator-api \\\n  browser-operator=browser-operator:v1.1 \\\n  --record\n\n# 監控部署進度\nkubectl rollout status deployment/browser-operator-api\n\n# 2. 備份審計日誌\nkubectl exec -it <elasticsearch-pod> -- \\\n  elasticdump \\\n  --input=http://localhost:9200/browser_operator-* \\\n  --output=/backups/audit-$(date +%Y%m%d).json\n\n# 3. 旋轉密鑰\nkubectl exec -it <api-pod> -- \\\n  python /app/scripts/rotate_keys.py\n\n# 4. 執行策略更新\nkubectl create configmap policy-rules \\\n  --from-file=policies/rules.yaml \\\n  --dry-run=client -o yaml | kubectl apply -f -\n\n# 5. 垃圾收集\nkubectl delete pods --field-selector status.phase=Failed\nkubectl delete pods --field-selector status.phase=Succeeded\n```\n\n### 故障排查\n\n**常見問題與解決方案**\n\n| 問題 | 症狀 | 診斷命令 | 解決方案 |\n|-----|------|--------|----------|\n| **Pod 無法啟動** | CrashLoopBackOff | `kubectl logs <pod>` | 檢查環境變數、依賴服務 |\n| **Redis 連接失敗** | 所有操作超時 | `redis-cli -h redis-master ping` | 驗證 Redis 狀態、防火牆規則 |\n| **Elasticsearch 不可用** | 審計日誌寫入失敗 | `curl http://es:9200/_health` | 檢查磁碟空間、索引狀態 |\n| **高延遲** | P99 > 5 秒 | `kubectl top nodes`, 查看指標 | 添加節點、優化查詢 |\n| **記憶體洩漏** | RAM 持續增長 | `kubectl describe node` | 檢查應用日誌、重啟 Pod |\n\n---\n\n## 第四部分：監控與告警\n\n### 關鍵指標\n\n| 指標 | 目標 | 告警閾值 | 檢查頻率 |\n|-----|------|---------|----------|\n| **操作成功率** | > 99.9% | < 99.5% | 1 分鐘 |\n| **API 響應延遲 (p99)** | < 200 ms | > 500 ms | 1 分鐘 |\n| **會話建立延遲** | < 100 ms | > 300 ms | 5 分鐘 |\n| **審計日誌延遲** | < 500 ms | > 1000 ms | 5 分鐘 |\n| **政策決策延遲** | < 50 ms | > 100 ms | 1 分鐘 |\n| **Redis 記憶體使用** | < 70% | > 85% | 1 分鐘 |\n| **Elasticsearch 磁碟使用** | < 75% | > 90% | 5 分鐘 |\n| **Pod 重啟率** | 0 | > 1 次/小時 | 10 分鐘 |\n| **規則違反檢測率** | > 99.9% | < 99.5% | 5 分鐘 |\n\n### Prometheus 監控配置\n\n```yaml\n# prometheus.yml\nglobal:\n  scrape_interval: 15s\n  evaluation_interval: 15s\n\nscrape_configs:\n  - job_name: 'browser-operator-api'\n    kubernetes_sd_configs:\n      - role: pod\n        namespaces:\n          names:\n          - browser-operator\n    relabel_configs:\n      - source_labels: [__meta_kubernetes_pod_label_app]\n        action: keep\n        regex: browser-operator-api\n\n  - job_name: 'redis'\n    static_configs:\n      - targets: ['redis-master:9121']\n\n  - job_name: 'elasticsearch'\n    static_configs:\n      - targets: ['elasticsearch:9114']\n\nalert_rules_files:\n  - '/etc/prometheus/rules/*.yml'\n```\n\n### Grafana 儀表板\n\n**系統概覽儀表板應包含**：\n\n1. **高層指標**\n   - 操作吞吐量（ops/秒）\n   - 平均延遲（毫秒）\n   - 錯誤率（%）\n   - 違反檢測數（個/分鐘）\n\n2. **資源使用**\n   - CPU 使用率（%）\n   - 記憶體使用率（%）\n   - 磁碟 I/O（MB/秒）\n   - 網路頻寬（Mbps）\n\n3. **安全指標**\n   - 認證失敗（個/分鐘）\n   - 政策違反（個/分鐘）\n   - 隔離會話（個/小時）\n   - 密鑰輪換狀態\n\n---\n\n## 第五部分：災難恢復\n\n### 備份策略\n\n**資料備份**\n\n```bash\n# 每日備份審計日誌\n0 2 * * * elasticdump \\\n  --input=http://elasticsearch:9200/browser_operator-$(date +\\%Y.\\%m.\\%d) \\\n  --output=s3://backups/audit-$(date +\\%Y\\%m\\%d).json\n\n# 每週備份資料庫\n0 3 * * 0 pg_dump -h postgres-master \\\n  -U browser_operator \\\n  browser_operator | gzip | \\\n  aws s3 cp - s3://backups/database-$(date +%Y%m%d).sql.gz\n\n# 持續備份配置\nwatch -n 3600 'kubectl get configmaps -o yaml > /backups/config-$(date +%s).yaml'\n```\n\n**備份驗證**\n\n```bash\n# 週一驗證備份\n0 4 * * 1 bash /scripts/verify_backups.sh\n\n# 月度恢復測試\n0 5 1 * * bash /scripts/disaster_recovery_test.sh\n```\n\n### 故障恢復流程\n\n**情景 1：單個 Pod 故障**\n\n```bash\n# 系統自動執行（Kubernetes 健康檢查）\n# Pod 自動重啟，無需手動干預\nkubectl get pods  # 驗證新 Pod\n```\n\n**情景 2：節點故障**\n\n```bash\n# 1. 標記節點為不可用\nkubectl cordon <node-name>\n\n# 2. 驅逐工作負載\nkubectl drain <node-name> --ignore-daemonsets\n\n# 3. Pod 自動轉移至其他節點\nkubectl get pods -o wide\n\n# 4. 修復節點後\nkubectl uncordon <node-name>\n```\n\n**情景 3：資料中心故障**\n\n```bash\n# 1. 激活備用資料中心\nexport KUBE_CONTEXT=dr-cluster\nkubectl config use-context dr-cluster\n\n# 2. 恢復最新備份\nbash /scripts/restore_from_backup.sh latest\n\n# 3. 驗證系統功能\nbash /scripts/smoke_tests.sh\n\n# 4. 更新 DNS/負載均衡器指向新集群\naws route53 change-resource-record-sets \\\n  --hosted-zone-id Z123456 \\\n  --change-batch file:///dns-changes.json\n```\n\n---\n\n## 第六部分：最佳實踐\n\n### 安全實踐\n\n1. **密鑰管理**：所有密鑰存儲在 HSM 中，不可導出\n2. **審計完整性**：日誌簽署與密碼學驗證\n3. **多因子認證**：所有人員操作需要 MFA\n4. **最小權限**：RBAC 嚴格限制權限\n5. **定期審計**：月度安全審計與滲透測試\n\n### 性能最佳實踐\n\n1. **連接池**：配置適當的連接池大小\n2. **緩存策略**：使用 Redis 緩存頻繁查詢\n3. **非同步處理**：事件驅動架構提高吞吐量\n4. **水平擴展**：根據負載自動擴展副本\n5. **查詢優化**：定期審查慢查詢日誌\n\n### 可靠性最佳實踐\n\n1. **冗餘設計**：所有組件至少 3 副本\n2. **故障轉移**：自動故障檢測與切換\n3. **定期演習**：月度災難恢復測試\n4. **監控告警**：24/7 主動監控\n5. **文檔維護**：保持運維文檔最新\n\n---\n\n**版本**: 1.0  \n**最後更新**: 2026 年 2 月 5 日  \n**所有者**: IndestructibleAutoOps 運維團隊\n