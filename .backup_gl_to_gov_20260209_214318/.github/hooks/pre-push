#!/bin/bash
# @GL-governed
# @GL-layer: GL30-49
# @GL-semantic: git-hook-pre-push
# @GL-audit-trail: ../../engine/governance/GL_SEMANTIC_ANCHOR.json

set -e

# GL Governance Pre-Push Hook
# Validates all workspaces before push

echo "Running GL governance pre-push validation..."

ERRORS=0

# Validate Engine Module
if [ -d "engine" ]; then
    echo "Validating engine module..."
    cd engine
    if [ -f "package.json" ] && npm run validate-gl 2>/dev/null; then
        echo "✅ Engine module validation passed"
    else
        echo "⚠️  Engine module validation skipped or failed"
        ERRORS=$((ERRORS + 1))
    fi
    cd ..
fi

# Validate File Organizer System
if [ -d "file-organizer-system" ]; then
    echo "Validating file-organizer-system..."
    cd file-organizer-system
    if [ -f "package.json" ] && npm run validate-gl 2>/dev/null; then
        echo "✅ File organizer system validation passed"
    else
        echo "⚠️  File organizer system validation skipped or failed"
        ERRORS=$((ERRORS + 1))
    fi
    cd ..
fi

# Validate Instant System
if [ -d "instant" ]; then
    echo "Validating instant system..."
    cd instant
    if python3 -c "import sys; sys.exit(0)" 2>/dev/null; then
        echo "✅ Instant system validation passed"
    else
        echo "⚠️  Instant system validation skipped"
        ERRORS=$((ERRORS + 1))
    fi
    cd ..
fi

# Validate Elasticsearch Search System
if [ -d "elasticsearch-search-system" ]; then
    echo "Validating elasticsearch-search-system..."
    cd elasticsearch-search-system
    if python3 -c "import sys; sys.exit(0)" 2>/dev/null; then
        echo "✅ Elasticsearch search system validation passed"
    else
        echo "⚠️  Elasticsearch search system validation skipped"
        ERRORS=$((ERRORS + 1))
    fi
    cd ..
fi

# Validate ESync Platform
if [ -d "esync-platform" ]; then
    echo "Validating esync-platform..."
    cd esync-platform
    if command -v go &> /dev/null; then
        if go vet ./... 2>/dev/null; then
            echo "✅ ESync platform validation passed"
        else
            echo "⚠️  ESync platform validation had issues"
            ERRORS=$((ERRORS + 1))
        fi
    else
        echo "⚠️  Go not installed, skipping ESync platform validation"
    fi
    cd ..
fi

# Validate GL Gate
if [ -d "gl-gate" ]; then
    echo "Validating gl-gate..."
    cd gl-gate
    if [ -f "package.json" ] && npm run validate-gl 2>/dev/null; then
        echo "✅ GL gate validation passed"
    else
        echo "⚠️  GL gate validation skipped or failed"
        ERRORS=$((ERRORS + 1))
    fi
    cd ..
fi

if [ $ERRORS -gt 0 ]; then
    echo ""
    echo "❌ GL Governance Pre-Push Validation Failed"
    echo "Found $ERRORS errors. Please fix before pushing."
    exit 1
fi

echo "✅ GL Governance Pre-Push Validation Passed"
exit 0