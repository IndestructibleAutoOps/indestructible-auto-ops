# @GL-governed
# @GL-layer: GL90-99
# @GL-semantic: governed-configuration
# @GL-audit-trail: engine/governance/GL_SEMANTIC_ANCHOR.json

# AWS Infrastructure Configuration - Secrets Manager
# Provider: AWS

apiVersion: "v1"
kind: "Config"
metadata:
  name: "aws-secrets-manager"
  provider: "aws"
  region: "us-east-1"

# AWS Secrets Manager Configuration
secrets_manager:
  enabled: true
  endpoint_url: "secretsmanager.{{ .Values.region }}.amazonaws.com"
  
  # Secret Rotation Configuration
  rotation:
    enabled: true
    lambda_rotation_role: "arn:aws:iam::ACCOUNT_ID:role/SecretsManagerRotationRole"
    rotation_lambda_arn: "arn:aws:lambda:REGION:ACCOUNT_ID:function:SecretRotation"
    rotation_rules:
      automatically_after_days: 30
  
  # Secret Templates
  secret_templates:
    database_credentials:
      name_prefix: "db-credentials"
      description: "Database credentials for {{ .Values.database.name }}"
      generate_secret_string:
        secret_string_template: '{{"username":"{{username}}","password":"{{password}}","engine":"{{engine}}","host":"{{host}}","port":"{{port}}","dbname":"{{dbname}}"}}'
        generate_string_config:
          password_length: 32
          exclude_characters: '"@/\\'
      tags:
        - key: "Environment"
          value: "{{ .Values.environment }}"
        - key: "Application"
          value: "{{ .Values.application.name }}"
    
    api_keys:
      name_prefix: "api-key"
      description: "API key for {{ .Values.application.name }}"
      generate_secret_string:
        secret_string_template: '{"api_key":"{{random_api_key}}"}'
        generate_string_config:
          password_length: 64
          exclude_characters: '"@/\\'
      tags:
        - key: "Type"
          value: "API Key"
        - key: "Environment"
          value: "{{ .Values.environment }}"
    
    oauth_tokens:
      name_prefix: "oauth-token"
      description: "OAuth token for {{ .Values.application.name }}"
      secret_string: '{"access_token":"{{access_token}}","refresh_token":"{{refresh_token}}","expires_at":"{{expires_at}}"}'
      tags:
        - key: "Type"
          value: "OAuth Token"
        - key: "Provider"
          value: "{{ .Values.oauth.provider }}"

# KMS Configuration for Encryption
kms:
  enabled: true
  key_arn: "arn:aws:kms:REGION:ACCOUNT_ID:key/{{ .Values.kms.keyId }}"
  encryption_context:
    Environment: "{{ .Values.environment }}"
    Application: "{{ .Values.application.name }}"
  
  # Key Policy
  key_policy:
    version: "2012-10-17"
    statement:
      - sid: "Enable IAM User Permissions"
        effect: "Allow"
        principal:
          aws: "arn:aws:iam::ACCOUNT_ID:root"
        action: "kms:*"
        resource: "*"
      - sid: "Allow Secrets Manager to use key"
        effect: "Allow"
        principal:
          service: "secretsmanager.amazonaws.com"
        action:
          - "kms:Decrypt"
          - "kms:DescribeKey"
          - "kms:Encrypt"
          - "kms:GenerateDataKey*"
          - "kms:ReEncrypt*"
        resource: "*"

# IAM Roles and Policies
iam:
  secrets_manager_access:
    name: "secrets-manager-access-role"
    description: "Role for applications to access Secrets Manager"
    assume_role_policy:
      version: "2012-10-17"
      statement:
        - effect: "Allow"
          principal:
            service: "eks.amazonaws.com"
          action: "sts:AssumeRole"
    managed_policies:
      - "arn:aws:iam::aws:policy/SecretsManagerRead"
      - "arn:aws:iam::aws:policy/SecretsManagerReadWrite"
    inline_policies:
      - name: "LimitedSecretAccess"
        policy:
          version: "2012-10-17"
          statement:
            - effect: "Allow"
              action:
                - "secretsmanager:GetSecretValue"
                - "secretsmanager:DescribeSecret"
              resource:
                - "arn:aws:secretsmanager:REGION:ACCOUNT_ID:secret:{{ .Values.environment }}/*"

# Specific Secrets
secrets:
  # Database Credentials
  - name: "{{ .Values.environment }}/database/primary"
    type: "database_credentials"
    rotation: true
    recovery_window_in_days: 30
    tags:
      - key: "Database"
        value: "primary"
  
  - name: "{{ .Values.environment }}/database/replica"
    type: "database_credentials"
    rotation: true
    recovery_window_in_days: 30
    tags:
      - key: "Database"
        value: "replica"
  
  # API Keys
  - name: "{{ .Values.environment }}/api/external-service"
    type: "api_keys"
    rotation: false
    recovery_window_in_days: 7
    tags:
      - key: "Service"
        value: "external"
  
  # OAuth Tokens
  - name: "{{ .Values.environment }}/oauth/github"
    type: "oauth_tokens"
    rotation: false
    recovery_window_in_days: 7
    tags:
      - key: "Provider"
        value: "github"

# CloudWatch Integration for Secrets Manager
cloudwatch:
  enabled: true
  metrics:
    - name: "SecretsManagerRotationSuccess"
      namespace: "AWS/SecretsManager"
      statistic: "Sum"
      period: 60
      alarm:
        enabled: true
        threshold: 0
        comparison_operator: "LessThanThreshold"
        evaluation_periods: 3
        actions:
          sns: "arn:aws:sns:REGION:ACCOUNT_ID:secrets-alerts"
    
    - name: "SecretsManagerAPIError"
      namespace: "AWS/SecretsManager"
      statistic: "Sum"
      period: 60
      alarm:
        enabled: true
        threshold: 5
        comparison_operator: "GreaterThanThreshold"
        evaluation_periods: 2
        actions:
          sns: "arn:aws:sns:REGION:ACCOUNT_ID:secrets-alerts"

# EventBridge Rules for Secret Events
eventbridge:
  enabled: true
  rules:
    - name: "SecretRotationComplete"
      description: "Triggered when secret rotation completes"
      event_pattern:
        source:
          - "aws.secretsmanager"
        detail-type:
          - "Secrets Manager Rotation Success"
      targets:
        - arn: "arn:aws:lambda:REGION:ACCOUNT_ID:function:RotationCompleteHandler"
          input_transformer:
            input_paths_map:
              secret_name: "$.detail.secret-arn"
            input_template: '{"secret_name": <secret_name>}'
    
    - name: "SecretDeletion"
      description: "Triggered when a secret is deleted"
      event_pattern:
        source:
          - "aws.secretsmanager"
        detail-type:
          - "AWS API Call via CloudTrail"
        detail:
          eventSource:
            - "secretsmanager.amazonaws.com"
          eventName:
            - "DeleteSecret"
      targets:
        - arn: "arn:aws:sns:REGION:ACCOUNT_ID:secrets-audit"

# Backup Configuration
backup:
  enabled: true
  retention_days: 90
  backup_vault_name: "secrets-backup-vault"
  
  # Backup Schedule
  schedules:
    - name: "daily-backup"
      schedule_expression: "cron(0 2 * * ? *)"
      start_window_minutes: 60
      completion_window_minutes: 180
      lifecycle:
        delete_after_days: 90
        move_to_cold_storage_after_days: 30
    
    - name: "weekly-backup"
      schedule_expression: "cron(0 3 ? * SUN *)"
      start_window_minutes: 120
      completion_window_minutes: 240
      lifecycle:
        delete_after_days: 365
        move_to_cold_storage_after_days: 90

# Compliance and Auditing
compliance:
  enabled: true
  cloudtrail:
    log_group_name: "/aws/secrets-manager/audit-logs"
    retention_days: 365
  
  config_recorder:
    name: "secrets-manager-config-recorder"
    recording_group:
      all_supported: false
      include_specific_resource_types:
        - "AWS::SecretsManager::Secret"
  
  security_hub:
    enabled: true
    standards:
      - "aws-foundational-security-best-practices"
      - "cis-aws-foundations-benchmark"