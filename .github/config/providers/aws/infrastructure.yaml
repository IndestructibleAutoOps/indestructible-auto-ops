# AWS Infrastructure Configuration

provider:
  type: aws
  region: us-east-1
  
infrastructure:
  # VPC Configuration
  vpc:
    enabled: true
    cidr: "10.0.0.0/16"
    subnets:
      public:
        count: 2
        cidr_bits: 8
      private:
        count: 3
        cidr_bits: 8
    enable_dns_hostnames: true
    enable_dns_support: true
    nat_gateways:
      enabled: true
      type: "managed"  # managed or single
  
  # Kubernetes (EKS) Configuration
  kubernetes:
    enabled: true
    name: "machine-native-ops"
    version: "1.28"
    endpoint: "PUBLIC"
    logging:
      types:
        - api
        - audit
        - authenticator
        - controllerManager
        - scheduler
    addons:
      vpc-cni:
        enabled: true
      coredns:
        enabled: true
      kube-proxy:
        enabled: true
      aws-ebs-csi-driver:
        enabled: true
    node_groups:
      main:
        min_size: 3
        max_size: 10
        desired_size: 3
        instance_types:
          - "t3.medium"
        capacity_type: "ON_DEMAND"
        labels:
          node-type: "main"
      gpu:
        min_size: 0
        max_size: 5
        desired_size: 0
        instance_types:
          - "g4dn.xlarge"
        capacity_type: "SPOT"
        labels:
          node-type: "gpu"
  
  # Database Configuration
  database:
    enabled: true
    engine: "postgres"
    version: "15.4"
    instance_class: "db.r6g.xlarge"
    allocated_storage: 100
    storage_type: "gp3"
    storage_encrypted: true
    multi_az: true
    backup_retention: 30
    backup_window: "02:00-03:00"
    maintenance_window: "sun:03:00-sun:04:00"
    parameters:
      max_connections: 500
      shared_buffers: "16GB"
      effective_cache_size: "48GB"
  
  # Storage Configuration
  storage:
    enabled: true
    s3:
      buckets:
        artifacts:
          versioning: enabled
          lifecycle:
            rules:
              - id: archive-old-files
                status: enabled
                expiration:
                  days: 90
          encryption:
            server-side: AES256
        backups:
          versioning: enabled
          lifecycle:
            rules:
              - id: archive-old-backups
                status: enabled
                expiration:
                  days: 180
          encryption:
            server-side: AES256
        logs:
          versioning: disabled
          lifecycle:
            rules:
              - id: archive-old-logs
                status: enabled
                expiration:
                  days: 30
    ebs:
      gp3:
        iops: 3000
        throughput: 125
        encrypted: true
  
  # Load Balancer Configuration
  load_balancer:
    enabled: true
    type: "application"
    scheme: "internet-facing"
    subnets: public
    security_groups:
      - allow-http
      - allow-https
    target_groups:
      api:
        port: 8080
        protocol: HTTP
        health_check:
          path: /health
          interval: 30
          timeout: 5
          healthy_threshold: 3
          unhealthy_threshold: 2
  
  # Security Configuration
  security:
    security_groups:
      vpc_flow_logs:
        enabled: true
        retention_days: 30
    iam:
      roles:
        - name: "eks-node-role"
          policies:
            - "AmazonEKSWorkerNodePolicy"
            - "AmazonEKS_CNI_Policy"
            - "AmazonEC2ContainerRegistryReadOnly"
        - name: "eks-cluster-role"
          policies:
            - "AmazonEKSClusterPolicy"
  
  # Monitoring Configuration
  monitoring:
    cloudwatch:
      logs:
        enabled: true
        retention: 30
      metrics:
        namespace: "MachineNativeOps"
        collection_interval: 60
    xray:
      enabled: true