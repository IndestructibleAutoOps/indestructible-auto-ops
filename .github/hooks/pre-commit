#!/bin/bash
# @GL-governed
# @GL-layer: GL10-29
# @GL-semantic: git-hook-pre-commit-validation
# @GL-audit-trail: ../../engine/governance/GL_SEMANTIC_ANCHOR.json

GL_FAILED=0

# Validate GL markers in staged files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

for file in $STAGED_FILES; do
    # Skip non-code files
    if [[ "$file" =~ \.(md|txt|json|yaml|yml)$ ]]; then
        continue
    fi
    
    # Check for GL governance markers
    if [[ -f "$file" ]]; then
        if [[ "$file" =~ \.(ts|tsx|js|jsx|py|go)$ ]]; then
            if ! grep -q "@GL-governed" "$file"; then
                echo "❌ GL violation: $file missing @GL-governed marker"
                GL_FAILED=1
            fi
        fi
    fi
done

# Validate YAML syntax for staged YAML files
for file in $STAGED_FILES; do
    if [[ "$file" =~ \.(yaml|yml)$ ]]; then
        if ! python3 -c "import yaml; yaml.safe_load(open('$file'))" 2>/dev/null; then
            echo "❌ YAML syntax error in $file"
            GL_FAILED=1
        fi
    fi
done

if [ $GL_FAILED -ne 0 ]; then
    echo "❌ GL validation failed. Fix violations before committing."
    exit 1
fi

echo "✅ GL validation passed"
exit 0