#!/bin/bash
# GL Governance Pre-Commit Hook - GL Unified Charter Activated
set -e

echo "GL Unified Charter Activated - Pre-Commit Validation (Strict Mode)"

# Check for GL metadata in changed files
CHANGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(ts|tsx|js|json|yaml|yml)$' || true)

if [ -n "$CHANGED_FILES" ]; then
  echo "Validating GL compliance for changed files..."
  VIOLATIONS=0
  
  for FILE in $CHANGED_FILES; do
    # Check for GL governance markers
    if ! grep -q "@GL-" "$FILE" 2>/dev/null; then
      echo "❌ Error: $FILE missing @GL-governed marker - Commit blocked"
      VIOLATIONS=$((VIOLATIONS + 1))
    fi
    
    # Check for semantic annotations
    if grep -q "engine/\|file-organizer-system/" <<< "$FILE"; then
      if ! grep -q "@GL-layer:" "$FILE" 2>/dev/null; then
        echo "❌ Error: $FILE missing @GL-layer marker - Commit blocked"
        VIOLATIONS=$((VIOLATIONS + 1))
      fi
      if ! grep -q "@GL-semantic:" "$FILE" 2>/dev/null; then
        echo "❌ Error: $FILE missing @GL-semantic marker - Commit blocked"
        VIOLATIONS=$((VIOLATIONS + 1))
      fi
    fi
  done
  
  if [ $VIOLATIONS -gt 0 ]; then
    echo "❌ GL Pre-Commit Validation Failed: $VIOLATIONS violations found"
    exit 1
  fi
fi

# Run GL validation if engine files changed
if echo "$CHANGED_FILES" | grep -q "^engine/"; then
  echo "Running GL Engine validation..."
  cd engine
  npx ts-node governance/gl_engine.ts validate --strict || {
    echo "❌ GL Validation Failed - Commit blocked"
    exit 1
  }
fi

# Run GL validation if file-organizer-system files changed
if echo "$CHANGED_FILES" | grep -q "^file-organizer-system/"; then
  echo "Running GL File Organizer validation..."
  npx ts-node engine/governance/gl_engine.ts validate --strict --workspace=file-organizer-system || {
    echo "❌ GL Validation Failed - Commit blocked"
    exit 1
  }
fi

echo "✅ GL Governance Pre-Commit Check Passed"