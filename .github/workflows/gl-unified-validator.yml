# =============================================================================
# GL Unified Validator Workflow
# Consolidates all GL validation checks into a single workflow
# Replaces: gl-validator.yml, gl10-validator.yml, gl10-phase2-semantic.yml, gl10-top10-validator.yml
# =============================================================================
name: GL Unified Validator

on:
  push:
    branches: [ main ]
    paths:
      - 'gl/**'
      - 'tools/gl*.sh'
      - 'tools/gl*.py'
      - 'project-docs/gl-governance/**'
      - '.gl-index.json'
      - 'GL*.json'
      - 'schemas/GL*.json'
  pull_request:
    branches: [ main ]
    paths:
      - 'gl/**'
      - 'tools/gl*.sh'
      - 'tools/gl*.py'
      - 'project-docs/gl-governance/**'
      - '.gl-index.json'
      - 'GL*.json'
      - 'schemas/GL*.json'
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  PYTHON_VERSION: '3.11'

jobs:
  # ===========================================
  # GL Schema Validator (formerly gl-validator.yml)
  # ===========================================
  gl-schema-validate:
    name: GL Schema Validation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      
      - name: Setup Python
        uses: actions/setup-python@v6
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: Install dependencies
        run: pip install jsonschema
      
      - name: Run GL Schema Validator
        run: ./tools/gl_validator.sh

  # ===========================================
  # GL10 Validator (formerly gl10-validator.yml)
  # ===========================================
  gl10-validate:
    name: GL10 Validation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      
      - name: Setup Python
        uses: actions/setup-python@v6
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: Install dependencies
        run: pip install jsonschema
      
      - name: Run GL10 Validator
        run: |
          if [ -f "./tools/gl10_validator.sh" ]; then
            ./tools/gl10_validator.sh
          else
            echo "⚠️ GL10 validator script not found, skipping"
            echo "::warning::tools/gl10_validator.sh not found"
          fi

  # ===========================================
  # GL10 Phase2 Semantic Validator (formerly gl10-phase2-semantic.yml)
  # ===========================================
  gl10-semantic-validate:
    name: GL10 Semantic Validation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      
      - name: Setup Python
        uses: actions/setup-python@v6
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: Install dependencies
        run: pip install jsonschema
      
      - name: Run GL10 Phase2 Semantic Validator
        run: |
          if [ -f "tools/gl10semanticvalidator.py" ]; then
            python3 tools/gl10semanticvalidator.py
          else
            echo "⚠️ GL10 semantic validator script not found, skipping"
            echo "::warning::tools/gl10semanticvalidator.py not found"
          fi

  # ===========================================
  # GL10 Top10 Validator (formerly gl10-top10-validator.yml)
  # ===========================================
  gl10-top10-validate:
    name: GL10 Top10 Validation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      
      - name: Setup Python
        uses: actions/setup-python@v6
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: Install dependencies
        run: pip install jsonschema
      
      - name: Run GL10 Top10 Validator
        run: |
          if [ -d "gl/10-operational" ] && [ -f "tools/gl10top10validator.py" ]; then
            cd gl/10-operational
            python3 ../../tools/gl10top10validator.py
          else
            echo "⚠️ GL10 Top10 validator prerequisites not found, skipping"
            echo "::warning::gl/10-operational directory or tools/gl10top10validator.py not found"
          fi

  # ===========================================
  # Summary Job - Reports overall validation status
  # ===========================================
  validation-summary:
    name: Validation Summary
    runs-on: ubuntu-latest
    needs: [gl-schema-validate, gl10-validate, gl10-semantic-validate, gl10-top10-validate]
    if: always()
    steps:
      - name: Check validation results
        run: |
          echo "## GL Validation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Validator | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| GL Schema | ${{ needs.gl-schema-validate.result == 'success' && '✅ Passed' || '❌ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| GL10 | ${{ needs.gl10-validate.result == 'success' && '✅ Passed' || (needs.gl10-validate.result == 'skipped' && '⏭️ Skipped' || '❌ Failed') }} |" >> $GITHUB_STEP_SUMMARY
          echo "| GL10 Semantic | ${{ needs.gl10-semantic-validate.result == 'success' && '✅ Passed' || (needs.gl10-semantic-validate.result == 'skipped' && '⏭️ Skipped' || '❌ Failed') }} |" >> $GITHUB_STEP_SUMMARY
          echo "| GL10 Top10 | ${{ needs.gl10-top10-validate.result == 'success' && '✅ Passed' || (needs.gl10-top10-validate.result == 'skipped' && '⏭️ Skipped' || '❌ Failed') }} |" >> $GITHUB_STEP_SUMMARY
          
      - name: Fail if any validation failed
        if: contains(needs.*.result, 'failure')
        run: |
          echo "❌ One or more GL validations failed"
          exit 1