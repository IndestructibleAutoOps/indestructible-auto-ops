name: "[L1-Security] Secret Scanning (Gitleaks)"

# @GL-governed
# @GL-layer: GL10-29
# @GL-semantic: gitleaks-secret-scan
# @GL-audit-trail: ../../governance/GL_SEMANTIC_ANCHOR.json

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    types: [opened, synchronize, reopened]
  schedule:
    - cron: "0 4 * * *"  # Daily at 4 AM UTC
  workflow_dispatch:

permissions:
  contents: read
  security-events: write
  pull-requests: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  gitleaks-scan:
    name: Run Gitleaks Secret Scan
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@8ade135a41bc03ea155e62e844d188df1ea18608
        with:
          fetch-depth: 0

      - name: Run Gitleaks
        id: gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_LICENSE: ${{ secrets.GITLEAKS_LICENSE }}
        with:
          report-path: gitleaks-report.json
          format: json
          config-path: .config/gitleaks/gitleaks.toml

      - name: Parse Gitleaks results
        id: parse
        run: |
          if [ -f gitleaks-report.json ]; then
            TOTAL_SECRETS=$(jq '. | length' gitleaks-report.json 2>/dev/null || echo 0)
            echo "total_secrets=$TOTAL_SECRETS" >> $GITHUB_OUTPUT
            
            # Count by severity
            CRITICAL=$(jq '[.[] | select(.severity | ascii_downcase == "critical")] | length' gitleaks-report.json 2>/dev/null || echo 0)
            HIGH=$(jq '[.[] | select(.severity | ascii_downcase == "high")] | length' gitleaks-report.json 2>/dev/null || echo 0)
            MEDIUM=$(jq '[.[] | select(.severity | ascii_downcase == "medium")] | length' gitleaks-report.json 2>/dev/null || echo 0)
            LOW=$(jq '[.[] | select(.severity | ascii_downcase == "low")] | length' gitleaks-report.json 2>/dev/null || echo 0)
            
            echo "critical=$CRITICAL" >> $GITHUB_OUTPUT
            echo "high=$HIGH" >> $GITHUB_OUTPUT
            echo "medium=$MEDIUM" >> $GITHUB_OUTPUT
            echo "low=$LOW" >> $GITHUB_OUTPUT
          else
            echo "total_secrets=0" >> $GITHUB_OUTPUT
          fi

      - name: Upload Gitleaks artifacts
        if: always()
        uses: actions/upload-artifact@v3.1.2
        with:
          name: gitleaks-results-${{ github.sha }}
          path: |
            gitleaks-report.json
          retention-days: 30

      - name: Upload results to GitHub Security
        if: github.event_name == 'pull_request'
        uses: github/codeql-action/upload-sarif@v2.14.4
        with:
          sarif_file: gitleaks-report.json
          category: gitleaks

      - name: Comment PR with results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7.0.1
        with:
          script: |
            const total = ${{ steps.parse.outputs.total_secrets }};
            const critical = ${{ steps.parse.outputs.critical }};
            const high = ${{ steps.parse.outputs.high }};
            const medium = ${{ steps.parse.outputs.medium }};
            
            let comment = `## ğŸ” Gitleaks Secret Scan Results\n\n`;
            comment += `| Severity | Count |\n`;
            comment += `|----------|-------|\n`;
            comment += `| ğŸ”´ Critical | ${critical} |\n`;
            comment += `| ğŸŸ  High | ${high} |\n`;
            comment += `| ğŸŸ¡ Medium | ${medium} |\n\n`;
            
            if (total > 0) {
              comment += `### âš ï¸ Secrets Detected\n\n`;
              comment += `Found ${total} potential secret(s) in the codebase.\n\n`;
              comment += `### ğŸ›¡ï¸ Security Recommendations\n\n`;
              comment += `- Remove any hardcoded secrets from the code\n`;
              comment += `- Use environment variables or secret management tools\n`;
              comment += `- Rotate any exposed credentials immediately\n\n`;
              comment += `This PR will be blocked until all secrets are removed.\n`;
            } else {
              comment += `### âœ… No Secrets Detected\n\n`;
              comment += `No hardcoded secrets found in the codebase.\n\n`;
            }
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      - name: Fail if secrets detected
        if: steps.parse.outputs.total_secrets > '0'
        run: |
          echo "âŒ Secrets detected in the codebase"
          echo "Please remove all hardcoded secrets before merging"
          exit 1