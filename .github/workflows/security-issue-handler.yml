name: üîí Security Issue Handler

on:
  issues:
    types: [opened, labeled]

permissions:
  contents: read
  issues: write
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ============================================
  # Handle security issues with high priority
  # ============================================
  security-triage:
    name: Security Issue Triage
    runs-on: ubuntu-latest
    if: |
      contains(github.event.issue.labels.*.name, 'type:security') ||
      contains(github.event.issue.title, '[Security]') ||
      contains(github.event.issue.title, 'security') ||
      contains(github.event.issue.title, 'vulnerability') ||
      contains(github.event.issue.title, 'CVE')

    steps:
      - name: Apply security labels and priority
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;
            const labels = issue.labels.map(l => l.name);

            const labelsToAdd = [];

            // Ensure security label
            if (!labels.includes('type:security')) {
              labelsToAdd.push('type:security');
            }

            // Ensure critical priority
            if (!labels.includes('priority:critical')) {
              labelsToAdd.push('priority:critical');
            }

            // Add GL compliance label
            if (!labels.includes('gl:compliance')) {
              labelsToAdd.push('gl:compliance');
            }

            if (labelsToAdd.length > 0) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                labels: labelsToAdd
              });
            }

      - name: Add security notice comment
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;

            // Check if we already commented (use pagination to avoid missing older comments)
            // Note: Pagination is sufficient here as this workflow runs once per label event,
            // minimizing the risk of missing comments due to concurrent additions
            const comments = await github.paginate(
              github.rest.issues.listComments,
              {
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                per_page: 100,
              }
            );

            const alreadyNotified = comments.some(c =>
              c.body && c.body.includes('üîí Security Issue Detected')
            );

            if (!alreadyNotified) {
              const securityMessage = [
                '## üîí Security Issue Detected',
                '',
                'This issue has been flagged as a **security concern** and has been automatically escalated.',
                '',
                '### Priority: üî¥ CRITICAL',
                '',
                '### Actions Taken:',
                '- ‚úÖ Applied `type:security` label',
                '- ‚úÖ Applied `priority:critical` label',
                '- ‚úÖ Applied `gl:compliance` label',
                '- ‚è≥ Awaiting security team review',
                '',
                '### Security Guidelines:',
                '1. **Do not** share sensitive details publicly',
                '2. **Do not** include credentials, tokens, or keys',
                '3. For critical vulnerabilities, consider using [private security advisories](https://github.com/MachineNativeOps/machine-native-ops/security/advisories/new)',
                '',
                '### Response SLA:',
                '| Severity | Response Time | Resolution Time |',
                '|----------|---------------|-----------------|',
                '| Critical | 4 hours | 24 hours |',
                '| High | 24 hours | 72 hours |',
                '| Medium | 72 hours | 1 week |',
                '',
                '**GL Unified Charter Activated** üèõÔ∏è',
                '',
                '---',
                '*This is an automated security triage message.*'
              ].join('\n');

              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                body: securityMessage
              });
            }

      - name: Create security tracking issue (internal)
        uses: actions/github-script@v7
        with:
          script: |
            // This would typically create an internal tracking issue
            // or notify a security channel
            console.log(`Security issue #${context.payload.issue.number} has been triaged`);
            console.log('In production, this would notify the security team via:');
            console.log('- Slack webhook');
            console.log('- Email notification');
            console.log('- Internal tracking system');
