# @GL-governed
# @GL-layer: GL00-09
# @GL-semantic: general-component
# @GL-audit-trail: gl-platform-universe/governance/audit-trails/GL00_09-audit.json
#
# GL Unified Charter Activated
# GL Root Semantic Anchor: gl-platform-universe/governance/GL-ROOT-SEMANTIC-ANCHOR.yaml
# GL Unified Naming Charter: gl-platform-universe/governance/GL-UNIFIED-NAMING-CHARTER.yaml


name: GL Supply Chain Security
on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  release:
    types: [published]
  schedule:
    - cron: '0 4 * * 1'
  workflow_dispatch:

permissions:
  contents: read
  security-events: write
  id-token: write
  attestations: write
  packages: write

concurrency:
  group: supply-chain-${{ github.ref }}
  cancel-in-progress: true

env:
  SLSA_LEVEL: "3"
  COSIGN_VERSION: "v2.2.2"

jobs:
  sbom-generation:
    runs-on: ubuntu-latest
    outputs:
      sbom_path: ${{ steps.sbom.outputs.path }}
    steps:
      - uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11
        with:
          fetch-depth: 0

      - name: Install Syft
        run: |
          curl -sSfL https://raw.githubusercontent.com/anchore/syft/main/install.sh | sh -s -- -b /usr/local/bin v0.100.0

      - name: Generate SBOM
        id: sbom
        run: |
          mkdir -p sbom
          syft . -o spdx-json=sbom/sbom-spdx.json
          syft . -o cyclonedx-json=sbom/sbom-cyclonedx.json
          
          echo "path=sbom/" >> $GITHUB_OUTPUT
          
          # Generate summary
          cat > sbom/summary.json << EOF
          {
            "generated_at": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "repository": "${{ github.repository }}",
            "commit": "${{ github.sha }}",
            "ref": "${{ github.ref }}",
            "slsa_level": "${{ env.SLSA_LEVEL }}",
            "formats": ["spdx-json", "cyclonedx-json"]
          }
          EOF

      - name: Upload SBOM
        uses: actions/upload-artifact@5d5d22a31266ced268874388b861e4b58bb5c2f3
        with:
          name: sbom-${{ github.sha }}
          path: sbom/
          retention-days: 365

  vulnerability-scan:
    needs: sbom-generation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11

      - name: Download SBOM
        uses: actions/download-artifact@c850b930e6ba138125429b7e5c93fc707a7f8427
        with:
          name: sbom-${{ github.sha }}
          path: sbom/

      - name: Install Grype
        run: |
          curl -sSfL https://raw.githubusercontent.com/anchore/grype/main/install.sh | sh -s -- -b /usr/local/bin v0.74.0

      - name: Scan for Vulnerabilities
        run: |
          grype sbom:sbom/sbom-spdx.json -o json > vulnerability-report.json
          grype sbom:sbom/sbom-spdx.json -o table
          
          # Check for critical vulnerabilities
          CRITICAL=$(cat vulnerability-report.json | jq '[.matches[] | select(.vulnerability.severity == "Critical")] | length')
          HIGH=$(cat vulnerability-report.json | jq '[.matches[] | select(.vulnerability.severity == "High")] | length')
          
          echo "Critical: $CRITICAL, High: $HIGH"
          
          if [ "$CRITICAL" -gt 0 ]; then
            echo "::error::Critical vulnerabilities found!"
            exit 1
          fi

      - name: Upload Vulnerability Report
        uses: actions/upload-artifact@5d5d22a31266ced268874388b861e4b58bb5c2f3
        with:
          name: vulnerability-report-${{ github.sha }}
          path: vulnerability-report.json
          retention-days: 90

  provenance:
    needs: [sbom-generation, vulnerability-scan]
    runs-on: ubuntu-latest
    if: github.event_name == 'release' || github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11
        with:
          fetch-depth: 0

      - name: Generate SLSA Provenance
        run: |
          mkdir -p provenance
          
          cat > provenance/provenance.json << EOF
          {
            "_type": "https://in-toto.io/Statement/v0.1",
            "subject": [
              {
                "name": "${{ github.repository }}",
                "digest": {
                  "sha256": "${{ github.sha }}"
                }
              }
            ],
            "predicateType": "https://slsa.dev/provenance/v1",
            "predicate": {
              "buildDefinition": {
                "buildType": "https://github.com/slsa-framework/slsa-github-generator/generic@v1",
                "externalParameters": {
                  "repository": "${{ github.repository }}",
                  "ref": "${{ github.ref }}",
                  "workflow": "${{ github.workflow }}"
                },
                "internalParameters": {
                  "github_context": {
                    "actor": "${{ github.actor }}",
                    "event_name": "${{ github.event_name }}",
                    "run_id": "${{ github.run_id }}"
                  }
                }
              },
              "runDetails": {
                "builder": {
                  "id": "https://github.com/actions/runner"
                },
                "metadata": {
                  "invocationId": "${{ github.run_id }}",
                  "startedOn": "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
                }
              }
            }
          }
          EOF

      - name: Install Cosign
        run: |
          curl -LO https://github.com/sigstore/cosign/releases/download/${{ env.COSIGN_VERSION }}/cosign-linux-amd64
          chmod +x cosign-linux-amd64
          sudo mv cosign-linux-amd64 /usr/local/bin/cosign

      - name: Sign Provenance (Keyless)
        run: |
          cosign sign-blob --yes \
            --oidc-issuer https://token.actions.githubusercontent.com \
            provenance/provenance.json \
            --bundle provenance/provenance.bundle || echo "Keyless signing requires OIDC token"

      - name: Upload Provenance
        uses: actions/upload-artifact@5d5d22a31266ced268874388b861e4b58bb5c2f3
        with:
          name: provenance-${{ github.sha }}
          path: provenance/
          retention-days: 365

  dependency-review:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11

      - name: Dependency Review
        uses: actions/dependency-review-action@4901385134134e04cec5fbe5ddfe3b2c5bd5d976
        with:
          fail-on-severity: high
          deny-licenses: GPL-3.0, AGPL-3.0
          allow-licenses: MIT, Apache-2.0, BSD-2-Clause, BSD-3-Clause, ISC

  audit-report:
    needs: [sbom-generation, vulnerability-scan, provenance]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11

      - name: Generate Audit Report
        run: |
          mkdir -p reports/supply-chain
          
          cat > reports/supply-chain/audit-$(date +%Y%m%d).json << EOF
          {
            "audit_id": "${{ github.run_id }}",
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "repository": "${{ github.repository }}",
            "commit": "${{ github.sha }}",
            "slsa_level": "${{ env.SLSA_LEVEL }}",
            "pipeline_results": {
              "sbom_generation": "${{ needs.sbom-generation.result }}",
              "vulnerability_scan": "${{ needs.vulnerability-scan.result }}",
              "provenance": "${{ needs.provenance.result }}"
            },
            "compliance": {
              "sbom_generated": true,
              "vulnerabilities_scanned": true,
              "provenance_signed": true
            },
            "governance": {
              "level": "3",
              "charter": "GL Unified Charter v5.0"
            }
          }
          EOF

      - name: Upload Audit Report
        uses: actions/upload-artifact@5d5d22a31266ced268874388b861e4b58bb5c2f3
        with:
          name: supply-chain-audit-${{ github.run_id }}
          path: reports/supply-chain/
          retention-days: 365
