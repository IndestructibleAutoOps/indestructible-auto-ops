# GL Unified Charter Activated
# Self-Hosted Runner Health Check and Management
name: GL-Runner-Health

on:
  schedule:
    - cron: '*/15 * * * *'  # Every 15 minutes
  workflow_dispatch:
    inputs:
      check_type:
        description: 'Type of health check'
        required: false
        default: 'full'
        type: choice
        options:
          - quick
          - full
          - deep

env:
  HEALTH_THRESHOLD_CPU: 80
  HEALTH_THRESHOLD_MEMORY: 85
  HEALTH_THRESHOLD_DISK: 90

permissions:
  contents: read
  actions: read
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ============================================
  # Staging Runner Health
  # ============================================
  staging-runner-health:
    name: ðŸ¥ Staging Runner Health
    runs-on: self-hosted
    continue-on-error: true
    outputs:
      status: ${{ steps.health.outputs.status }}
      cpu_usage: ${{ steps.metrics.outputs.cpu }}
      memory_usage: ${{ steps.metrics.outputs.memory }}
      disk_usage: ${{ steps.metrics.outputs.disk }}
    steps:
      - name: ðŸ“Š Collect system metrics
        id: metrics
        run: |
          # CPU Usage
          CPU=$(top -bn1 | grep "Cpu(s)" | awk '{print $2}' | cut -d'%' -f1 || echo "0")
          echo "cpu=${CPU}" >> $GITHUB_OUTPUT
          
          # Memory Usage
          MEMORY=$(free | grep Mem | awk '{print ($3/$2) * 100}' || echo "0")
          echo "memory=${MEMORY}" >> $GITHUB_OUTPUT
          
          # Disk Usage
          DISK=$(df -h / | tail -1 | awk '{print $5}' | tr -d '%' || echo "0")
          echo "disk=${DISK}" >> $GITHUB_OUTPUT
          
          echo "## ðŸ“Š Staging Runner Metrics" >> $GITHUB_STEP_SUMMARY
          echo "- **CPU:** ${CPU}%" >> $GITHUB_STEP_SUMMARY
          echo "- **Memory:** ${MEMORY}%" >> $GITHUB_STEP_SUMMARY
          echo "- **Disk:** ${DISK}%" >> $GITHUB_STEP_SUMMARY

      - name: ðŸ” Check Docker health
        run: |
          echo "Checking Docker..."
          docker info > /dev/null 2>&1 && echo "âœ… Docker is running" || echo "âŒ Docker not available"
          
          # List running containers
          docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}" || true
          
          # Check Docker disk usage
          docker system df || true

      - name: ðŸ” Check Node.js
        run: |
          echo "Checking Node.js..."
          node --version && echo "âœ… Node.js available" || echo "âŒ Node.js not available"
          npm --version && echo "âœ… npm available" || echo "âŒ npm not available"

      - name: ðŸ” Check PM2 processes
        run: |
          echo "Checking PM2..."
          pm2 list || echo "PM2 not running or not installed"

      - name: ðŸ” Check network connectivity
        run: |
          echo "Checking network..."
          ping -c 1 github.com > /dev/null 2>&1 && echo "âœ… GitHub reachable" || echo "âŒ GitHub unreachable"
          ping -c 1 registry.npmjs.org > /dev/null 2>&1 && echo "âœ… npm registry reachable" || echo "âŒ npm registry unreachable"

      - name: âœ… Health status
        id: health
        run: |
          CPU="${{ steps.metrics.outputs.cpu }}"
          MEMORY="${{ steps.metrics.outputs.memory }}"
          DISK="${{ steps.metrics.outputs.disk }}"
          
          STATUS="healthy"
          
          if (( $(echo "${CPU} > ${{ env.HEALTH_THRESHOLD_CPU }}" | bc -l) )); then
            echo "âš ï¸ High CPU usage: ${CPU}%"
            STATUS="warning"
          fi
          
          if (( $(echo "${MEMORY} > ${{ env.HEALTH_THRESHOLD_MEMORY }}" | bc -l) )); then
            echo "âš ï¸ High memory usage: ${MEMORY}%"
            STATUS="warning"
          fi
          
          if (( $(echo "${DISK} > ${{ env.HEALTH_THRESHOLD_DISK }}" | bc -l) )); then
            echo "âš ï¸ High disk usage: ${DISK}%"
            STATUS="critical"
          fi
          
          echo "status=${STATUS}" >> $GITHUB_OUTPUT
          echo "**Health Status:** ${STATUS}" >> $GITHUB_STEP_SUMMARY

  # ============================================
  # Production Runner Health
  # ============================================
  production-runner-health:
    name: ðŸ¥ Production Runner Health
    runs-on: self-hosted
    continue-on-error: true
    outputs:
      status: ${{ steps.health.outputs.status }}
      cpu_usage: ${{ steps.metrics.outputs.cpu }}
      memory_usage: ${{ steps.metrics.outputs.memory }}
      disk_usage: ${{ steps.metrics.outputs.disk }}
    steps:
      - name: ðŸ“Š Collect system metrics
        id: metrics
        run: |
          # CPU Usage
          CPU=$(top -bn1 | grep "Cpu(s)" | awk '{print $2}' | cut -d'%' -f1 || echo "0")
          echo "cpu=${CPU}" >> $GITHUB_OUTPUT
          
          # Memory Usage
          MEMORY=$(free | grep Mem | awk '{print ($3/$2) * 100}' || echo "0")
          echo "memory=${MEMORY}" >> $GITHUB_OUTPUT
          
          # Disk Usage
          DISK=$(df -h / | tail -1 | awk '{print $5}' | tr -d '%' || echo "0")
          echo "disk=${DISK}" >> $GITHUB_OUTPUT
          
          echo "## ðŸ“Š Production Runner Metrics" >> $GITHUB_STEP_SUMMARY
          echo "- **CPU:** ${CPU}%" >> $GITHUB_STEP_SUMMARY
          echo "- **Memory:** ${MEMORY}%" >> $GITHUB_STEP_SUMMARY
          echo "- **Disk:** ${DISK}%" >> $GITHUB_STEP_SUMMARY

      - name: ðŸ” Check Docker health
        run: |
          echo "Checking Docker..."
          docker info > /dev/null 2>&1 && echo "âœ… Docker is running" || echo "âŒ Docker not available"
          docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}" || true

      - name: ðŸ” Check application services
        run: |
          echo "Checking application services..."
          
          # Check blue environment
          curl -sf http://localhost:3001/health > /dev/null 2>&1 && echo "âœ… Blue environment healthy" || echo "âš ï¸ Blue environment not responding"
          
          # Check green environment
          curl -sf http://localhost:3002/health > /dev/null 2>&1 && echo "âœ… Green environment healthy" || echo "âš ï¸ Green environment not responding"

      - name: ðŸ” Check load balancer
        run: |
          echo "Checking load balancer..."
          # Check nginx/haproxy status
          systemctl status nginx > /dev/null 2>&1 && echo "âœ… Nginx running" || echo "âš ï¸ Nginx not running"
          systemctl status haproxy > /dev/null 2>&1 && echo "âœ… HAProxy running" || echo "âš ï¸ HAProxy not running"

      - name: ðŸ” Deep health check
        if: github.event.inputs.check_type == 'deep'
        run: |
          echo "Running deep health check..."
          
          # Check SSL certificates
          echo "Checking SSL certificates..."
          
          # Check database connectivity
          echo "Checking database connectivity..."
          
          # Check Redis connectivity
          echo "Checking Redis connectivity..."
          
          # Check external service dependencies
          echo "Checking external dependencies..."

      - name: âœ… Health status
        id: health
        run: |
          CPU="${{ steps.metrics.outputs.cpu }}"
          MEMORY="${{ steps.metrics.outputs.memory }}"
          DISK="${{ steps.metrics.outputs.disk }}"
          
          STATUS="healthy"
          
          if (( $(echo "${CPU} > ${{ env.HEALTH_THRESHOLD_CPU }}" | bc -l) )); then
            STATUS="warning"
          fi
          
          if (( $(echo "${MEMORY} > ${{ env.HEALTH_THRESHOLD_MEMORY }}" | bc -l) )); then
            STATUS="warning"
          fi
          
          if (( $(echo "${DISK} > ${{ env.HEALTH_THRESHOLD_DISK }}" | bc -l) )); then
            STATUS="critical"
          fi
          
          echo "status=${STATUS}" >> $GITHUB_OUTPUT
          echo "**Health Status:** ${STATUS}" >> $GITHUB_STEP_SUMMARY

  # ============================================
  # Health Report
  # ============================================
  health-report:
    name: ðŸ“‹ Health Report
    runs-on: ubuntu-latest
    needs: [staging-runner-health, production-runner-health]
    if: always()
    steps:
      - name: ðŸ“‹ Generate health report
        run: |
          cat > runner-health-report.json << EOF
          {
            "timestamp": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")",
            "workflow_run_id": "${{ github.run_id }}",
            "runners": {
              "staging": {
                "status": "${{ needs.staging-runner-health.outputs.status }}",
                "metrics": {
                  "cpu": "${{ needs.staging-runner-health.outputs.cpu_usage }}",
                  "memory": "${{ needs.staging-runner-health.outputs.memory_usage }}",
                  "disk": "${{ needs.staging-runner-health.outputs.disk_usage }}"
                },
                "job_result": "${{ needs.staging-runner-health.result }}"
              },
              "production": {
                "status": "${{ needs.production-runner-health.outputs.status }}",
                "metrics": {
                  "cpu": "${{ needs.production-runner-health.outputs.cpu_usage }}",
                  "memory": "${{ needs.production-runner-health.outputs.memory_usage }}",
                  "disk": "${{ needs.production-runner-health.outputs.disk_usage }}"
                },
                "job_result": "${{ needs.production-runner-health.result }}"
              }
            },
            "gl_charter": "activated"
          }
          EOF
          
          cat runner-health-report.json

      - name: ðŸ“Š Health Summary
        run: |
          echo "## ðŸ¥ Runner Health Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Runner | Status | CPU | Memory | Disk |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|--------|-----|--------|------|" >> $GITHUB_STEP_SUMMARY
          
          # Staging runner metrics
          STG_STATUS="${{ needs.staging-runner-health.outputs.status || 'offline' }}"
          STG_CPU="${{ needs.staging-runner-health.outputs.cpu_usage || 'N/A' }}"
          STG_MEM="${{ needs.staging-runner-health.outputs.memory_usage || 'N/A' }}"
          STG_DISK="${{ needs.staging-runner-health.outputs.disk_usage || 'N/A' }}"
          echo "| Staging | ${STG_STATUS} | ${STG_CPU}% | ${STG_MEM}% | ${STG_DISK}% |" >> $GITHUB_STEP_SUMMARY
          
          # Production runner metrics
          PRD_STATUS="${{ needs.production-runner-health.outputs.status || 'offline' }}"
          PRD_CPU="${{ needs.production-runner-health.outputs.cpu_usage || 'N/A' }}"
          PRD_MEM="${{ needs.production-runner-health.outputs.memory_usage || 'N/A' }}"
          PRD_DISK="${{ needs.production-runner-health.outputs.disk_usage || 'N/A' }}"
          echo "| Production | ${PRD_STATUS} | ${PRD_CPU}% | ${PRD_MEM}% | ${PRD_DISK}% |" >> $GITHUB_STEP_SUMMARY

      - name: ðŸš¨ Alert on critical status
        if: needs.staging-runner-health.outputs.status == 'critical' || needs.production-runner-health.outputs.status == 'critical'
        run: |
          echo "## ðŸš¨ CRITICAL ALERT" >> $GITHUB_STEP_SUMMARY
          echo "One or more runners are in critical status!" >> $GITHUB_STEP_SUMMARY
          echo "Immediate attention required." >> $GITHUB_STEP_SUMMARY

      - name: ðŸ“¤ Upload health report
        uses: actions/upload-artifact@v4
        with:
          name: runner-health-report
          path: runner-health-report.json
          retention-days: 30