# @GL-governed
# @GL-layer: CI/CD
# @GL-semantic: workflow-validation
# @GL-audit-trail: ../../engine/governance/GL_SEMANTIC_ANCHOR.json
#
# GL Unified Charter Activated
# GL Unified Charter Activated
# Multi-Agent Parallel Processing Workflow
# GL Layer: GL90-99 (Meta-Specification)

name: Multi-Agent Parallel Processing

permissions:
  contents: read
  actions: read
  security-events: write
  pull-requests: write

on:
  push:
    branches: [main, develop, 'feature/**', 'fix/**']
  pull_request:
    branches: [main, develop]
  workflow_dispatch:
    inputs:
      agents:
        description: 'Specific agents to run (comma-separated, or "all")'
        required: false
        default: 'all'
      timeout_minutes:
        description: 'Maximum execution time in minutes'
        required: false
        default: '30'

env:
  PYTHON_VERSION: '3.11'
  ORCHESTRATION_CONFIG: '.github/agents/agent-orchestration.yml'
  WORKSPACE_DIR: '.'
  REPORT_DIR: 'reports/orchestration'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ==========================================================================
  # Job 1: Configuration Validation
  # ==========================================================================
  validate-config:
    name: Validate Configuration
    runs-on: ubuntu-latest
    outputs:
      config_valid: ${{ steps.validate.outputs.valid }}
      
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v6
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install --quiet --upgrade pip
          pip install pyyaml jsonschema

      - name: Validate agent configuration
        id: validate
        run: |
          python3 << 'EOF'
          import yaml
          import sys
          from pathlib import Path

          config_path = Path('${{ env.ORCHESTRATION_CONFIG }}')
          
          if not config_path.exists():
              print(f"‚ùå Configuration file not found: {config_path}")
              sys.exit(1)
          
          with open(config_path, 'r') as f:
              config = yaml.safe_load(f)
          
          # Validate structure
          required_fields = ['apiVersion', 'kind', 'metadata', 'spec']
          for field in required_fields:
              if field not in config:
                  print(f"‚ùå Missing required field: {field}")
                  sys.exit(1)
          
          # Validate agents
          agents = config['spec'].get('agents', [])
          if not agents:
              print("‚ùå No agents defined in configuration")
              sys.exit(1)
          
          agent_ids = set()
          for agent in agents:
              agent_id = agent.get('id')
              if not agent_id:
                  print("‚ùå Agent missing 'id' field")
                  sys.exit(1)
              
              if agent_id in agent_ids:
                  print(f"‚ùå Duplicate agent ID: {agent_id}")
                  sys.exit(1)
              
              agent_ids.add(agent_id)
              
              # Validate dependencies
              deps = agent.get('dependencies', [])
              for dep in deps:
                  if dep not in [a['id'] for a in agents]:
                      print(f"‚ùå Invalid dependency '{dep}' for agent '{agent_id}'")
                      sys.exit(1)
          
          print(f"‚úÖ Configuration valid: {len(agents)} agents configured")
          print("valid=true" >> $GITHUB_OUTPUT)
          EOF

  # ==========================================================================
  # Job 2: Multi-Agent Execution
  # ==========================================================================
  run-agents:
    name: Run Agents in Parallel
    runs-on: ubuntu-latest
    needs: validate-config
    if: needs.validate-config.outputs.config_valid == 'true'
    timeout-minutes: ${{ github.event.inputs.timeout_minutes || 30 }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v6
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install --quiet --upgrade pip
          pip install pyyaml asyncio

      - name: Create reports directory
        run: |
          mkdir -p ${{ env.REPORT_DIR }}

      - name: Run multi-agent parallel processing
        id: run-agents
        run: |
          python3 .github/scripts/parallel-agent-runner.py \
            --config ${{ env.ORCHESTRATION_CONFIG }} \
            --workspace ${{ env.WORKSPACE_DIR }} \
            --output ${{ env.REPORT_DIR }}/execution-report.json

      - name: Upload orchestration report
        uses: actions/upload-artifact@v6
        if: always()
        with:
          name: orchestration-report
          path: |
            ${{ env.REPORT_DIR }}/*.json
            ${{ env.REPORT_DIR }}/*.md
          retention-days: 7
          if-no-files-found: warn

      - name: Generate summary
        if: always()
        run: |
          python3 << 'EOF'
          import json
          from pathlib import Path

          report_path = Path('${{ env.REPORT_DIR }}/execution-report.json')
          
          if report_path.exists():
              with open(report_path, 'r') as f:
                  report = json.load(f)
              
              summary = report.get('orchestration_summary', {})
              
              echo "## ü§ñ Multi-Agent Execution Summary" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
              echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
              echo f"| Total Agents | {summary.get('total_agents', 0)} |" >> $GITHUB_STEP_SUMMARY
              echo f"| Completed | ‚úÖ {summary.get('completed', 0)} |" >> $GITHUB_STEP_SUMMARY
              echo f"| Failed | ‚ùå {summary.get('failed', 0)} |" >> $GITHUB_STEP_SUMMARY
              echo f"| Skipped | ‚è≠Ô∏è {summary.get('skipped', 0)} |" >> $GITHUB_STEP_SUMMARY
              echo f"| Duration | {summary.get('duration_seconds', 0):.2f}s |" >> $GITHUB_STEP_SUMMARY
              
              if summary.get('failed', 0) > 0:
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "### ‚ùå Failed Agents" >> $GITHUB_STEP_SUMMARY
                  for result in report.get('agent_results', []):
                      if result.get('status') == 'failed':
                          echo f"- **{result['agent_id']}**: {result.get('error', 'Unknown error')}" >> $GITHUB_STEP_SUMMARY
          EOF

  # ==========================================================================
  # Job 3: Quality Verification
  # ==========================================================================
  verify-quality:
    name: Verify Quality
    runs-on: ubuntu-latest
    needs: run-agents
    if: always()
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Download reports
        uses: actions/download-artifact@v4
        with:
          name: orchestration-report
          path: ${{ env.REPORT_DIR }}

      - name: Verify results quality
        run: |
          python3 << 'EOF'
          import json
          import sys
          from pathlib import Path

          report_path = Path('${{ env.REPORT_DIR }}/execution-report.json')
          
          if not report_path.exists():
              print("‚ùå No execution report found")
              sys.exit(1)
          
          with open(report_path, 'r') as f:
              report = json.load(f)
          
          summary = report.get('orchestration_summary', {})
          
          # Check if all agents completed successfully
          if summary.get('failed', 0) > 0:
              print(f"‚ùå {summary['failed']} agent(s) failed")
              sys.exit(1)
          
          if summary.get('completed', 0) == 0:
              print("‚ùå No agents completed successfully")
              sys.exit(1)
          
          print(f"‚úÖ All agents completed successfully")
          print(f"‚úÖ Total execution time: {summary['duration_seconds']:.2f}s")
          EOF

      - name: Comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const reportPath = '${{ env.REPORT_DIR }}/execution-report.json';
            
            if (fs.existsSync(reportPath)) {
              const report = JSON.parse(fs.readFileSync(reportPath, 'utf8'));
              const summary = report.orchestration_summary;
              
              const comment = `## ü§ñ Multi-Agent Execution Results
              
              | Metric | Value |
              |--------|-------|
              | Total Agents | ${summary.total_agents} |
              | Completed | ‚úÖ ${summary.completed} |
              | Failed | ‚ùå ${summary.failed} |
              | Skipped | ‚è≠Ô∏è ${summary.skipped} |
              | Duration | ${summary.duration_seconds.toFixed(2)}s |
              
              Status: ${report.status === 'success' ? '‚úÖ Success' : '‚ö†Ô∏è Partial Failure'}
              `;
              
              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });
            }