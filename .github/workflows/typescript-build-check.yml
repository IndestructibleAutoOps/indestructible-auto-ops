# @GL-governed
# @GL-layer: CI/CD
# @GL-semantic: workflow-validation
# @GL-audit-trail: ../../engine/governance/GL_SEMANTIC_ANCHOR.json
#
# GL Unified Charter Activated
name: TypeScript Build Check

on:
  pull_request:
    types: [opened, synchronize, reopened]
  push:
    branches:
      - main
      - develop
    paths:
      - 'ns-root/namespaces-sdk/**'
      - '.github/workflows/typescript-build-check.yml'

# å–æ¶ˆåŒä¸€ PR çš„èˆŠ workflow runs
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  typescript-build:
    name: TypeScript Build Check
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 1

      - name: Set up Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: Check Node.js for vulnerabilities
        uses: nodejs/is-my-node-vulnerable@v1.6.1
        continue-on-error: false  # Don't fail the build on vulnerability check errors

      - name: Install dependencies
        working-directory: './ns-root/namespaces-sdk'
        run: |
          echo "ðŸ“¦ Installing dependencies..."
          
          # Install taxonomy-core first
          cd ../taxonomy-core
          if ! npm install --legacy-peer-deps; then
            echo "::error::Failed to install taxonomy-core dependencies"
            exit 1
          fi
          
          # Build and link taxonomy-core
          if ! npm run build; then
            echo "::error::Failed to build taxonomy-core"
            exit 1
          fi
          
          npm link
          
          # Install and link SDK dependencies
          cd ../namespaces-sdk
          npm link @machine-native-ops/taxonomy-core
          
          if ! npm install --legacy-peer-deps; then
            echo "::error::Failed to install namespaces-sdk dependencies"
            exit 1
          fi
          
          echo "âœ… All dependencies installed successfully"
          # Track installation status
          INSTALL_SUCCESS=true
          
          # Install and build taxonomy-core first
          echo "Installing taxonomy-core..."
          cd ../taxonomy-core
          if ! npm install --legacy-peer-deps; then
            echo "::error::taxonomy-core npm install failed"
            INSTALL_SUCCESS=false
          fi
          
          if ! npm run build; then
            echo "::error::taxonomy-core build failed"
            INSTALL_SUCCESS=false
          fi
          
          if ! npm link; then
            echo "::warning::taxonomy-core npm link failed (non-critical)"
          fi
          
          # Install SDK dependencies
          echo "Installing namespaces-sdk..."
          cd ../namespaces-sdk
          
          if ! npm link @machine-native-ops/taxonomy-core; then
            echo "::warning::Failed to link taxonomy-core (non-critical)"
          fi
          
          if ! npm install --legacy-peer-deps; then
            echo "::error::namespaces-sdk npm install failed"
            INSTALL_SUCCESS=false
          fi
          
          # Report final status
          if [ "$INSTALL_SUCCESS" = false ]; then
            echo "::warning::Some dependencies failed to install - build may fail"
          else
            echo "âœ… All dependencies installed successfully"
          fi

      - name: TypeScript compilation check
        id: typescript
        working-directory: './ns-root/namespaces-sdk'
        continue-on-error: false  # Non-blocking build - failures are warnings, not errors
        run: |
          # Use pipefail to ensure tee doesn't mask npm build failures
          set -o pipefail
          
          echo "ðŸ” Running TypeScript compilation check..."
          
          # Check if package.json exists
          if [ ! -f "package.json" ]; then
            echo "âš ï¸ package.json not found, skipping TypeScript build"
            echo "error_count=0" >> $GITHUB_OUTPUT
            echo "has_errors=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Check if src directory exists
          if [ ! -d "src" ]; then
            echo "âš ï¸ src directory not found, skipping TypeScript build"
            echo "error_count=0" >> $GITHUB_OUTPUT
            echo "has_errors=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Check if node_modules exists
          if [ ! -d "node_modules" ]; then
            echo "âš ï¸ node_modules not found, TypeScript build may fail"
          fi
          
          # Run TypeScript compiler if build script exists, capture output
          if npm run build --if-present > ts-build-output.txt 2>&1; then
          # Run TypeScript compiler and capture output
          # NOTE: Build failures are non-blocking due to continue-on-error above
          # This allows PRs to be merged even with TypeScript errors (warnings only)
          if npm run build --if-present 2>&1 | tee ts-build-output.txt; then
            echo "âœ… TypeScript compilation successful"
            echo "error_count=0" >> $GITHUB_OUTPUT
            echo "has_errors=false" >> $GITHUB_OUTPUT
          else
            BUILD_EXIT_CODE=$?
            
            # Parse errors from build output
            if [ -f "ts-build-output.txt" ]; then
              ERROR_COUNT=$(grep -c "^src/" ts-build-output.txt || echo "0")
            else
              ERROR_COUNT=0
            fi
            
            # Set outputs to reflect actual build failure
            echo "error_count=$ERROR_COUNT" >> $GITHUB_OUTPUT
            if [ "$ERROR_COUNT" -gt 0 ] || [ "$BUILD_EXIT_CODE" -ne 0 ]; then
              echo "has_errors=true" >> $GITHUB_OUTPUT
            else
              echo "has_errors=false" >> $GITHUB_OUTPUT
            fi
            
            # Set has_errors based on actual build outcome
            if [ "$ERROR_COUNT" -gt 0 ] || [ "$BUILD_EXIT_CODE" -ne 0 ]; then
              echo "has_errors=true" >> $GITHUB_OUTPUT
              echo "âŒ TypeScript build failed with $ERROR_COUNT errors"
              echo "::warning::TypeScript build failed but not blocking merge (continue-on-error: false)"
            else
              echo "has_errors=false" >> $GITHUB_OUTPUT
              echo "âœ… TypeScript compilation successful"
            fi
            echo "âš ï¸ TypeScript build failed with exit code $BUILD_EXIT_CODE"
            echo "::warning::TypeScript build failed with $ERROR_COUNT errors (non-blocking)"
          fi
          
          # Note: This step has continue-on-error: false, meaning TypeScript
          # compilation failures will NOT block the workflow or PR merges.
          # This is intentional to prevent CI from blocking on TypeScript errors
          # while still maintaining visibility through warnings and reports.

      - name: Generate summary
        if: always()
        run: |
          echo "## ðŸ” TypeScript Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          
          ERROR_COUNT=${{ steps.typescript.outputs.error_count }}
          HAS_ERRORS=${{ steps.typescript.outputs.has_errors }}
          
          # Handle empty or unset variables
          ERROR_COUNT=${ERROR_COUNT:-0}
          HAS_ERRORS=${HAS_ERRORS:-false}
          
          if [ "$HAS_ERRORS" == "true" ]; then
            echo "| TypeScript Build | âš ï¸ Failed (non-blocking) |" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ðŸ“Š Error Statistics" >> $GITHUB_STEP_SUMMARY
            echo "- **Total Errors:** $ERROR_COUNT" >> $GITHUB_STEP_SUMMARY
            echo "- **Status:** Non-blocking (warnings only)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âš ï¸ **Note:** TypeScript build failures are currently non-blocking." >> $GITHUB_STEP_SUMMARY
            echo "PRs can be merged even with TypeScript errors." >> $GITHUB_STEP_SUMMARY
          else
            echo "| TypeScript Build | âœ… Passed |" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ðŸŽ‰ Perfect Build" >> $GITHUB_STEP_SUMMARY
            echo "- **TypeScript Errors:** 0" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload TypeScript error log
        uses: actions/upload-artifact@v6
        if: always()
        with:
          name: typescript-build-errors
          path: ns-root/namespaces-sdk/ts-build-output.txt
          retention-days: 7
          if-no-files-found: ignore

      - name: Upload distribution files
        uses: actions/upload-artifact@v6
        if: success()
        with:
          name: typescript-dist
          path: ns-root/namespaces-sdk/dist/
          retention-days: 7
          if-no-files-found: ignore