name: "[L1-Security] CIS Benchmark Scan (kube-bench)"

# @GL-governed
# @GL-layer: GL10-29
# @GL-semantic: kube-bench-security-scan
# @GL-audit-trail: ../../governance/GL_SEMANTIC_ANCHOR.json

on:
  pull_request:
    paths:
      - "deploy/k8s/**"
      - "local/kind/**"
      - ".github/workflows/kube-bench-scan.yaml"
  push:
    branches:
      - main
      - develop
    paths:
      - "deploy/k8s/**"
      - "local/kind/**"
      - ".github/workflows/kube-bench-scan.yaml"
  schedule:
    - cron: "0 2 * * 1"  # Every Monday at 2 AM UTC
  workflow_dispatch:

permissions:
  contents: read
  security-events: write
  pull-requests: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  kube-bench-scan:
    name: Run kube-bench CIS Benchmark
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@8ade135a41bc03ea155e62e844d188df1ea18608 # v4.1.0

      - name: Install kind
        run: |
          curl -Lo ./kind https://kind.sigs.k8s.io/dl/v0.20.0/kind-linux-amd64
          chmod +x ./kind
          sudo mv ./kind /usr/local/bin/kind

      - name: Create kind cluster
        run: |
          kind create cluster --name kube-bench-cluster --config .config/kind/kube-bench-config.yaml
          kubectl cluster-info --context kind-kube-bench-cluster

      - name: Run kube-bench
        uses: aquasecurity/kube-bench-action@v0.1.0
        with:
          version: v0.8.0
          config: cis-1.23
          output-file: kube-bench-report.json

      - name: Parse kube-bench results
        id: parse
        run: |
          TOTAL_TESTS=$(jq '.tests | length' kube-bench-report.json)
          TOTAL_FAILS=$(jq '[.tests[].results[] | select(.status == "FAIL")] | length' kube-bench-report.json)
          TOTAL_PASSES=$(jq '[.tests[].results[] | select(.status == "PASS")] | length' kube-bench-report.json)
          TOTAL_WARNS=$(jq '[.tests[].results[] | select(.status == "WARN")] | length' kube-bench-report.json)
          
          echo "total_tests=$TOTAL_TESTS" >> $GITHUB_OUTPUT
          echo "total_fails=$TOTAL_FAILS" >> $GITHUB_OUTPUT
          echo "total_passes=$TOTAL_PASSES" >> $GITHUB_OUTPUT
          echo "total_warns=$TOTAL_WARNS" >> $GITHUB_OUTPUT
          
          echo "Total Tests: $TOTAL_TESTS"
          echo "Fails: $TOTAL_FAILS"
          echo "Passes: $TOTAL_PASSES"
          echo "Warns: $TOTAL_WARNS"

      - name: Upload kube-bench report
        if: always()
        uses: actions/upload-artifact@v3.1.2
        with:
          name: kube-bench-report-${{ github.sha }}
          path: |
            kube-bench-report.json
          retention-days: 30

      - name: Upload results to GitHub Security
        if: github.event_name == 'pull_request'
        uses: github/codeql-action/upload-sarif@v2.14.4
        with:
          sarif_file: kube-bench-report.json
          category: kube-bench

      - name: Comment PR with results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7.0.1
        with:
          script: |
            const fails = ${{ steps.parse.outputs.total_fails }};
            const passes = ${{ steps.parse.outputs.total_passes }};
            const total = ${{ steps.parse.outputs.total_tests }};
            
            let comment = `## üîí kube-bench CIS Benchmark Results\n\n`;
            comment += `| Metric | Count |\n`;
            comment += `|--------|-------|\n`;
            comment += `| Total Tests | ${total} |\n`;
            comment += `| ‚úÖ Passed | ${passes} |\n`;
            comment += `| ‚ùå Failed | ${fails} |\n\n`;
            
            const complianceRate = Math.round((passes / total) * 100);
            comment += `### Compliance Rate\n\n`;
            comment += `${complianceRate}%\n\n`;
            
            if (fails > 0) {
              comment += `### ‚ö†Ô∏è Issues Found\n\n`;
              comment += `Found ${fails} security issue(s) that need attention.\n\n`;
              comment += `Please review the full report in the workflow artifacts.\n\n`;
            } else {
              comment += `### ‚úÖ All Tests Passed\n\n`;
              comment += `No security issues detected.\n\n`;
            }
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      - name: Push metrics to Prometheus
        if: always()
        run: |
          FAILS=${{ steps.parse.outputs.total_fails }}
          PASSES=${{ steps.parse.outputs.total_passes }}
          TOTAL=${{ steps.parse.outputs.total_tests }}
          
          cat <<EOF | curl --data-binary @- http://${{ secrets.PROMETHEUS_PUSHGATEWAY }}/metrics/job/kube-bench/instance/${{ github.run_number }}
            # HELP kube_bench_fails_total Total number of failed kube-bench checks
            # TYPE kube_bench_fails_total gauge
            kube_bench_fails_total{repo="${{ github.repository }}"} $FAILS
            
            # HELP kube_bench_passes_total Total number of passed kube-bench checks
            # TYPE kube_bench_passes_total gauge
            kube_bench_passes_total{repo="${{ github.repository }}"} $PASSES
            
            # HELP kube_bench_compliance_rate Compliance rate for CIS benchmark
            # TYPE kube_bench_compliance_rate gauge
            kube_bench_compliance_rate{repo="${{ github.repository }}"} $(( (PASSES * 100) / TOTAL ))
          EOF

      - name: Check threshold
        if: steps.parse.outputs.total_fails > '5'
        run: |
          echo "‚ùå Too many failures detected (${{ steps.parse.outputs.total_fails }} > 5)"
          exit 1

      - name: Cleanup kind cluster
        if: always()
        run: |
          kind delete cluster --name kube-bench-cluster