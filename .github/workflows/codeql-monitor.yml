# GL Unified Charter Activated
# CodeQL Monitoring Workflow
# GL Layer: GL50-59 (Observability Layer)

name: CodeQL Monitoring

permissions:
  contents: read
  security-events: write
  actions: read

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  schedule:
    # Run daily at 00:00 UTC
    - cron: '0 0 * * *'
  workflow_dispatch:
    inputs:
      languages:
        description: 'Languages to analyze (comma-separated)'
        required: false
        default: 'javascript,python,typescript'
      enable_alerts:
        description: 'Enable security alerts'
        required: false
        default: 'true'
        type: boolean

env:
  CODEQL_VERSION: '2.19.0'
  PYTHON_VERSION: '3.11'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ==========================================================================
  # Job 1: Initialize CodeQL
  # ==========================================================================
  initialize:
    name: Initialize CodeQL
    runs-on: ubuntu-latest
    outputs:
      languages: ${{ steps.init.outputs.languages }}
      query-suite: ${{ steps.init.outputs.query-suite }}
      
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Initialize CodeQL
        id: init
        uses: github/codeql-action/init@v4
        with:
          languages: ${{ github.event.inputs.languages || 'javascript,python,typescript' }}
          queries: security-extended
          queries-cache: true
          cache: true

  # ==========================================================================
  # Job 2: Perform Analysis
  # ==========================================================================
  analyze:
    name: CodeQL Analysis
    runs-on: ubuntu-latest
    needs: initialize
    permissions:
      actions: read
      contents: read
      security-events: write
    strategy:
      fail-fast: false
      matrix:
        language: ${{ fromJSON(needs.initialize.outputs.languages) }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v6
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install Python dependencies
        if: matrix.language == 'python'
        run: |
          pip install --quiet --upgrade pip
          pip install -r requirements.txt || true

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v4
        with:
          languages: ${{ matrix.language }}
          queries: security-extended,security-quality-extended
          queries-cache: true
          cache: true

      - name: Autobuild
        uses: github/codeql-action/autobuild@v4

      - name: Perform CodeQL Analysis
        id: analyze
        uses: github/codeql-action/analyze@v4
        with:
          category: "/language:${{matrix.language}}"
          output: sarif-results/${{ matrix.language }}.sarif
          upload: false

      - name: Upload SARIF results
        uses: actions/upload-artifact@v4
        with:
          name: codeql-sarif-${{ matrix.language }}
          path: sarif-results/${{ matrix.language }}.sarif
          retention-days: 7

      - name: Parse SARIF results
        run: |
          python3 << 'EOF'
          import json
          import sys
          from pathlib import Path

          sarif_path = Path('sarif-results/${{ matrix.language }}.sarif')
          
          if not sarif_path.exists():
              print(f"‚ùå SARIF file not found: {sarif_path}")
              sys.exit(1)
          
          with open(sarif_path, 'r') as f:
              sarif = json.load(f)
          
          # Extract statistics
              runs = sarif.get('runs', [])
              if not runs:
                  print("No results found in SARIF file")
                  sys.exit(0)
          
          total_results = sum(len(run.get('results', [])) for run in runs)
          
          # Count by severity
          severity_counts = {}
          for run in runs:
              for result in run.get('results', []):
                  rule_id = result.get('ruleId', 'unknown')
                  severity = result.get('rule', {}).get('properties', {}).get('problem.severity', 'unknown')
                  severity_counts[severity] = severity_counts.get(severity, 0) + 1
          
          print(f"üìä CodeQL Analysis Results for ${{ matrix.language }}:")
          print(f"   Total findings: {total_results}")
          print(f"   By severity: {severity_counts}")
          
          # Save summary
          summary = {
              'language': '${{ matrix.language }}',
              'total_findings': total_results,
              'severity_counts': severity_counts,
              'timestamp': '${{ github.event.head_commit.timestamp }}'
          }
          
          summary_path = Path('codeql-summary-${{ matrix.language }}.json')
          with open(summary_path, 'w') as f:
              json.dump(summary, f, indent=2)
          
          print(f"‚úÖ Summary saved to {summary_path}")
          EOF

      - name: Upload summary
        uses: actions/upload-artifact@v4
        with:
          name: codeql-summary-${{ matrix.language }}
          path: codeql-summary-${{ matrix.language }}.json
          retention-days: 7

  # ==========================================================================
  # Job 3: Aggregation & Reporting
  # ==========================================================================
  report:
    name: Generate Report
    runs-on: ubuntu-latest
    needs: [initialize, analyze]
    if: always()
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Python
        uses: actions/setup-python@v6
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Download all summaries
        uses: actions/download-artifact@v4
        with:
          path: codeql-reports

      - name: Generate comprehensive report
        run: |
          python3 << 'EOF'
          import json
          from pathlib import Path
          from datetime import datetime

          reports_dir = Path('codeql-reports')
          if not reports_dir.exists():
              print("‚ùå No reports found")
              exit(1)
          
          # Aggregate all summaries
          summaries = []
          for summary_file in reports_dir.glob('codeql-summary-*.json'):
              with open(summary_file, 'r') as f:
                  summaries.append(json.load(f))
          
          # Generate report
          report = {
              'generated_at': datetime.utcnow().isoformat() + 'Z',
              'languages_analyzed': [s['language'] for s in summaries],
              'total_findings': sum(s['total_findings'] for s in summaries),
              'breakdown_by_language': {
                  s['language']: {
                      'total_findings': s['total_findings'],
                      'severity_counts': s['severity_counts']
                  } for s in summaries
              }
          }
          
          # Save report
          report_path = Path('codeql-comprehensive-report.json')
          with open(report_path, 'w') as f:
              json.dump(report, f, indent=2)
          
          print(f"‚úÖ Comprehensive report saved to {report_path}")
          print(f"   Languages analyzed: {', '.join(report['languages_analyzed'])}")
          print(f"   Total findings: {report['total_findings']}")
          EOF

      - name: Upload comprehensive report
        uses: actions/upload-artifact@v4
        with:
          name: codeql-comprehensive-report
          path: codeql-comprehensive-report.json
          retention-days: 7

      - name: Generate GitHub summary
        run: |
          python3 << 'EOF'
          import json
          from pathlib import Path

          report_path = Path('codeql-comprehensive-report.json')
          
          if report_path.exists():
              with open(report_path, 'r') as f:
                  report = json.load(f)
              
              echo "## üîç CodeQL Monitoring Report" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo f"| Metric | Value |" >> $GITHUB_STEP_SUMMARY
              echo f"|--------|-------|" >> $GITHUB_STEP_SUMMARY
              echo f"| Languages Analyzed | {', '.join(report['languages_analyzed'])} |" >> $GITHUB_STEP_SUMMARY
              echo f"| Total Findings | {report['total_findings']} |" >> $GITHUB_STEP_SUMMARY
              
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "### Breakdown by Language" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              
              for lang, data in report['breakdown_by_language'].items():
                  echo f"#### {lang}" >> $GITHUB_STEP_SUMMARY
                  echo f"- **Total Findings**: {data['total_findings']}" >> $GITHUB_STEP_SUMMARY
                  if data['severity_counts']:
                      echo "- **Severity Breakdown**:" >> $GITHUB_STEP_SUMMARY
                      for severity, count in data['severity_counts'].items():
                          echo f"  - {severity}: {count}" >> $GITHUB_STEP_SUMMARY
              EOF

      - name: Upload SARIF to GitHub Security
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: codeql-reports/codeql-sarif-*/**/*.sarif
          category: codeql-analysis
          wait-for-processing: true

      - name: Create issue for findings (if enabled)
        if: |
          github.event.inputs.enable_alerts == 'true' &&
          github.event_name == 'schedule'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const reportPath = 'codeql-comprehensive-report.json';
            
            if (fs.existsSync(reportPath)) {
              const report = JSON.parse(fs.readFileSync(reportPath, 'utf8'));
              
              if (report.total_findings > 0) {
                const issueTitle = `üîç CodeQL Monitoring Report - ${new Date().toISOString().split('T')[0]}`;
                const issueBody = `## CodeQL Monitoring Report
                
                **Generated**: ${report.generated_at}
                
                **Summary**:
                - Languages Analyzed: ${report.languages_analyzed.join(', ')}
                - Total Findings: ${report.total_findings}
                
                **Detailed Breakdown**:
                \`\`\`json
                ${JSON.stringify(report.breakdown_by_language, null, 2)}
                \`\`\`
                
                Review the full report in the workflow artifacts for detailed findings.
                `;
                
                // Check if issue already exists
                const issues = await github.rest.issues.list({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  state: 'open',
                  labels: ['codeql', 'monitoring']
                });
                
                if (issues.data.length === 0) {
                  await github.rest.issues.create({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    title: issueTitle,
                    body: issueBody,
                    labels: ['codeql', 'monitoring', 'security']
                  });
                }
              }
            }