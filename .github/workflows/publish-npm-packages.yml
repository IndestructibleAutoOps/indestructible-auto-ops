name: Publish to GitHub Packages

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      package:
        description: 'Package to publish (leave empty to publish all)'
        required: false
        type: string

permissions:
  contents: read
  packages: write
  id-token: write
  attestations: write
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  publish:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        package:
          - name: '@machinenativeops/mcp-servers'
            path: 'workspace/src/mcp-servers'
          - name: '@machinenativeops/advisory-database'
            path: 'workspace/src/core/advisory-database'
          - name: '@machine-native-ops/taxonomy-core'
            path: 'ns-root/taxonomy-core'
          - name: '@machine-native-ops/namespaces-mcp'
            path: 'ns-root/namespaces-mcp'
          - name: '@machine-native-ops/namespaces-sdk'
            path: 'ns-root/namespaces-sdk'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          registry-url: 'https://npm.pkg.github.com'

      - name: Check Node.js for vulnerabilities
        uses: nodejs/is-my-node-vulnerable@v1.6.1
        continue-on-error: true

      - name: Configure npm for GitHub Packages
        run: |
          echo "@machinenativeops:registry=https://npm.pkg.github.com" >> .npmrc
          echo "@machine-native-ops:registry=https://npm.pkg.github.com" >> .npmrc
          echo "//npm.pkg.github.com/:_authToken=${{ secrets.GITHUB_TOKEN }}" >> .npmrc

      - name: Install dependencies
        working-directory: ${{ matrix.package.path }}
        run: npm ci || npm install

      - name: Build package (if build script exists)
        working-directory: ${{ matrix.package.path }}
        run: npm run build --if-present

      - name: Run tests (if test script exists)
        working-directory: ${{ matrix.package.path }}
        run: npm test --if-present

      - name: Pack package
        id: pack
        working-directory: ${{ matrix.package.path }}
        run: |
          PACKAGE_FILE=$(npm pack)
          echo "package-file=$PACKAGE_FILE" >> $GITHUB_OUTPUT
          echo "package-path=${{ matrix.package.path }}/$PACKAGE_FILE" >> $GITHUB_OUTPUT

      - name: Attest Build Provenance
        uses: actions/attest-build-provenance@v3.2.0
        with:
          subject-path: ${{ steps.pack.outputs.package-path }}

      - name: Publish package
        working-directory: ${{ matrix.package.path }}
        run: npm publish ${{ steps.pack.outputs.package-file }}
        env:
          NODE_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Publish summary
        if: success()
        run: |
          echo "### âœ… Published ${{ matrix.package.name }}" >> $GITHUB_STEP_SUMMARY
          echo "Package published to GitHub Packages" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“¦ Package: ${{ matrix.package.name }}" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“ Path: ${{ matrix.package.path }}" >> $GITHUB_STEP_SUMMARY

      - name: Publish failure summary
        if: failure()
        run: |
          echo "### âŒ Failed to publish ${{ matrix.package.name }}" >> $GITHUB_STEP_SUMMARY
          echo "Please check the logs for details" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“¦ Package: ${{ matrix.package.name }}" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“ Path: ${{ matrix.package.path }}" >> $GITHUB_STEP_SUMMARY
