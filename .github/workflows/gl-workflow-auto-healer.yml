# @GL-governed
# @GL-layer: GL00-09
# @GL-semantic: general-component
# @GL-audit-trail: gl-platform-universe/governance/audit-trails/GL00_09-audit.json
#
# GL Unified Charter Activated
# GL Root Semantic Anchor: gl-platform-universe/governance/GL-ROOT-SEMANTIC-ANCHOR.yaml
# GL Unified Naming Charter: gl-platform-universe/governance/GL-UNIFIED-NAMING-CHARTER.yaml


name: GL Workflow Auto-Healer
on:
  workflow_run:
    workflows: ["*"]
    types: [completed]
  schedule:
    - cron: '*/30 * * * *'
  workflow_dispatch:
    inputs:
      target_workflow:
        description: 'Target workflow to analyze'
        required: false
        type: string

permissions:
  contents: write
  pull-requests: write
  actions: read
  checks: read

concurrency:
  group: gl-auto-healer-${{ github.ref }}
  cancel-in-progress: false

env:
  GL_GOVERNANCE_LEVEL: "3"
  GL_AUTO_FIX_ENABLED: "true"

jobs:
  detect-failures:
    runs-on: ubuntu-latest
    outputs:
      failed_workflows: ${{ steps.detect.outputs.failed_workflows }}
      failure_categories: ${{ steps.classify.outputs.categories }}
    steps:
      - uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11
        with:
          fetch-depth: 0

      - name: Detect Failed Workflows
        id: detect
        run: |
          FAILED=$(gh run list --status failure --limit 20 --json workflowName,conclusion,databaseId,headBranch 2>/dev/null || echo "[]")
          echo "failed_workflows=$FAILED" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Classify Failures
        id: classify
        run: |
          cat > /tmp/classifier.py << 'EOF'
          import json
          import sys
          import re

          CATEGORIES = {
              "dependency": ["npm ERR!", "pip install", "go: downloading", "dependency resolution"],
              "lint": ["eslint", "prettier", "golangci-lint", "flake8"],
              "test": ["FAIL", "test failed", "assertion", "expect"],
              "build": ["build failed", "compile error", "tsc", "webpack"],
              "security": ["vulnerability", "CVE-", "security scan"],
              "infrastructure": ["timeout", "connection refused", "rate limit"]
          }

          def classify_error(log_content):
              for category, patterns in CATEGORIES.items():
                  for pattern in patterns:
                      if pattern.lower() in log_content.lower():
                          return category
              return "unknown"

          if __name__ == "__main__":
              print(json.dumps({"categories": list(CATEGORIES.keys())}))
          EOF
          python3 /tmp/classifier.py > /tmp/categories.json
          echo "categories=$(cat /tmp/categories.json)" >> $GITHUB_OUTPUT

  apply-fixes:
    needs: detect-failures
    runs-on: ubuntu-latest
    if: needs.detect-failures.outputs.failed_workflows != '[]'
    strategy:
      matrix:
        fix_type: [dependency, lint, security, infrastructure]
      fail-fast: false
      max-parallel: 2
    steps:
      - uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@60edb5dd545a775178f52524783378180af0d1f8
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: '**/package-lock.json'

      - name: Apply ${{ matrix.fix_type }} Fix
        id: fix
        run: |
          FIX_TYPE="${{ matrix.fix_type }}"
          BRANCH="auto-fix/${FIX_TYPE}-$(date +%Y%m%d-%H%M%S)"
          
          git checkout -b "$BRANCH"
          
          case "$FIX_TYPE" in
            dependency)
              npm audit fix --force 2>/dev/null || true
              npm update 2>/dev/null || true
              ;;
            lint)
              npm run lint:fix 2>/dev/null || npx eslint --fix . 2>/dev/null || true
              ;;
            security)
              npm audit fix 2>/dev/null || true
              ;;
            infrastructure)
              echo "Infrastructure fixes require manual review"
              ;;
          esac
          
          if git diff --quiet; then
            echo "no_changes=true" >> $GITHUB_OUTPUT
          else
            echo "no_changes=false" >> $GITHUB_OUTPUT
            echo "branch=$BRANCH" >> $GITHUB_OUTPUT
          fi

      - name: Create Fix PR
        if: steps.fix.outputs.no_changes == 'false'
        run: |
          git add -A
          git commit -m "fix(${{ matrix.fix_type }}): Auto-fix ${{ matrix.fix_type }} issues

          GL Governance Level: ${{ env.GL_GOVERNANCE_LEVEL }}
          Auto-generated by GL Workflow Auto-Healer
          
          Signed-off-by: GL Agent <gl-agent@machinenativeops.io>"
          
          git push origin "${{ steps.fix.outputs.branch }}"
          
          gh pr create \
            --title "fix(${{ matrix.fix_type }}): Auto-fix ${{ matrix.fix_type }} issues" \
            --body "## Auto-Fix PR

          **Category:** ${{ matrix.fix_type }}
          **Generated:** $(date -u +%Y-%m-%dT%H:%M:%SZ)
          **GL Governance Level:** ${{ env.GL_GOVERNANCE_LEVEL }}

          This PR was automatically generated by the GL Workflow Auto-Healer.

          ### Changes Applied
          - Automated ${{ matrix.fix_type }} fixes

          ### Verification
          - [ ] CI passes
          - [ ] No regressions introduced
          - [ ] Security scan clean" \
            --base main \
            --head "${{ steps.fix.outputs.branch }}"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  generate-report:
    needs: [detect-failures, apply-fixes]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11

      - name: Generate Healing Report
        run: |
          mkdir -p reports/auto-fix
          cat > reports/auto-fix/$(date +%Y%m%d-%H%M%S).json << EOF
          {
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "governance_level": "${{ env.GL_GOVERNANCE_LEVEL }}",
            "detected_failures": ${{ needs.detect-failures.outputs.failed_workflows || '[]' }},
            "fix_attempts": {
              "dependency": "${{ needs.apply-fixes.result }}",
              "lint": "${{ needs.apply-fixes.result }}",
              "security": "${{ needs.apply-fixes.result }}"
            },
            "audit_trail": {
              "run_id": "${{ github.run_id }}",
              "actor": "${{ github.actor }}",
              "event": "${{ github.event_name }}"
            }
          }
          EOF

      - name: Upload Report
        uses: actions/upload-artifact@5d5d22a31266ced268874388b861e4b58bb5c2f3
        with:
          name: auto-fix-report-${{ github.run_id }}
          path: reports/auto-fix/
          retention-days: 90
