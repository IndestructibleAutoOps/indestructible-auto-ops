# @GL-governed
# @GL-layer: CI/CD
# @GL-semantic: workflow-validation
# @GL-audit-trail: ../../engine/governance/GL_SEMANTIC_ANCHOR.json
#
# GL Unified Charter Activated
name: GL Mainline Enforcement

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

permissions:
  contents: read
  pull-requests: write

env:
  GL_ENFORCEMENT: strict
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  gl-layer-check:
    name: GL Layer Validation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.11'

      - name: Install Dependencies
        run: pip install pyyaml

      - name: Validate GL Structure
        run: |
          echo "=== GL Structure Validation ==="
          
          # Check gl/ directory exists
          if [ ! -d "gl" ]; then
            echo "‚ùå ERROR: gl/ directory not found"
            exit 1
          fi
          
          # Check required GL layers exist
          for layer in "00-strategic" "10-operational" "30-execution" "50-observability" "60-feedback" "81-extended" "90-meta" "architecture"; do
            if [ ! -d "gl/$layer" ]; then
              echo "‚ö†Ô∏è WARNING: gl/$layer not found"
            else
              echo "‚úÖ gl/$layer exists"
            fi
          done
          
          # Check for duplicate governance directories
          if [ -d "workspace/gl/architecture" ]; then
            echo "‚ùå ERROR: Duplicate governance directory found: workspace/gl/architecture"
            exit 1
          fi
          
          echo "‚úÖ GL structure validation passed"

      - name: Check GL Naming Convention
        run: |
          echo "=== GL Naming Convention Check ==="
          
          # Find files with old naming convention
          old_naming=$(find gl/ -name "GL_*" -o -name "GL-*" 2>/dev/null | head -20)
          if [ -n "$old_naming" ]; then
            echo "‚ö†Ô∏è WARNING: Files with old GL naming convention found:"
            echo "$old_naming"
          else
            echo "‚úÖ All GL files follow kebab-case naming"
          fi

      - name: Validate GL Artifacts
        run: |
          echo "=== GL Artifacts Validation ==="
          
          # Count GL artifacts
          artifact_count=$(find gl/ -name "*.yaml" -o -name "*.yml" | wc -l)
          echo "üìä Total GL artifacts: $artifact_count"
          
          # Check for required core files
          required_files=(
            "gl/architecture/gl-constitution.yaml"
            "gl/architecture/gl-execution-mode.yaml"
            "gl/architecture/gl-layers.yaml"
          )
          
          for file in "${required_files[@]}"; do
            if [ -f "$file" ]; then
              echo "‚úÖ $file exists"
            else
              echo "‚ö†Ô∏è WARNING: $file not found"
            fi
          done

  gl-code-annotation-check:
    name: GL Code Annotation Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Check GL Annotations in Source
        run: |
          echo "=== GL Code Annotation Check ==="
          
          # Count files with GL-Layer annotations
          annotated=$(grep -r "GL-Layer:" src/ workspace/src/ 2>/dev/null | wc -l || echo "0")
          echo "üìä Files with GL-Layer annotation: $annotated"
          
          # List modules without GL annotation (warning only)
          echo ""
          echo "Modules to consider for GL annotation:"
          find src/ workspace/src/ -name "*.py" -o -name "*.ts" -o -name "*.js" 2>/dev/null | head -10 | while read f; do
            if ! grep -q "GL-Layer:" "$f" 2>/dev/null; then
              echo "  - $f"
            fi
          done || true

  gl-pr-label-check:
    name: GL PR Label Check
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@v6

      - name: Check PR for GL Layer Reference
        run: |
          echo "=== GL PR Check ==="
          
          # This is informational - encourage GL layer tagging
          echo "‚ÑπÔ∏è Remember to specify GL layer in PR description"
          echo "   Format: GL__-__ (e.g., GL30-49 for Execution Layer)"
          echo ""
          echo "GL Layer Reference:"
          echo "  GL00-09: Strategic"
          echo "  GL10-29: Operational"
          echo "  GL30-49: Execution"
          echo "  GL50-59: Observability"
          echo "  GL60-80: Feedback"
          echo "  GL81-83: Extended"
          echo "  GL90-99: Meta"