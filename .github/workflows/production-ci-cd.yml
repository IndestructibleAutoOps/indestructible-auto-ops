name: Production CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: machinenativeops/machine-native-ops
  KUBECTL_VERSION: 'v1.29.0'

jobs:
  # Job 1: Code Quality and Security
  quality-check:
    name: Code Quality and Security
    runs-on: ubuntu-latest
    outputs:
      quality-passed: ${{ steps.check.outputs.passed }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install quality tools
        run: |
          python -m pip install --upgrade pip
          pip install black flake8 pylint mypy bandit safety
      
      - name: Run Black formatting check
        run: black --check --diff . || exit 1
      
      - name: Run Flake8 linting
        run: flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics || exit 1
      
      - name: Run Pylint
        run: pylint ns_root/ --exit-zero || echo "Pylint warnings found"
      
      - name: Run mypy type checking
        run: mypy ns_root/ --ignore-missing-imports || echo "Type checking warnings found"
      
      - name: Run Bandit security scan
        run: bandit -r ns_root/ -f json -o bandit-report.json || echo "Security issues found"
        continue-on-error: true
      
      - name: Run Safety dependency check
        run: safety check --json > safety-report.json || echo "Dependency issues found"
        continue-on-error: true
      
      - name: Check quality gates
        id: check
        run: echo "passed=true" >> $GITHUB_OUTPUT
      
      - name: Upload security reports
        uses: actions/upload-artifact@v6
        with:
          name: security-reports
          path: |
            bandit-report.json
            safety-report.json

  # Job 2: Unit Tests with Coverage
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    needs: quality-check
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest pytest-cov pytest-asyncio pytest-mock pytest-timeout
      
      - name: Run unit tests
        run: |
          pytest ns_root/ \
            --cov=ns_root \
            --cov-report=xml \
            --cov-report=html \
            --cov-report=term-missing \
            --junitxml=pytest-report.xml \
            --timeout=300 \
            -v
      
      - name: Generate coverage summary
        run: |
          echo "## Coverage Summary" >> $GITHUB_STEP_SUMMARY
          coverage report --format=markdown >> $GITHUB_STEP_SUMMARY
      
      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v5
        with:
          file: ./coverage.xml
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false
      
      - name: Upload test reports
        uses: actions/upload-artifact@v6
        with:
          name: unit-test-reports
          path: |
            pytest-report.xml
            htmlcov/
            coverage.xml

  # Job 3: Integration Tests
  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: unit-tests
    services:
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest pytest-asyncio pytest-mock redis
      
      - name: Run integration tests
        run: |
          pytest integration-tests/ \
            --cov=ns_root \
            --cov-report=xml \
            --junitxml=integration-report.xml \
            -v \
            --timeout=300
      
      - name: Upload integration test reports
        uses: actions/upload-artifact@v6
        with:
          name: integration-test-reports
          path: |
            integration-report.xml
            coverage.xml

  # Job 4: Performance Tests
  performance-tests:
    name: Performance Tests
    runs-on: ubuntu-latest
    needs: unit-tests
    services:
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest pytest-benchmark redis psutil
      
      - name: Run performance tests
        run: |
          pytest performance-tests/ \
            --benchmark-only \
            --benchmark-json=benchmark.json \
            --benchmark-autosave \
            --benchmark-columns=min,max,mean,median,rounds,iterations
      
      - name: Analyze benchmark results
        run: |
          echo "## Performance Benchmark Results" >> $GITHUB_STEP_SUMMARY
          cat benchmark.json | python -m json.tool >> $GITHUB_STEP_SUMMARY || true
      
      - name: Upload benchmark results
        uses: actions/upload-artifact@v6
        with:
          name: performance-benchmark-results
          path: benchmark.json

  # Job 5: Build Docker Image
  build-image:
    name: Build Docker Image
    runs-on: ubuntu-latest
    needs: [integration-tests, performance-tests]
    permissions:
      contents: read
      packages: write
    outputs:
      image-tag: ${{ steps.meta.outputs.tags }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=ref,event=branch
            type=sha,prefix=
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
      
      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            BUILD_DATE=${{ github.event.head_commit.timestamp }}
            VCS_REF=${{ github.sha }}
            VERSION=${{ github.ref_name }}
      
      - name: Generate SBOM
        uses: anchore/sbom-action@v0
        with:
          image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
          output-file: sbom.json
      
      - name: Upload SBOM
        uses: actions/upload-artifact@v6
        with:
          name: sbom
          path: sbom.json

  # Job 6: Security Scanning
  security-scan:
    name: Security Scanning
    runs-on: ubuntu-latest
    needs: build-image
    permissions:
      contents: read
      packages: read
      security-events: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'
      
      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: 'trivy-results.sarif'
          category: 'trivy'
      
      - name: Run Grype vulnerability scanner
        uses: anchore/scan-action@v7
        with:
          image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
          format: 'sarif'
          output: 'grype-results.sarif'
          severity: 'CRITICAL,HIGH,MEDIUM'
      
      - name: Upload Grype results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: 'grype-results.sarif'
          category: 'grype'

  # Job 7: Deploy to Staging
  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: [build-image, security-scan]
    if: github.ref == 'refs/heads/develop'
    environment:
      name: staging
      url: https://staging.machinenativeops.com
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: ${{ env.KUBECTL_VERSION }}
      
      - name: Configure Kubernetes credentials
        uses: azure/k8s-set-context@v4
        with:
          method: kubeconfig
          kubeconfig: ${{ secrets.STAGING_KUBECONFIG }}
          context: staging-cluster
      
      - name: Deploy to Kubernetes
        run: |
          kubectl apply -f k8s/staging/
          kubectl set image deployment/machine-native-ops \
            app=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }} \
            -n staging
      
      - name: Wait for deployment
        run: |
          kubectl wait --for=condition=available \
            deployment/machine-native-ops \
            -n staging \
            --timeout=300s
      
      - name: Run smoke tests
        run: |
          kubectl run smoke-test --image=curlimages/curl --rm -i --restart=Never -- \
            curl -f https://staging.machinenativeops.com/health || exit 1
      
      - name: Run integration tests on staging
        run: |
          pytest integration-tests/ --env=staging -v
      
      - name: Notify team
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          text: 'Deployment to staging completed successfully'
          webhook_url: ${{ secrets.SLACK_WEBHOOK }}
        if: success()

  # Job 8: Deploy to Production
  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [build-image, security-scan]
    if: github.ref == 'refs/heads/main'
    environment:
      name: production
      url: https://machinenativeops.com
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: ${{ env.KUBECTL_VERSION }}
      
      - name: Configure Kubernetes credentials
        uses: azure/k8s-set-context@v4
        with:
          method: kubeconfig
          kubeconfig: ${{ secrets.PRODUCTION_KUBECONFIG }}
          context: production-cluster
      
      - name: Create deployment backup
        run: |
          kubectl get deployment machine-native-ops -n production -o yaml > deployment-backup.yaml
      
      - name: Deploy to Kubernetes (Blue-Green)
        run: |
          # Create new deployment version
          kubectl apply -f k8s/production/
          kubectl set image deployment/machine-native-ops \
            app=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }} \
            -n production
      
      - name: Wait for new deployment
        run: |
          kubectl wait --for=condition=available \
            deployment/machine-native-ops \
            -n production \
            --timeout=600s
      
      - name: Run smoke tests
        run: |
          kubectl run smoke-test --image=curlimages/curl --rm -i --restart=Never -- \
            curl -f https://machinenativeops.com/health || exit 1
      
      - name: Run health checks
        run: |
          kubectl run health-check --image=curlimages/curl --rm -i --restart=Never -- \
            curl -f https://machinenativeops.com/api/health || exit 1
      
      - name: Monitor deployment health
        run: |
          for i in {1..60}; do
            if curl -f https://machinenativeops.com/health; then
              echo "Deployment healthy"
              break
            fi
            echo "Waiting for deployment to become healthy..."
            sleep 10
          done
      
      - name: Rollback on failure
        if: failure()
        run: |
          kubectl apply -f deployment-backup.yaml
          echo "Deployment rolled back due to health check failure"
          exit 1
      
      - name: Update deployment tag
        run: |
          kubectl annotate deployment/machine-native-ops \
            kubernetes.io/change-cause="Deployed version ${{ github.sha }}" \
            -n production
      
      - name: Notify team
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          text: 'Deployment to production completed successfully'
          webhook_url: ${{ secrets.SLACK_WEBHOOK }}
        if: success()
      
      - name: Notify deployment failure
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          text: 'Deployment to production failed and was rolled back'
          webhook_url: ${{ secrets.SLACK_WEBHOOK }}
        if: failure()

  # Job 9: Post-Deployment Verification
  post-deployment-verification:
    name: Post-Deployment Verification
    runs-on: ubuntu-latest
    needs: [deploy-production]
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest requests
      
      - name: Run production smoke tests
        run: |
          pytest production-tests/smoke-tests.py -v
      
      - name: Run production health checks
        run: |
          curl -f https://machinenativeops.com/health || exit 1
          curl -f https://machinenativeops.com/api/health || exit 1
      
      - name: Verify service endpoints
        run: |
          endpoints=(
            "https://machinenativeops.com/api/memory"
            "https://machinenativeops.com/api/config"
            "https://machinenativeops.com/api/reporting"
          )
          for endpoint in "${endpoints[@]}"; do
            curl -f "$endpoint/health" || exit 1
          done
      
      - name: Check system metrics
        run: |
          curl -f https://machinenativeops.com/api/metrics || exit 1
      
      - name: Generate deployment report
        run: |
          echo "## Deployment Report" >> $GITHUB_STEP_SUMMARY
          echo "- **Version**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Deployed at**: $(date)" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: Success" >> $GITHUB_STEP_SUMMARY