name: AI-Driven Integration Analyzer

on:
  pull_request:
    types: [opened, synchronize, reopened, labeled]
    branches: [ main, develop ]
  push:
    branches: [ main, develop ]
  workflow_dispatch:

permissions:
  contents: read
  issues: write
  pull-requests: write

# å–æ¶ˆåŒä¸€ PR çš„èˆŠ workflow runs
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # å–®ä¸€ job è™•ç†æ‰€æœ‰æƒ…æ³ï¼Œé¿å… skipped jobs
  ai-analysis:
    name: AI Code Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Fetch base branch (for PRs)
        if: github.event_name == 'pull_request'
        run: |
          git fetch origin ${{ github.base_ref }} --depth=1 || true

      - name: Path lister action
        uses: Rishabh510/Path-lister-action@1.0

      - name: SPIDYNAL SYSTEM
        continue-on-error: true
        uses: maiz-an/SPIDYNAL@v1.3.0.8

      - name: Analyze code changes
        id: analysis
        run: |
          echo "## ðŸ¤– AI Code Analysis" > /tmp/analysis.md
          echo "" >> /tmp/analysis.md
          
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            echo "### ðŸ“Š PR Change Statistics" >> /tmp/analysis.md
            
            # Get changed files with fallback
            CHANGED_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD 2>/dev/null | wc -l || echo "0")
            echo "- Changed files: $CHANGED_FILES" >> /tmp/analysis.md
            
            # Get lines changed
            LINES_ADDED=$(git diff --numstat origin/${{ github.base_ref }}...HEAD 2>/dev/null | awk '{sum+=$1} END {print sum+0}' || echo "0")
            LINES_DELETED=$(git diff --numstat origin/${{ github.base_ref }}...HEAD 2>/dev/null | awk '{sum+=$2} END {print sum+0}' || echo "0")
            echo "- Lines added: $LINES_ADDED" >> /tmp/analysis.md
            echo "- Lines deleted: $LINES_DELETED" >> /tmp/analysis.md
            
            # Risk assessment
            echo "" >> /tmp/analysis.md
            echo "### ðŸŽ¯ Risk Assessment" >> /tmp/analysis.md
            PY_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD 2>/dev/null | grep '\.py$' | wc -l || echo "0")
            
            RISK_LEVEL="low"
            if [ "$PY_FILES" -gt 10 ]; then
              RISK_LEVEL="high"
              echo "- ðŸ”´ High risk: Large number of Python file changes" >> /tmp/analysis.md
            elif [ "$PY_FILES" -gt 5 ]; then
              RISK_LEVEL="medium"
              echo "- ðŸŸ¡ Medium risk: Moderate changes" >> /tmp/analysis.md
            else
              echo "- ðŸŸ¢ Low risk: Minor changes" >> /tmp/analysis.md
            fi
            echo "risk=$RISK_LEVEL" >> $GITHUB_OUTPUT
          else
            echo "### â„¹ï¸ Push Event" >> /tmp/analysis.md
            echo "This is a push event to ${{ github.ref_name }}" >> /tmp/analysis.md
            echo "risk=low" >> $GITHUB_OUTPUT
          fi
          
          cat /tmp/analysis.md

      - name: Create or update PR comment
        if: github.event_name == 'pull_request'
        continue-on-error: true  # Allow workflow to pass even if comment fails (e.g., for cross-repo PRs)
        uses: actions/github-script@v8
        with:
          script: |
            const fs = require('fs');
            let comment = '';
            
            try {
              comment = fs.readFileSync('/tmp/analysis.md', 'utf8');
            } catch (error) {
              comment = '## ðŸ¤– AI Code Analysis\n\nAnalysis completed.';
            }
            
            comment += '\n\n---\n';
            comment += `Risk Level: ${{ steps.analysis.outputs.risk }}\n`;
            
            // Find existing comment and update
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number
            });
            
            const existingComment = comments.find(c => 
              c.user.type === 'Bot' && c.body.includes('ðŸ¤– AI Code Analysis')
            );
            
            if (existingComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existingComment.id,
                body: comment
              });
            } else {
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });
            }

      - name: Analysis complete
        run: |
          echo "âœ… AI Code Analysis completed"
          echo "Event: ${{ github.event_name }}"
          echo "Risk: ${{ steps.analysis.outputs.risk }}"