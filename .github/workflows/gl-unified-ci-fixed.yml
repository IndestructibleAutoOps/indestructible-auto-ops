# @GL-governed
# @GL-layer: CI/CD
# @GL-semantic: workflow-validation
# @GL-audit-trail: ../../engine/governance/GL_SEMANTIC_ANCHOR.json
#
# GL Unified Charter Activated
# GL Enforcement: Strict - No continue-on-error
# GL Validation: Required - All checks must pass before merge
#
# This workflow enforces GL governance compliance across the entire repository

name: GL Unified CI - Fixed

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # GL Governance Validation
  gl-governance-check:
    name: GL Governance Validation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Validate GL Semantic Anchors
        run: |
          echo "Validating GL semantic anchors..."
          find . -name "*.json" -o -name "*.yaml" -o -name "*.yml" | \
            xargs grep -l "@GL-governed" | \
            while read file; do
              echo "Checking $file..."
              grep -q "@GL-layer:" "$file" || echo "Missing @GL-layer in $file"
              grep -q "@GL-semantic:" "$file" || echo "Missing @GL-semantic in $file"
            done

      - name: Validate Agent Orchestration Config
        run: |
          echo "Validating agent orchestration configuration..."
          if [ -f ".github/agents/agent-orchestration.yml" ]; then
            echo "Agent orchestration config found"
            # Add validation logic here
          else
            echo "Error: Agent orchestration config missing"
            exit 1
          fi

  # JavaScript/TypeScript Syntax Check
  js-syntax-check:
    name: JavaScript/TypeScript Syntax Validation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 'lts/*'

      - name: Check JavaScript syntax
        run: |
          echo "Checking JavaScript syntax..."
          find . -type f -name "*.js" \
            -not -path "./node_modules/*" \
            -not -path "./.github/archive/*" \
            -not -path "./.git/*" \
            -not -name "*.config.js" | \
            while read file; do
              node --check "$file" || exit 1
            done

  # CodeQL Analysis (JavaScript/TypeScript)
  codeql-analyze-js:
    name: CodeQL Analysis (JavaScript/TypeScript)
    runs-on: ubuntu-latest
    permissions:
      security-events: write
      packages: read
      actions: read
      contents: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Initialize CodeQL (JavaScript/TypeScript)
        uses: github/codeql-action/init@v4
        with:
          languages: javascript-typescript
          build-mode: none

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v4
        with:
          category: "/language:javascript-typescript"

  # CodeQL Analysis (Python)
  codeql-analyze-python:
    name: CodeQL Analysis (Python)
    runs-on: ubuntu-latest
    permissions:
      security-events: write
      packages: read
      actions: read
      contents: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Initialize CodeQL (Python)
        uses: github/codeql-action/init@v4
        with:
          languages: python
          build-mode: none

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v4
        with:
          category: "/language:python"

  # CodeQL Analysis (Actions)
  codeql-analyze-actions:
    name: CodeQL Analysis (GitHub Actions)
    runs-on: ubuntu-latest
    permissions:
      security-events: write
      packages: read
      actions: read
      contents: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Initialize CodeQL (Actions)
        uses: github/codeql-action/init@v4
        with:
          languages: actions
          build-mode: none

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v4
        with:
          category: "/language:actions"

  # Summary
  governance-summary:
    name: GL Governance Summary
    runs-on: ubuntu-latest
    needs: [gl-governance-check, js-syntax-check, codeql-analyze-js, codeql-analyze-python, codeql-analyze-actions]
    if: always()
    steps:
      - name: Generate Summary
        run: |
          echo "# GL Governance Validation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Status" >> $GITHUB_STEP_SUMMARY
          echo "- GL Governance Check: ${{ needs.gl-governance-check.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- JS Syntax Check: ${{ needs.js-syntax-check.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- CodeQL JS/TS: ${{ needs.codeql-analyze-js.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- CodeQL Python: ${{ needs.codeql-analyze-python.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- CodeQL Actions: ${{ needs.codeql-analyze-actions.result }}" >> $GITHUB_STEP_SUMMARY