# @GL-governed
# @GL-layer: CI/CD
# @GL-semantic: workflow-validation
# @GL-audit-trail: ../../engine/governance/GL_SEMANTIC_ANCHOR.json
#
# GL Unified Charter Activated
# gates-01-99-validation.yml
# Intelligent-Hyperautomation Pipeline Gate Validation
# GL Unified Charter Activated v2.0.0
#
# @gl-layer: operational
# @gl-tier: gl10-gate-system
# @gl-purpose: pipeline-gate-validation
# @gl-compliance: strict
# @gl-validation: required

name: Gates-01-99 Validation

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'engine/gl-gate/**'
      - 'engine/gl-gate/gates/gates-01-99.yaml'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'engine/gl-gate/**'
      - 'engine/gl-gate/gates/gates-01-99.yaml'
  workflow_dispatch:
  schedule:
    - cron: '0 6 * * *'  # Daily at 6 AM UTC

permissions:
  contents: read
  pull-requests: write
  checks: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  gates-yaml-validation:
    name: Validate Gates-01-99 YAML Structure
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: |
          cd engine/gl-gate
          npm ci

      - name: Validate Gates-01-99 YAML (Standard)
        run: |
          cd engine/gl-gate
          npm run validate-gates

      - name: Validate Gates-01-99 YAML (Strict Mode)
        run: |
          cd engine/gl-gate
          npm run validate-gates:strict

      - name: Check YAML Syntax
        run: |
          python3 -c "
          import yaml
          import sys
          
          try:
              with open('engine/gl-gate/gates/gates-01-99.yaml', 'r') as f:
                  data = yaml.safe_load(f)
              
              # Validate required sections
              required_sections = ['metadata', 'parameters', 'triggers', 'conditions', 'actions', 'outputs', 'compliance', 'attestation', 'approvals', 'variables']
              missing_sections = [s for s in required_sections if s not in data]
              
              if missing_sections:
                  print(f'‚ùå Missing required sections: {missing_sections}')
                  sys.exit(1)
              
              # Validate GL metadata
              if 'gl_version' not in data['metadata']:
                  print('‚ùå Missing gl_version in metadata')
                  sys.exit(1)
              
              if data['metadata']['gl_version'] != '2.0.0':
                  print(f"‚ùå Invalid gl_version: {data['metadata']['gl_version']}, expected 2.0.0")
                  sys.exit(1)
              
              print('‚úÖ YAML syntax validation passed')
              print(f'‚úÖ GL version: {data["metadata"]["gl_version"]}')
              print(f'‚úÖ Compliance level: {data["metadata"]["compliance_level"]}')
              
          except yaml.YAMLError as e:
              print(f'‚ùå YAML syntax error: {e}')
              sys.exit(1)
          except Exception as e:
              print(f'‚ùå Validation error: {e}')
              sys.exit(1)
          "

  gl-governance-validation:
    name: Validate GL Governance Requirements
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate GL Markers in Gates Configuration
        run: |
          echo "Checking for GL governance markers..."
          
          if ! grep -q "@gl-layer:" engine/gl-gate/gates/gates-01-99.yaml; then
              echo "‚ùå Missing @gl-layer marker"
              exit 1
          fi
          
          if ! grep -q "@gl-tier:" engine/gl-gate/gates/gates-01-99.yaml; then
              echo "‚ùå Missing @gl-tier marker"
              exit 1
          fi
          
          if ! grep -q "@gl-purpose:" engine/gl-gate/gates/gates-01-99.yaml; then
              echo "‚ùå Missing @gl-purpose marker"
              exit 1
          fi
          
          if ! grep -q "@gl-compliance:" engine/gl-gate/gates/gates-01-99.yaml; then
              echo "‚ùå Missing @gl-compliance marker"
              exit 1
          fi
          
          echo "‚úÖ All GL governance markers present"

  gates-configuration-validation:
    name: Validate Gates Configuration Completeness
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate Gate Definitions
        run: |
          python3 << 'PYTHON_SCRIPT'
          import yaml
          import sys
          
          with open('engine/gl-gate/gates/gates-01-99.yaml', 'r') as f:
              config = yaml.safe_load(f)
          
          print("üîç Validating Gate Definitions...")
          gates = config.get('conditions', {}).get('gates', [])
          
          # Required gates for GL compliance
          required_gates = [
              'gl_governance_validation',
              'source_code_lint',
              'sast_scan',
              'policy_linting',
              'vulnerability_scan',
              'manual_approval'
          ]
          
          missing_gates = [g for g in required_gates if not any(gate['name'] == g for gate in gates)]
          
          if missing_gates:
              print(f"‚ùå Missing required gates: {missing_gates}")
              sys.exit(1)
          
          # Check that GL governance validation gate is configured correctly
          gl_gate = next((g for g in gates if g['name'] == 'gl_governance_validation'), None)
          
          if not gl_gate:
              print("‚ùå gl_governance_validation gate not found")
              sys.exit(1)
          
          if not gl_gate.get('enabled') or not gl_gate.get('required'):
              print("‚ùå gl_governance_validation gate must be enabled and required")
              sys.exit(1)
          
          if gl_gate.get('on_failure') != 'block':
              print("‚ùå gl_governance_validation gate must block on failure")
              sys.exit(1)
          
          print(f"‚úÖ All {len(gates)} gates validated successfully")
          print(f"‚úÖ GL governance validation gate properly configured")
          PYTHON_SCRIPT

      - name: Validate Trigger Configuration
        run: |
          python3 << 'PYTHON_SCRIPT'
          import yaml
          
          with open('engine/gl-gate/gates/gates-01-99.yaml', 'r') as f:
              config = yaml.safe_load(f)
          
          print("üîç Validating Trigger Configuration...")
          triggers = config.get('triggers', {})
          
          required_triggers = ['ci', 'pr', 'schedule', 'manual']
          
          for trigger in required_triggers:
              if trigger not in triggers:
                  print(f"‚ö†Ô∏è  Warning: Missing trigger: {trigger}")
              elif not triggers[trigger].get('enabled'):
                  print(f"‚ö†Ô∏è  Warning: Trigger {trigger} is disabled")
          
          print("‚úÖ Trigger configuration validated")
          PYTHON_SCRIPT

      - name: Validate Compliance Configuration
        run: |
          python3 << 'PYTHON_SCRIPT'
          import yaml
          
          with open('engine/gl-gate/gates/gates-01-99.yaml', 'r') as f:
              config = yaml.safe_load(f)
          
          print("üîç Validating Compliance Configuration...")
          compliance = config.get('compliance', {})
          
          if not compliance.get('fail_on_violation'):
              print("‚ùå fail_on_violation must be true")
              exit(1)
          
          if compliance.get('allow_override'):
              print("‚ùå allow_override must be false in GL strict mode")
              exit(1)
          
          policies = compliance.get('policies', [])
          if not policies:
              print("‚ö†Ô∏è  Warning: No compliance policies defined")
          
          print("‚úÖ Compliance configuration validated")
          PYTHON_SCRIPT

      - name: Validate Attestation Configuration
        run: |
          python3 << 'PYTHON_SCRIPT'
          import yaml
          
          with open('engine/gl-gate/gates/gates-01-99.yaml', 'r') as f:
              config = yaml.safe_load(f)
          
          print("üîç Validating Attestation Configuration...")
          attestation = config.get('attestation', {})
          
          if not attestation.get('enabled'):
              print("‚ö†Ô∏è  Warning: Attestation is disabled")
          
          required_types = ['sbom', 'signature']
          attestation_types = attestation.get('types', [])
          
          missing_types = [t for t in required_types if t not in attestation_types]
          if missing_types:
              print(f"‚ö†Ô∏è  Warning: Missing attestation types: {missing_types}")
          
          print("‚úÖ Attestation configuration validated")
          PYTHON_SCRIPT

  gates-validation-summary:
    name: Gates Validation Summary
    runs-on: ubuntu-latest
    needs: [gates-yaml-validation, gl-governance-validation, gates-configuration-validation]
    if: always()
    
    steps:
      - name: Check all validations
        run: |
          echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
          echo "        Gates-01-99 Validation Summary"
          echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
          echo ""
          echo "üìä Results:"
          echo "   - YAML Validation: ${{ needs.gates-yaml-validation.result }}"
          echo "   - GL Governance: ${{ needs.gl-governance-validation.result }}"
          echo "   - Configuration: ${{ needs.gates-configuration-validation.result }}"
          echo ""
          
          if [ "${{ needs.gates-yaml-validation.result }}" == "success" ] && \
             [ "${{ needs.gl-governance-validation.result }}" == "success" ] && \
             [ "${{ needs.gates-configuration-validation.result }}" == "success" ]; then
            echo "‚úÖ All gates validations passed!"
            echo ""
            echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
            exit 0
          else
            echo "‚ùå Some gates validations failed"
            echo ""
            echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
            exit 1
          fi

      - name: Comment on PR (if applicable)
        if: github.event_name == 'pull_request'
        continue-on-error: false
        uses: actions/github-script@v8
        with:
          script: |
            const yamlResult = '${{ needs.gates-yaml-validation.result }}';
            const glResult = '${{ needs.gl-governance-validation.result }}';
            const configResult = '${{ needs.gates-configuration-validation.result }}';
            
            const allPassed = yamlResult === 'success' &&
                              glResult === 'success' &&
                              configResult === 'success';
            
            const status = allPassed ? '‚úÖ PASSED' : '‚ùå FAILED';
            const yamlIcon = yamlResult === 'success' ? '‚úÖ' : '‚ùå';
            const glIcon = glResult === 'success' ? '‚úÖ' : '‚ùå';
            const configIcon = configResult === 'success' ? '‚úÖ' : '‚ùå';
            
            const comment = `## üö™ Gates-01-99 Validation Results
            
            ${status}
            
            | Validation | Status |
            |------------|--------|
            | YAML Structure | ${yamlIcon} ${yamlResult} |
            | GL Governance | ${glIcon} ${glResult} |
            | Configuration | ${configIcon} ${configResult} |
            
            ${allPassed ? '**All gates validations passed! Ready for merge.**' : '**Some gates validations failed. Please review the workflow logs.**'}
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
