# @GL-governed
# @GL-layer: CI/CD
# @GL-semantic: workflow-validation
# @GL-audit-trail: ../../engine/governance/GL_SEMANTIC_ANCHOR.json
#
# GL Unified Charter Activated
name: CI Fail Auto Classification System

on:
  workflow_run:
    workflows: ["CI", "Tests", "Build"]  # List specific workflows to monitor
    types:
      - completed
  pull_request:
    types:
      - opened
      - synchronize
      - reopened

permissions:
  contents: read
  pull-requests: write
  checks: read
  issues: write
  actions: write

jobs:
  classify-ci-failure:
    name: Classify CI Failure
    if: github.event.workflow_run?.conclusion == 'failure'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'

      - name: Install dependencies
        run: |
          cd workspace/src/ci-tools/failure-classifier
          npm install

      - name: Build classifier
        run: |
          cd workspace/src/ci-tools/failure-classifier
          npm run build
      - name: Get PR information
        id: pr-info
        uses: actions/github-script@v8
        with:
          script: |
            const { data: pulls } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              head: `${context.repo.owner}:${context.event.workflow_run.head_branch}`
            });
            
            const pr = pulls[0];
            if (!pr) {
              core.setFailed('No PR found for this workflow run');
              return;
            }

            // Get PR diff
            const { data: diff } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: pr.number,
              mediaType: {
                format: 'diff'
              }
            });

            // Get changed files
            const { data: files } = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: pr.number
            });

            const changedFiles = files.map(f => f.filename);
            const changedModules = [...new Set(changedFiles.map(f => f.split('/')[0]))];

            const prDiff = {
              prNumber: pr.number,
              title: pr.title,
              author: pr.user.login,
              baseBranch: pr.base.ref,
              headBranch: pr.head.ref,
              changedFiles,
              changedLines: files.filter(f => f.status !== 'removed').map(f => ({
                file: f.filename,
                added: typeof f.additions === 'number' ? f.additions : 0,
                removed: typeof f.deletions === 'number' ? f.deletions : 0
              })),
              changedModules,
              timestamp: new Date(pr.created_at).getTime()
            };

            const workflowRun = context.event.workflow_run;
            const ciFailure = {
              workflowName: workflowRun.name,
              workflowId: workflowRun.id.toString(),
              jobName: 'unknown',  // éœ€è¦å¾ž workflow run jobs ç²å–
              stepName: 'unknown',  // éœ€è¦å¾ž logs ç²å–
              failureMessage: 'Workflow failed',
              failureLog: 'Check workflow logs for details',
              failedFiles: changedFiles,
              failedLines: [],
              timestamp: new Date(workflowRun.updated_at).getTime(),
              runNumber: workflowRun.run_number,
              runId: workflowRun.id.toString()
            };

            core.setOutput('pr-diff', JSON.stringify(prDiff));
            core.setOutput('ci-failure', JSON.stringify(ciFailure));
            core.setOutput('pr-number', pr.number);

      - name: Run classification
        id: classify
        env:
          PR_DIFF: ${{ steps.pr-info.outputs.pr-diff }}
          CI_FAILURE: ${{ steps.pr-info.outputs.ci-failure }}
        run: |
          cd workspace/src/ci-tools/failure-classifier
          result=$(node --input-type=module -e "
            import('./dist/index.js').then(({ CIFailAutoClassificationSystem }) => {
              const system = new CIFailAutoClassificationSystem();
              
              const prDiff = JSON.parse(process.env.PR_DIFF);
              const ciFailure = JSON.parse(process.env.CI_FAILURE);
              
              return system.classify(prDiff, ciFailure);
            }).then(result => {
              console.log(JSON.stringify(result, null, 2));
              process.exit(0);
            }).catch(err => {
              console.error(err);
              process.exit(1);
            });
          ")
          echo "result=$result" >> $GITHUB_OUTPUT
          echo "should-rerun=$(echo $result | jq -r '.shouldRerun')" >> $GITHUB_OUTPUT

      - name: Post comment to PR
        if: steps.classify.outcome == 'success'
        uses: actions/github-script@v8
        with:
          script: |
            const prNumber = '${{ steps.pr-info.outputs.pr-number }}';
            const result = JSON.parse('${{ steps.classify.outputs.result }}');
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: result.prComment
            });

      - name: Add labels to PR
        if: steps.classify.outcome == 'success'
        uses: actions/github-script@v8
        with:
          script: |
            const prNumber = '${{ steps.pr-info.outputs.pr-number }}';
            const result = JSON.parse('${{ steps.classify.outputs.result }}');
            
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              labels: result.labels
            });

      - name: Auto rerun if needed
        if: steps.classify.outputs.should-rerun == 'true'
        uses: actions/github-script@v8
        with:
          script: |
            const workflowRunId = context.payload.workflow_run.id;
            const owner = context.payload.workflow_run.repository.owner.login;
            const repo = context.payload.workflow_run.repository.name;
            
            await github.rest.actions.reRunWorkflow({
              owner: owner,
              repo: repo,
              run_id: workflowRunId
            });

  health-monitor:
    name: CI Health Monitor
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'

      - name: Install dependencies
        run: |
          cd workspace/src/ci-tools/failure-classifier
          npm install
          npm run build

      - name: Generate health report
        id: health-report
        run: |
          cd workspace/src/ci-tools/failure-classifier
          report=$(node --input-type=module -e "
            import('./dist/index.js').then(({ CIFailAutoClassificationSystem }) => {
              const system = new CIFailAutoClassificationSystem();
              
              return system.getCIHealthReport('ci.yml');
            }).then(report => {
              console.log(JSON.stringify(report, null, 2));
              process.exit(0);
            }).catch(err => {
              console.error(err);
              process.exit(1);
            });
          ")
          echo "report=$report" >> $GITHUB_OUTPUT
          echo "health-status=$(echo $report | jq -r '.status')" >> $GITHUB_OUTPUT

      - name: Create health issue if unhealthy
        if: steps.health-report.outputs.health-status != 'HEALTHY'
        uses: actions/github-script@v8
        with:
          script: |
            const report = JSON.parse('${{ steps.health-report.outputs.report }}');
            
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ðŸš¨ CI System Unhealthy',
              body: report.report,
              labels: ['ci-health', 'urgent']
            });