# @GL-governed
# @GL-layer: CI/CD
# @GL-semantic: workflow-validation
# @GL-audit-trail: ../../engine/governance/GL_SEMANTIC_ANCHOR.json
#
# GL Unified Charter Activated
# Notification Module - Pluggable Component
# Supports multiple notification channels

name: Notification Module

on:
  workflow_call:
    inputs:
      enabled:
        required: false
        type: boolean
        default: false
      slack_enabled:
        required: false
        type: boolean
        default: false
      email_enabled:
        required: false
        type: boolean
        default: false
      discord_enabled:
        required: false
        type: boolean
        default: false
      event_type:
        required: true
        type: string
      status:
        required: true
        type: string
      message:
        required: false
        type: string
        default: ''
    secrets:
      SLACK_WEBHOOK:
        required: false
      SMTP_SERVER:
        required: false
      SMTP_PORT:
        required: false
      SMTP_USERNAME:
        required: false
      SMTP_PASSWORD:
        required: false
      EMAIL_TO:
        required: false
      DISCORD_WEBHOOK:
        required: false

jobs:
  notify:
    name: Send Notifications
    runs-on: ubuntu-latest
    if: inputs.enabled == true
    steps:
      - name: Prepare notification message
        id: message
        run: |
          STATUS_EMOJI="âœ…"
          if [ "${{ inputs.status }}" == "failure" ]; then
            STATUS_EMOJI="âŒ"
          elif [ "${{ inputs.status }}" == "warning" ]; then
            STATUS_EMOJI="âš ï¸"
          fi
          
          cat > notification.md << EOF
          ${STATUS_EMOJI} ${{ inputs.event_type }}
          
          **Repository:** ${{ github.repository }}
          **Branch:** ${{ github.ref_name }}
          **Commit:** ${{ github.sha }}
          **Actor:** ${{ github.actor }}
          **Workflow:** ${{ github.workflow }}
          **Run:** #${{ github.run_number }}
          
          ${{ inputs.message }}
          EOF
          
          echo "message_content=$(cat notification.md)" >> $GITHUB_OUTPUT

      - name: Send Slack notification
        if: inputs.slack_enabled == true && secrets.SLACK_WEBHOOK != ''
        run: |
          MESSAGE=$(cat notification.md | sed 's/_/\\_/g; s/\*/\\*/g; s/`/\\`/g')
          curl -X POST ${{ secrets.SLACK_WEBHOOK }} \
            -H 'Content-Type: application/json' \
            -d '{"text":"'"${MESSAGE}"'"}' || echo "âš ï¸  Slack notification failed"
        continue-on-error: true

      - name: Send Discord notification
        if: inputs.discord_enabled == true && secrets.DISCORD_WEBHOOK != ''
        run: |
          MESSAGE=$(cat notification.md)
          curl -X POST ${{ secrets.DISCORD_WEBHOOK }} \
            -H 'Content-Type: application/json' \
            -d '{"content":"'"${MESSAGE}"'"}' || echo "âš ï¸  Discord notification failed"
        continue-on-error: true

      - name: Send email notification
        if: inputs.email_enabled == true && secrets.SMTP_SERVER != ''
        run: |
          cat > email.txt << EOF
          Subject: ${{ inputs.event_type }} - ${{ github.repository }}
          To: ${{ secrets.EMAIL_TO }}
          From: CI/CD Pipeline <ci-cd@${{ github.repository_owner }}.com>
          
          $(cat notification.md)
          
          ---
          View details: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          EOF
          
          if command -v sendmail &> /dev/null; then
            sendmail -t < email.txt || echo "âš ï¸  Email notification failed"
          elif command -v mail &> /dev/null; then
            mail -s "${{ inputs.event_type }}" ${{ secrets.EMAIL_TO }} < notification.md || echo "âš ï¸  Email notification failed"
          else
            echo "âš ï¸  No mail command available, skipping email"
          fi
        continue-on-error: true

      - name: Console notification
        run: |
          echo "=========================================="
          echo "ðŸ“¢ NOTIFICATION: ${{ inputs.event_type }}"
          echo "=========================================="
          cat notification.md
          echo "=========================================="