# Testing Module - Pluggable Component
# Can be enabled/disabled via config.yml

name: Test Module

on:
  workflow_call:
    inputs:
      node_version:
        required: false
        type: string
        default: '20.x'
      python_version:
        required: false
        type: string
        default: '3.11'
      enabled:
        required: false
        type: boolean
        default: true
      coverage_threshold:
        required: false
        type: number
        default: 80
      unit_tests:
        required: false
        type: boolean
        default: true
      integration_tests:
        required: false
        type: boolean
        default: true
      e2e_tests:
        required: false
        type: boolean
        default: false
    outputs:
      unit_test_result:
        value: ${{ jobs.unit-test.result }}
      integration_test_result:
        value: ${{ jobs.integration-test.result }}
      coverage:
        value: ${{ jobs.coverage.outputs.percentage }}

jobs:
  unit-test:
    name: Unit Tests
    runs-on: ubuntu-latest
    if: inputs.enabled == true && inputs.unit_tests == true
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.node_version }}
          cache: 'npm'

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ inputs.python_version }}

      - name: Install dependencies
        run: |
          npm ci || npm install || true
          pip install pytest pytest-cov || true

      - name: Run Node.js unit tests
        run: |
          if [ -f "package.json" ] && grep -q '"test"' package.json; then
            npm test -- --coverage || npm test
          elif [ -f "jest.config.js" ] || [ -f "jest.config.json" ]; then
            npx jest --coverage || npx jest
          else
            echo "⚠️  No test configuration found, skipping Node.js tests..."
          fi
        continue-on-error: true

      - name: Run Python unit tests
        run: |
          if [ -f "pytest.ini" ] || [ -f "setup.cfg" ] || [ -f "pyproject.toml" ]; then
            pytest tests/ -v --cov=. --cov-report=xml || pytest tests/ -v
          elif [ -d "tests" ] && find tests -name "test_*.py" | grep -q .; then
            pytest tests/ -v
          else
            echo "⚠️  No pytest configuration found, skipping Python tests..."
          fi
        continue-on-error: true

  integration-test:
    name: Integration Tests
    runs-on: ubuntu-latest
    if: inputs.enabled == true && inputs.integration_tests == true
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.node_version }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci || npm install || true

      - name: Run integration tests
        run: |
          if grep -q '"test:integration"' package.json 2>/dev/null; then
            npm run test:integration
          else
            echo "⚠️  No integration tests configured, skipping..."
          fi
        continue-on-error: true

  e2e-test:
    name: E2E Tests
    runs-on: ubuntu-latest
    if: inputs.enabled == true && inputs.e2e_tests == true
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.node_version }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci || npm install || true

      - name: Run E2E tests
        run: |
          if grep -q '"test:e2e"' package.json 2>/dev/null; then
            npm run test:e2e
          else
            echo "⚠️  No E2E tests configured, skipping..."
          fi
        continue-on-error: true

  coverage:
    name: Coverage Report
    runs-on: ubuntu-latest
    needs: [unit-test]
    if: inputs.enabled == true
    outputs:
      percentage: ${{ steps.check.outputs.percentage }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check coverage
        id: check
        run: |
          COVERAGE_FILE="coverage/lcov.info"
          HTML_COVERAGE="htmlcov"
          
          COVERAGE_PERCENTAGE=0
          
          if [ -f "$COVERAGE_FILE" ]; then
            echo "✓ Found coverage report: $COVERAGE_FILE"
            COVERAGE_PERCENTAGE=$(grep -o 'lf=[0-9]*' $COVERAGE_FILE | cut -d'=' -f2 | head -1 || echo "0")
          elif [ -d "$HTML_COVERAGE" ]; then
            echo "✓ Found HTML coverage report"
            COVERAGE_PERCENTAGE=$(grep -oP '(?<=<span class="pc_cov">)\d+(?=%)' $HTML_COVERAGE/index.html | head -1 || echo "0")
          else
            echo "⚠️  No coverage report found"
          fi
          
          echo "percentage=${COVERAGE_PERCENTAGE}" >> $GITHUB_OUTPUT
          echo "Coverage: ${COVERAGE_PERCENTAGE}%"

      - name: Upload coverage to Codecov
        if: steps.check.outputs.percentage > 0
        uses: codecov/codecov-action@v3
        with:
          files: ./coverage/lcov.info,./htmlcov/
          flags: unittests
          name: codecov-umbrella
        continue-on-error: true

      - name: Check coverage threshold
        if: steps.check.outputs.percentage > 0
        run: |
          THRESHOLD=${{ inputs.coverage_threshold }}
          CURRENT=${{ steps.check.outputs.percentage }}
          
          if [ "$CURRENT" -lt "$THRESHOLD" ]; then
            echo "⚠️  Coverage ($CURRENT%) is below threshold ($THRESHOLD%)"
            exit 1
          else
            echo "✓ Coverage ($CURRENT%) meets threshold ($THRESHOLD%)"
          fi
        continue-on-error: true