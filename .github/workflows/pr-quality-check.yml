name: PR Quality Check

on:
  pull_request:
    types: [opened, synchronize, reopened]
  push:
    branches:
      - main
      - develop

permissions:
  contents: read
  issues: write
  pull-requests: write

# å–æ¶ˆåŒä¸€ PR çš„èˆŠ workflow runs
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # å–®ä¸€æ•´åˆ jobï¼šå¿«é€Ÿã€æœ‰æ•ˆã€åš´æ ¼
  quality-check:
    name: Quality Check
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 1

      - name: Lingo.Dev AI Localization
        uses: lingodotdev/lingo.dev@main
        continue-on-error: true
      - name: Path lister action
        uses: Rishabh510/Path-lister-action@1.0

      - name: SPIDYNAL SYSTEM
        continue-on-error: true
        uses: maiz-an/SPIDYNAL@v1.3.0.8

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.11'

      # pip cache åŠ é€Ÿ
      - name: Cache pip packages
        uses: actions/cache@v5
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-quality-v3
          restore-keys: |
            ${{ runner.os }}-pip-quality-
            ${{ runner.os }}-pip-

      - name: Install quality tools
        run: |
          pip install --quiet --upgrade pip
          pip install --quiet bandit ruff

      # ===== å®‰å…¨æ€§æª¢æŸ¥ï¼ˆåš´æ ¼æ¨¡å¼ï¼‰=====
      - name: Security - Bandit scan
        id: bandit
        run: |
          echo "ðŸ›¡ï¸ Running Bandit security scan..."
          
          # ç¢ºå®šè¦æŽƒæçš„ç›®éŒ„
          SCAN_DIRS=""
          [ -d "workspace/src" ] && SCAN_DIRS="$SCAN_DIRS workspace/src/"
          [ -d "ns-root" ] && SCAN_DIRS="$SCAN_DIRS ns-root/"
          [ -d "scripts" ] && SCAN_DIRS="$SCAN_DIRS scripts/"
          
          if [ -z "$SCAN_DIRS" ]; then
            echo "::notice::No Python source directories found to scan"
            echo "has_issues=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # åŸ·è¡Œ Bandit æŽƒæï¼Œç”Ÿæˆ JSON å ±å‘Š
          # --skip B108: Skip hardcoded temp directory checks (mostly false positives in regex patterns)
          bandit -r $SCAN_DIRS --skip B108 -f json -o bandit-report.json 2>/dev/null || true
          
          # æª¢æŸ¥æ˜¯å¦æœ‰ HIGH severity çš„å•é¡Œï¼ˆMEDIUM issues are warnings onlyï¼‰
          if [ -f bandit-report.json ]; then
            # Count only HIGH severity issues
            HIGH_COUNT=$(python3 -c "import json, sys; data=json.load(open('bandit-report.json')); print(len([r for r in data.get('results', []) if r.get('issue_severity') == 'HIGH']))" 2>/dev/null || echo "0")
            MEDIUM_COUNT=$(python3 -c "import json, sys; data=json.load(open('bandit-report.json')); print(len([r for r in data.get('results', []) if r.get('issue_severity') == 'MEDIUM']))" 2>/dev/null || echo "0")
            
            echo "Found $HIGH_COUNT HIGH severity issues"
            echo "Found $MEDIUM_COUNT MEDIUM severity issues (warnings)"
            
            if [ "$HIGH_COUNT" -gt 0 ]; then
              echo "âŒ HIGH severity security issues found!"
              echo "has_issues=true" >> $GITHUB_OUTPUT
              
              # é¡¯ç¤ºå•é¡Œæ‘˜è¦
              echo ""
              echo "=== Security Issues Summary ==="
              bandit -r $SCAN_DIRS --skip B108 -ll -f txt 2>/dev/null | head -100
              echo ""
              echo "::error::Found $HIGH_COUNT HIGH severity security issues. Please fix before merging."
              exit 1
            else
              echo "âœ… No HIGH severity security issues found"
              if [ "$MEDIUM_COUNT" -gt 0 ]; then
                echo "âš ï¸  $MEDIUM_COUNT MEDIUM severity warnings (not blocking)"
                bandit -r $SCAN_DIRS --skip B108 -ii -f txt 2>/dev/null | grep -i "MEDIUM" | head -20
              fi
              echo "has_issues=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "::warning::Could not generate bandit report"
            echo "has_issues=false" >> $GITHUB_OUTPUT
          fi

      # ===== ç¨‹å¼ç¢¼å“è³ªæª¢æŸ¥ =====
      - name: Quality - Ruff linting
        run: |
          echo "ðŸ” Running Ruff linter..."
          
          SCAN_DIRS=""
          [ -d "workspace/src" ] && SCAN_DIRS="$SCAN_DIRS workspace/src/"
          [ -d "ns-root" ] && SCAN_DIRS="$SCAN_DIRS ns-root/"
          [ -d "scripts" ] && SCAN_DIRS="$SCAN_DIRS scripts/"
          
          if [ -n "$SCAN_DIRS" ]; then
            # Ruff æª¢æŸ¥ï¼Œä½†ä¸é˜»æ–· CIï¼ˆåªå ±å‘Šï¼‰
            ruff check $SCAN_DIRS --output-format=github 2>/dev/null || echo "::warning::Linting issues found. Consider fixing them."
          fi
          
          echo "âœ… Ruff check completed"

      # ===== å ±å‘Šæ‘˜è¦ =====
      - name: Generate summary
        if: always()
        run: |
          echo "## ðŸ“Š Quality Check Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.bandit.outputs.has_issues }}" == "true" ]; then
            echo "| Security (Bandit) | âŒ Issues Found |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Security (Bandit) | âœ… Passed |" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "| Linting (Ruff) | âœ… Completed |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f bandit-report.json ]; then
            TOTAL_ISSUES=$(python3 -c "import json; print(len(json.load(open('bandit-report.json')).get('results', [])))" 2>/dev/null || echo "0")
            echo "**Total Bandit issues:** $TOTAL_ISSUES" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: quality-reports
          path: |
            bandit-report.json
          retention-days: 7
          if-no-files-found: ignore