name: "[L1-Security] Supply Chain Security (SBOM/SLSA/Cosign)"

# @GL-governed
# @GL-layer: GL10-29
# @GL-semantic: supply-chain-security
# @GL-audit-trail: ../../governance/GL_SEMANTIC_ANCHOR.json

on:
  push:
    branches:
      - main
      - develop
    paths:
      - "**/Dockerfile"
      - "**/go.mod"
      - "**/package.json"
  pull_request:
    paths:
      - "**/Dockerfile"
      - "**/go.mod"
      - "**/package.json"
  workflow_dispatch:
    inputs:
      image-ref:
        description: 'Image reference to scan'
        required: true
        type: string

permissions:
  contents: read
  packages: write
  id-token: write
  security-events: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  generate-sbom:
    name: Generate SBOM
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@8ade135a41bc03ea155e62e844d188df1ea18608
        with:
          fetch-depth: 0

      - name: Generate SBOM for Docker image
        uses: anchore/sbom-action@v0.14.3
        with:
          image: ${{ github.event.inputs.image-ref || 'ghcr.io/' + github.repository + ':latest' }}
          format: spdx-json
          output-file: sbom-docker.json
          upload-artifact: true

      - name: Generate SBOM for Go modules
        run: |
          go install github.com/anchore/syft/cmd/syft@latest
          syft . -o spdx-json > sbom-go.json

      - name: Generate SBOM for Node.js
        run: |
          npx @cyclonedx/cyclonedx-cli --version
          npx @cyclonedx/cyclonedx-cli scan --output-file sbom-nodejs.json --format json

      - name: Merge SBOMs
        run: |
          jq -s '.' sbom-docker.json sbom-go.json sbom-nodejs.json > sbom-combined.json

      - name: Upload SBOM artifacts
        uses: actions/upload-artifact@v3.1.2
        with:
          name: sbom-artifacts-${{ github.sha }}
          path: |
            sbom-*.json
          retention-days: 90

  generate-provenance:
    name: Generate SLSA Provenance
    needs: generate-sbom
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@8ade135a41bc03ea155e62e844d188df1ea18608

      - name: Download SBOM
        uses: actions/download-artifact@v3.0.2
        with:
          name: sbom-artifacts-${{ github.sha }}

      - name: Generate SLSA Level 3 Provenance
        uses: slsa-framework/slsa-github-generator@v1.9.0
        with:
          image: ${{ github.event.inputs.image-ref || 'ghcr.io/' + github.repository + ':latest' }}
          base64-slsa-provenance: ${{ github.sha }}

      - name: Upload provenance
        uses: actions/upload-artifact@v3.1.2
        with:
          name: provenance-artifacts-${{ github.sha }}
          path: |
            *.attestation
          retention-days: 365

  sign-artifacts:
    name: Sign with Cosign
    needs: [generate-sbom, generate-provenance]
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      packages: write
      contents: read
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@8ade135a41bc03ea155e62e844d188df1ea18608

      - name: Install Cosign
        uses: sigstore/cosign-installer@v3.1.1

      - name: Sign Docker image
        run: |
          cosign sign \
            --yes \
            --output-certificate=image.crt \
            --output-signature=image.sig \
            ghcr.io/${{ github.repository }}:${{ github.sha }}

      - name: Sign SBOM
        run: |
          cosign sign-blob \
            --yes \
            --output-certificate=sbom.crt \
            --output-signature=sbom.sig \
            sbom-combined.json

      - name: Sign provenance
        run: |
          cosign sign-blob \
            --yes \
            --output-certificate=provenance.crt \
            --output-signature=provenance.sig \
            *.attestation

      - name: Upload signatures
        uses: actions/upload-artifact@v3.1.2
        with:
          name: signature-artifacts-${{ github.sha }}
          path: |
            *.crt
            *.sig
          retention-days: 365

  verify-artifacts:
    name: Verify Artifacts
    needs: [sign-artifacts]
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@8ade135a41bc03ea155e62e844d188df1ea18608

      - name: Download artifacts
        uses: actions/download-artifact@v3.0.2
        with:
          path: artifacts

      - name: Install Cosign
        uses: sigstore/cosign-installer@v3.1.1

      - name: Verify Docker image signature
        run: |
          cosign verify \
            --certificate-identity "https://github.com/${{ github.repository }}/.github/workflows/supply-chain-security.yaml@${{ github.ref }}" \
            --certificate-oidc-issuer "https://token.actions.githubusercontent.com" \
            ghcr.io/${{ github.repository }}:${{ github.sha }}

      - name: Verify SBOM signature
        run: |
          cosign verify-blob \
            --certificate artifacts/signature-artifacts-${{ github.sha }}/sbom.crt \
            --signature artifacts/signature-artifacts-${{ github.sha }}/sbom.sig \
            artifacts/sbom-artifacts-${{ github.sha }}/sbom-combined.json

      - name: Generate verification report
        run: |
          cat <<EOF > verification-report.json
          {
            "timestamp": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")",
            "pipeline": "supply-chain-security",
            "verification": {
              "docker_image": "verified",
              "sbom": "verified",
              "provenance": "verified"
            },
            "status": "success"
          }
          EOF

      - name: Upload verification report
        uses: actions/upload-artifact@v3.1.2
        with:
          name: verification-report-${{ github.sha }}
          path: verification-report.json
          retention-days: 365

  scan-dependencies:
    name: Scan Dependencies for Vulnerabilities
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@8ade135a41bc03ea155e62e844d188df1ea18608

      - name: Run Grype vulnerability scanner
        uses: anchore/grype-action@v0.14.0
        with:
          image: ${{ github.event.inputs.image-ref || 'ghcr.io/' + github.repository + ':latest' }}
          format: json
          output: grype-report.json
          severity: CRITICAL,HIGH,MEDIUM

      - name: Upload Grype report
        uses: actions/upload-artifact@v3.1.2
        with:
          name: grype-report-${{ github.sha }}
          path: grype-report.json
          retention-days: 90

      - name: Upload results to GitHub Security
        if: github.event_name == 'pull_request'
        uses: github/codeql-action/upload-sarif@v2.14.4
        with:
          sarif_file: grype-report.json
          category: grype