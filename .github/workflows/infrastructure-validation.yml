name: Infrastructure Validation

on:
  push:
    branches: [ main, develop, 'copilot/**' ]
    paths:
      - 'controlplane/**'
      - 'scripts/validate-infrastructure.sh'
      - '.github/workflows/infrastructure-validation.yml'
  pull_request:
    branches: [ main ]
    paths:
      - 'controlplane/**'
      - 'scripts/validate-infrastructure.sh'
      - '.github/workflows/infrastructure-validation.yml'
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  validate-infrastructure:
    name: Validate Infrastructure
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyyaml jsonschema
          echo "‚úÖ Dependencies installed successfully"

      - name: Run infrastructure validation
        id: validation
        run: |
          echo "üîç Starting infrastructure validation..."
          
          # Retry logic for transient failures
          max_retries=3
          retry_count=0
          
          while [ $retry_count -lt $max_retries ]; do
            echo "Attempt $((retry_count + 1)) of $max_retries"
            
            if chmod +x scripts/validate-infrastructure.sh && ./scripts/validate-infrastructure.sh; then
              echo "‚úÖ Validation passed on attempt $((retry_count + 1))"
              exit 0
            else
              retry_count=$((retry_count + 1))
              if [ $retry_count -lt $max_retries ]; then
                echo "‚ö†Ô∏è Validation failed, retrying in 5 seconds..."
                sleep 5
              fi
            fi
          done
          
          echo "‚ùå Validation failed after $max_retries attempts"
          exit 1
        env:
          PYTHONUNBUFFERED: 1

      - name: Validation summary
        if: always()
        run: |
          echo "==================================="
          echo "Validation Outcome Summary"
          echo "==================================="
          echo "Validation Step: ${{ steps.validation.outcome }}"
          
          if [ "${{ steps.validation.outcome }}" == "success" ]; then
            echo "‚úÖ Infrastructure validation passed successfully"
            echo "All module manifests, policies, and dependencies are valid"
          else
            echo "‚ùå Infrastructure validation failed"
            echo "Please review the logs above for details"
            echo "Common issues:"
            echo "  - YAML syntax errors in module manifests"
            echo "  - Missing or invalid dependencies"
            echo "  - Missing Python dependencies (pyyaml, jsonschema)"
            exit 1
          fi

  validate-modules:
    name: Validate Module Manifests
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install pyyaml jsonschema

      - name: Validate module manifests against schema
        run: |
          python3 scripts/validate-module-manifests.py

  validate-policies:
    name: Validate OPA Policies
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup OPA
        uses: open-policy-agent/setup-opa@v2
        with:
          version: v0.60.0

      - name: Validate Rego policies
        run: |
          echo "Validating OPA/Rego policies..."
          POLICIES_DIR="controlplane/governance/policies"
          
          for policy in naming semantic security autonomy; do
            policy_file="$POLICIES_DIR/${policy}.rego"
            if [ -f "$policy_file" ]; then
              echo "Checking $policy.rego..."
              opa check "$policy_file"
              if [ $? -eq 0 ]; then
                echo "‚úÖ $policy.rego: Syntax valid"
              else
                echo "‚ùå $policy.rego: Syntax error"
                exit 1
              fi
            else
              echo "‚ö†Ô∏è  $policy.rego: File not found"
            fi
          done
          
          echo ""
          echo "‚úÖ All policies validated successfully!"

      - name: Test policies with sample data
        run: |
          echo "Testing policies with sample data..."
          
          # Test naming policy
          echo '{"resource": {"type": "file", "name": "test-file.yaml"}}' | opa eval -d controlplane/governance/policies/naming.rego 'data.mno.governance.policies.naming.allow' -I
          
          echo "‚úÖ Policy tests completed!"

  validate-registry:
    name: Validate Module Registry
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install pyyaml

      - name: Validate module registry
        run: |
          python3 scripts/validate-module-registry.py

  summary:
    name: Validation Summary
    runs-on: ubuntu-latest
    needs: [validate-infrastructure, validate-modules, validate-policies, validate-registry]
    if: always()
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install pyyaml

      - name: Generate governance dashboard
        run: |
          python3 scripts/generate-governance-dashboard.py
          echo "‚úÖ Governance dashboard generated"

      - name: Generate DAG visualization
        run: |
          python3 scripts/generate-dag-visualization.py
          echo "‚úÖ DAG visualization generated"

      - name: Check validation results
        run: |
          echo "Infrastructure Validation Results:"
          echo "=================================="
          echo "Infrastructure: ${{ needs.validate-infrastructure.result }}"
          echo "Modules: ${{ needs.validate-modules.result }}"
          echo "Policies: ${{ needs.validate-policies.result }}"
          echo "Registry: ${{ needs.validate-registry.result }}"
          echo ""
          
          if [ "${{ needs.validate-infrastructure.result }}" == "success" ] && \
             [ "${{ needs.validate-modules.result }}" == "success" ] && \
             [ "${{ needs.validate-policies.result }}" == "success" ] && \
             [ "${{ needs.validate-registry.result }}" == "success" ]; then
            echo "‚úÖ All infrastructure validations passed!"
            echo "‚úÖ Dashboards generated successfully!"
            exit 0
          else
            echo "‚ùå Some validations failed. Please review the logs above."
            exit 1
          fi
