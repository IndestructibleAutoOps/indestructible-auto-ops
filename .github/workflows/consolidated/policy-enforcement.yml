name: 'Policy Enforcement'

on:
  pull_request:
    types: [opened, synchronize, reopened]
  push:
    branches: [main]
  workflow_dispatch:

concurrency:
  group: 'policy-enforcement-${{ github.ref }}'
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: write

jobs:
  naming-compliance:
    name: Naming Convention Compliance
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4.0.2
      
      - name: Install OPA
        run: |
          wget https://github.com/open-policy-agent/opa/releases/download/v0.59.0/opa_linux_amd64
          chmod +x opa_linux_amd64
          sudo mv opa_linux_amd64 /usr/local/bin/opa
      
      - name: Check naming conventions
        run: |
          # Check Kubernetes resource names
          find . -type f \( -name "*.yaml" -o -name "*.yml" \) -path "*/kubernetes/*" -o -path "*/infrastructure/*" | while read file; do
            echo "Checking $file..."
            # Extract resource names
            NAMES=$(grep -E "name: [a-z-]+" "$file" | awk '{print $2}')
            
            for name in $NAMES; do
              # Check naming pattern: ^(dev|staging|prod)-[a-z0-9-]+-(deploy|svc|ing|cm|secret)-v\d+\.\d+\.\d+(-[A-Za-z0-9]+)?$
              if [[ ! $name =~ ^(dev|staging|prod)-[a-z0-9]+-(deploy|svc|ing|cm|secret)-v[0-9]+\.[0-9]+\.[0-9]+ ]]; then
                echo "⚠️  Warning: '$name' does not follow naming convention"
              fi
            done
          done
      
      - name: Report naming violations
        if: failure()
        run: |
          echo "❌ Naming convention violations found"
          echo "Please follow the naming pattern: <env>-<service>-<type>-v<version>"
          exit 1

  policy-validation:
    name: OPA Policy Validation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4.0.2
      
      - uses: ./.github/actions/setup-build-environment
      
      - name: Install Conftest
        run: |
          wget https://github.com/open-policy-agent/conftest/releases/download/v0.49.0/conftest_0.49.0_Linux_x86_64.tar.gz
          tar xzf conftest_0.49.0_Linux_x86_64.tar.gz
          sudo mv conftest /usr/local/bin/
      
      - name: Verify policies
        run: |
          conftest verify .governance/policies/
      
      - name: Test against policies
        run: |
          conftest test . --policy .governance/policies/ --fail-on-warn --output json
      
      - name: Comment violations on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7.0.1
        with:
          script: |
            const fs = require('fs');
            const violations = JSON.parse(fs.readFileSync('conftest-results.json', 'utf8'));
            
            if (violations.length > 0) {
              const body = violations.map(v => 
                `❌ ${v.filename}\n${v.failures.map(f => `- ${f.message}`).join('\n')}`
              ).join('\n\n');
              
              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: body
              });
            }

  conftest-check:
    name: Conftest Policy Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4.0.2
      
      - name: Run Conftest on all YAML files
        uses: ./.github/actions/policy-check
        with:
          files-to-check: '.'
          policy-path: '.governance/policies'
          strict-mode: 'true'

  kubernetes-policy-check:
    name: Kubernetes Policy Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4.0.2
      
      - name: Install kube-bench
        run: |
          wget https://github.com/aquasecurity/kube-bench/releases/download/v0.7.3/kube-bench_0.7.3_linux_amd64.deb
          sudo dpkg -i kube-bench_0.7.3_linux_amd64.deb
      
      - name: Install Checkov
        run: |
          pip install checkov
      
      - name: Run Checkov on Kubernetes manifests
        run: |
          checkov -f infrastructure/kubernetes/ --framework kubernetes --compact --quiet
      
      - name: Install Kubeaudit
        run: |
          wget https://github.com/Shopify/kubeaudit/releases/download/v0.21.2/kubeaudit_0.21.2_linux_amd64
          chmod +x kubeaudit_0.21.2_linux_amd64
          sudo mv kubeaudit_0.21.2_linux_amd64 /usr/local/bin/kubeaudit
      
      - name: Run Kubeaudit
        run: |
          kubeaudit all -f infrastructure/kubernetes/ --exit-code 0

  security-policy-check:
    name: Security Policy Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4.0.2
      
      - name: Run Gitleaks
        uses: gitleaks/gitleaks-action@v2.3.1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_LICENSE: ${{ secrets.GITLEAKS_LICENSE }}
      
      - name: Run Semgrep
        uses: returntocorp/semgrep-action@v1.7.0
        with:
          config: auto
      
      - name: Run CodeQL
        uses: github/codeql-action/analyze@v3.22.11
        with:
          languages: python, javascript, go

  report:
    name: Generate Policy Report
    needs: [naming-compliance, policy-validation, conftest-check, kubernetes-policy-check, security-policy-check]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Generate summary
        run: |
          echo "## Policy Enforcement Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Check Results" >> $GITHUB_STEP_SUMMARY
          echo "- Naming Compliance: ${{ needs.naming-compliance.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- OPA Policy Validation: ${{ needs.policy-validation.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Conftest Check: ${{ needs.conftest-check.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Kubernetes Policy Check: ${{ needs.kubernetes-policy-check.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Security Policy Check: ${{ needs.security-policy-check.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.naming-compliance.result }}" = "success" ] && \
             [ "${{ needs.policy-validation.result }}" = "success" ] && \
             [ "${{ needs.conftest-check.result }}" = "success" ] && \
             [ "${{ needs.kubernetes-policy-check.result }}" = "success" ] && \
             [ "${{ needs.security-policy-check.result }}" = "success" ]; then
            echo "✅ All policy checks passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ Some policy checks failed - please review" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi