name: "[L1-Security] IaC Security Scan (Checkov)"

# @GL-governed
# @GL-layer: GL10-29
# @GL-semantic: checkov-iac-scan
# @GL-audit-trail: ../../governance/GL_SEMANTIC_ANCHOR.json

on:
  pull_request:
    paths:
      - "**/*.tf"
      - "**/*.yaml"
      - "**/*.yml"
      - "deploy/**"
      - "infrastructure/**"
      - ".github/workflows/checkov-scan.yaml"
  push:
    branches:
      - main
      - develop
    paths:
      - "**/*.tf"
      - "**/*.yaml"
      - "**/*.yml"
      - "deploy/**"
      - "infrastructure/**"
      - ".github/workflows/checkov-scan.yaml"
  schedule:
    - cron: "0 3 * * 1"  # Every Monday at 3 AM UTC
  workflow_dispatch:

permissions:
  contents: read
  security-events: write
  pull-requests: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  checkov-scan:
    name: Run Checkov IaC Scan
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@8ade135a41bc03ea155e62e844d188df1ea18608

      - name: Run Checkov
        id: checkov
        uses: bridgecrewio/checkov-action@master
        with:
          directory: .
          framework: kubernetes,terraform,cloudformation
          output-format: json,sarif
          output-file-path: checkov-report.json,checkov-report.sarif
          soft-fail: false
          download-external-modules: true
          config-file: .checkov.yaml

      - name: Parse Checkov results
        id: parse
        run: |
          if [ -f checkov-report.json ]; then
            TOTAL_CHECKS=$(jq '.summary.failed + .summary.passed + .summary.skipped' checkov-report.json)
            FAILED_CHECKS=$(jq '.summary.failed' checkov-report.json)
            PASSED_CHECKS=$(jq '.summary.passed' checkov-report.json)
            
            echo "total_checks=$TOTAL_CHECKS" >> $GITHUB_OUTPUT
            echo "failed_checks=$FAILED_CHECKS" >> $GITHUB_OUTPUT
            echo "passed_checks=$PASSED_CHECKS" >> $GITHUB_OUTPUT
            
            # Count by severity
            CRITICAL=$(jq '.results.failed.checks[] | select(.severity | ascii_downcase == "critical") | length' checkov-report.json)
            HIGH=$(jq '.results.failed.checks[] | select(.severity | ascii_downcase == "high") | length' checkov-report.json)
            MEDIUM=$(jq '.results.failed.checks[] | select(.severity | ascii_downcase == "medium") | length' checkov-report.json)
            LOW=$(jq '.results.failed.checks[] | select(.severity | ascii_downcase == "low") | length' checkov-report.json)
            
            echo "critical=$CRITICAL" >> $GITHUB_OUTPUT
            echo "high=$HIGH" >> $GITHUB_OUTPUT
            echo "medium=$MEDIUM" >> $GITHUB_OUTPUT
            echo "low=$LOW" >> $GITHUB_OUTPUT
          fi

      - name: Upload Checkov artifacts
        if: always()
        uses: actions/upload-artifact@v3.1.2
        with:
          name: checkov-results-${{ github.sha }}
          path: |
            checkov-report.json
            checkov-report.sarif
          retention-days: 30

      - name: Upload results to GitHub Security
        if: always() && github.event_name == 'pull_request'
        uses: github/codeql-action/upload-sarif@v2.14.4
        with:
          sarif_file: checkov-report.sarif
          category: checkov

      - name: Comment PR with results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7.0.1
        with:
          script: |
            const failed = ${{ steps.parse.outputs.failed_checks || 0 }};
            const passed = ${{ steps.parse.outputs.passed_checks || 0 }};
            const critical = ${{ steps.parse.outputs.critical || 0 }};
            const high = ${{ steps.parse.outputs.high || 0 }};
            const medium = ${{ steps.parse.outputs.medium || 0 }};
            const low = ${{ steps.parse.outputs.low || 0 }};
            
            let comment = `## üîç Checkov IaC Security Scan Results\n\n`;
            comment += `| Severity | Count |\n`;
            comment += `|----------|-------|\n`;
            comment += `| üî¥ Critical | ${critical} |\n`;
            comment += `| üü† High | ${high} |\n`;
            comment += `| üü° Medium | ${medium} |\n`;
            comment += `| üü¢ Low | ${low} |\n`;
            comment += `| ‚úÖ Passed | ${passed} |\n\n`;
            
            const total = failed + passed;
            const complianceRate = total > 0 ? Math.round((passed / total) * 100) : 0;
            comment += `### Compliance Rate\n\n`;
            comment += `${complianceRate}%\n\n`;
            
            if (failed > 0) {
              comment += `### ‚ö†Ô∏è Security Issues Found\n\n`;
              comment += `Found ${failed} security issue(s) that need attention.\n\n`;
              comment += `### üîß Top Issues\n\n`;
              comment += `Please review the full report in the workflow artifacts for detailed remediation steps.\n\n`;
            } else {
              comment += `### ‚úÖ No Security Issues Found\n\n`;
              comment += `All checks passed successfully.\n\n`;
            }
            
            comment += `---\n\n`;
            comment += `**Policy Enforcement**: This scan enforces GL Unified Charter v5.0 security policies.\n`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      - name: Push metrics to Prometheus
        if: always()
        run: |
          FAILED=${{ steps.parse.outputs.failed_checks || 0 }}
          PASSED=${{ steps.parse.outputs.passed_checks || 0 }}
          CRITICAL=${{ steps.parse.outputs.critical || 0 }}
          HIGH=${{ steps.parse.outputs.high || 0 }}
          
          cat <<EOF | curl --data-binary @- http://${{ secrets.PROMETHEUS_PUSHGATEWAY }}/metrics/job/checkov/instance/${{ github.run_number }}
            # HELP checkov_fails_total Total number of failed Checkov checks
            # TYPE checkov_fails_total gauge
            checkov_fails_total{repo="${{ github.repository }}"} $FAILED
            
            # HELP checkov_critical_total Total number of critical severity findings
            # TYPE checkov_critical_total gauge
            checkov_critical_total{repo="${{ github.repository }}"} $CRITICAL
            
            # HELP checkov_high_total Total number of high severity findings
            # TYPE checkov_high_total gauge
            checkov_high_total{repo="${{ github.repository }}"} $HIGH
            
            # HELP checkov_compliance_rate Compliance rate for IaC security checks
            # TYPE checkov_compliance_rate gauge
            checkov_compliance_rate{repo="${{ github.repository }}"} $(( (PASSED * 100) / (FAILED + PASSED) ))
          EOF

      - name: Fail on critical findings
        if: steps.parse.outputs.critical > '0'
        run: |
          echo "‚ùå Critical security findings detected"
          exit 1