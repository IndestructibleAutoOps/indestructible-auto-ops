# @GL-governed
# @GL-layer: CI/CD
# @GL-semantic: workflow-validation
# @GL-audit-trail: ../../engine/governance/GL_SEMANTIC_ANCHOR.json
#
# GL Unified Charter Activated
name: Combined CI Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

env:
  NODE_VERSION: '20.x'
  PYTHON_VERSION: '3.11'
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # Parse configuration
  parse-config:
    name: Parse Configuration
    runs-on: ubuntu-latest
    outputs:
      linting_enabled: ${{ steps.config.outputs.linting_enabled }}
      testing_enabled: ${{ steps.config.outputs.testing_enabled }}
      building_enabled: ${{ steps.config.outputs.building_enabled }}
      security_enabled: ${{ steps.config.outputs.security_enabled }}
      deployment_enabled: ${{ steps.config.outputs.deployment_enabled }}
      staging_enabled: ${{ steps.config.outputs.staging_enabled }}
      production_enabled: ${{ steps.config.outputs.production_enabled }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Parse config
        id: config
        run: |
          # Read configuration from config.yml
          if [ -f ".github/workflows/config.yml" ]; then
            echo "✓ Configuration file found"
            
            # Parse configuration (simplified - in production use a proper YAML parser)
            LINTING=$(grep -A2 "core:" .github/workflows/config.yml | grep "linting" | awk '{print $2}' || echo "true")
            TESTING=$(grep -A2 "core:" .github/workflows/config.yml | grep "testing" | awk '{print $2}' || echo "true")
            BUILDING=$(grep -A2 "core:" .github/workflows/config.yml | grep "building" | awk '{print $2}' || echo "true")
            
            SECURITY=$(grep -A5 "optional:" .github/workflows/config.yml | grep -A1 "security:" | grep "enabled" | awk '{print $2}' || echo "true")
            DEPLOYMENT=$(grep -A5 "optional:" .github/workflows/config.yml | grep -A1 "deployment:" | grep "enabled" | awk '{print $2}' || echo "true")
            
            STAGING=$(grep -A3 "staging:" .github/workflows/config.yml | grep "enabled" | awk '{print $2}' || echo "true")
            PRODUCTION=$(grep -A3 "production:" .github/workflows/config.yml | grep "enabled" | awk '{print $2}' || echo "true")
          else
            echo "⚠️  No configuration file found, using defaults"
            LINTING="true"
            TESTING="true"
            BUILDING="true"
            SECURITY="true"
            DEPLOYMENT="true"
            STAGING="true"
            PRODUCTION="true"
          fi
          
          echo "linting_enabled=${LINTING}" >> $GITHUB_OUTPUT
          echo "testing_enabled=${TESTING}" >> $GITHUB_OUTPUT
          echo "building_enabled=${BUILDING}" >> $GITHUB_OUTPUT
          echo "security_enabled=${SECURITY}" >> $GITHUB_OUTPUT
          echo "deployment_enabled=${DEPLOYMENT}" >> $GITHUB_OUTPUT
          echo "staging_enabled=${STAGING}" >> $GITHUB_OUTPUT
          echo "production_enabled=${PRODUCTION}" >> $GITHUB_OUTPUT
          
          echo "Configuration:"
          echo "  Linting: ${LINTING}"
          echo "  Testing: ${TESTING}"
          echo "  Building: ${BUILDING}"
          echo "  Security: ${SECURITY}"
          echo "  Deployment: ${DEPLOYMENT}"
          echo "  Staging: ${STAGING}"
          echo "  Production: ${PRODUCTION}"

  # Linting Module
  lint:
    name: Lint Code
    uses: ./.github/workflows/modules/lint-module.yml
    needs: parse-config
    if: needs.parse-config.outputs.linting_enabled == 'true'
    with:
      node_version: '20.x'
      python_version: '3.11'
      enabled: true

  # Testing Module
  test:
    name: Run Tests
    uses: ./.github/workflows/modules/test-module.yml
    needs: [parse-config, lint]
    if: needs.parse-config.outputs.testing_enabled == 'true'
    with:
      node_version: '20.x'
      python_version: '3.11'
      enabled: true
      coverage_threshold: 80
      unit_tests: true
      integration_tests: true
      e2e_tests: false

  # Build Module
  build:
    name: Build Application
    uses: ./.github/workflows/modules/build-module.yml
    needs: [parse-config, test]
    if: needs.parse-config.outputs.building_enabled == 'true'
    with:
      node_version: '20.x'
      enabled: true
      build_artifacts: true
      docker_build: false

  # Security Module
  security:
    name: Security Scan
    uses: ./.github/workflows/modules/security-module.yml
    needs: [parse-config, build]
    if: needs.parse-config.outputs.security_enabled == 'true'
    with:
      enabled: true
      sast_scan: true
      dependency_scan: true
      container_scan: false
      codeql_analysis: true
      secret_scan: true
      snyk_enabled: false

  # Notification - CI Complete
  notify-ci:
    name: Notify CI Complete
    uses: ./.github/workflows/modules/notification-module.yml
    needs: [parse-config, lint, test, build, security]
    if: always()
    with:
      enabled: false  # Disabled by default
      slack_enabled: false
      event_type: "CI Pipeline Complete"
      status: ${{ needs.test.result }}
      message: |
        Results:
        - Lint: ${{ needs.lint.result }}
        - Test: ${{ needs.test.result }}
        - Build: ${{ needs.build.result }}
        - Security: ${{ needs.security.result }}

  # Deploy to Staging
  deploy-staging:
    name: Deploy to Staging
    uses: ./.github/workflows/modules/deploy-module.yml
    needs: [parse-config, security]
    if: |
      always() &&
      needs.parse-config.outputs.staging_enabled == 'true' &&
      needs.parse-config.outputs.deployment_enabled == 'true' &&
      github.ref == 'refs/heads/develop' &&
      (needs.security.result == 'success' || needs.security.result == 'skipped')
    with:
      environment: staging
      deployment_target: local  # Default to local, can be changed to ssh/docker/kubernetes/aws-ecs
      enabled: true
      blue_green: false
      require_approval: false
      skip_health_check: false
      rollback_on_failure: true

  # Deploy to Production
  deploy-production:
    name: Deploy to Production
    uses: ./.github/workflows/modules/deploy-module.yml
    needs: [parse-config, security]
    if: |
      always() &&
      needs.parse-config.outputs.production_enabled == 'true' &&
      needs.parse-config.outputs.deployment_enabled == 'true' &&
      github.ref == 'refs/heads/main' &&
      (needs.security.result == 'success' || needs.security.result == 'skipped')
    with:
      environment: production
      deployment_target: local  # Default to local, can be changed to ssh/docker/kubernetes/aws-ecs
      enabled: true
      blue_green: true  # Enable blue-green for production
      require_approval: true
      skip_health_check: false
      rollback_on_failure: true

  # Notification - Deployment Complete
  notify-deployment:
    name: Notify Deployment
    uses: ./.github/workflows/modules/notification-module.yml
    needs: [deploy-staging, deploy-production]
    if: always()
    with:
      enabled: false  # Disabled by default
      slack_enabled: false
      event_type: "Deployment Complete"
      status: ${{ needs.deploy-production.result || needs.deploy-staging.result }}
      message: |
        Deployment to ${{ github.ref_name }} completed
        Staging: ${{ needs.deploy-staging.result }}
        Production: ${{ needs.deploy-production.result }}