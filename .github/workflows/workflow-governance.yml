# @GL-governed
# @GL-layer: GL90-99
# @GL-semantic: governance-core
# @GL-audit-trail: gl-platform-universe/governance/audit-trails/GL90_99-audit.json
#
# GL Unified Charter Activated
# GL Root Semantic Anchor: gl-platform-universe/governance/GL-ROOT-SEMANTIC-ANCHOR.yaml
# GL Unified Naming Charter: gl-platform-universe/governance/GL-UNIFIED-NAMING-CHARTER.yaml


name: 'Workflow Governance Check'

on:
  pull_request:
    paths:
      - '.github/workflows/**'
  push:
    branches: [main]
    paths:
      - '.github/workflows/**'

jobs:
  validate-workflows:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4.0.2
        with:
          fetch-depth: 0
      
      - name: Check workflow count
        run: |
          WORKFLOW_COUNT=$(find .github/workflows -name '*.yml' -o -name '*.yaml' | wc -l)
          echo "Current workflow count: $WORKFLOW_COUNT"
          if [ $WORKFLOW_COUNT -gt 50 ]; then
            echo "❌ Error: Too many workflows ($WORKFLOW_COUNT > 50)"
            echo "Please consolidate workflows before adding new ones"
            exit 1
          fi
          echo "✅ Workflow count within limit ($WORKFLOW_COUNT ≤ 50)"
      
      - name: Check workflow size
        run: |
          for workflow in .github/workflows/*.yml .github/workflows/*.yaml; do
            if [ -f "$workflow" ]; then
              LINES=$(wc -l < "$workflow")
              if [ $LINES -gt 300 ]; then
                echo "❌ Error: $workflow too large ($LINES lines > 300)"
                echo "Please break it down into smaller, reusable components"
                exit 1
              fi
            fi
          done
          echo "✅ All workflows within size limit (≤ 300 lines)"
      
      - name: Check for pinned SHAs
        run: |
          echo "Checking for unpinned action versions..."
          UNPINNED=$(grep -r "uses:.*@" .github/workflows/*.yml .github/workflows/*.yaml 2>/dev/null | grep -v "@[a-f0-9]\{40\}" | grep -v "github.com/machine-native-ops" || true)
          if [ -n "$UNPINNED" ]; then
            echo "❌ Error: Found unpinned actions:"
            echo "$UNPINNED"
            exit 1
          fi
          echo "✅ All actions use pinned SHAs"
      
      - name: Check for minimum permissions
        run: |
          echo "Checking for overly permissive workflows..."
          OVERLY_PERMISSIVE=$(grep -r "permissions:.*write-all\|permissions:.*write:.*contents:.*write:.*issues:.*write:.*pull-requests:.*write" .github/workflows/*.yml .github/workflows/*.yaml 2>/dev/null || true)
          if [ -n "$OVERLY_PERMISSIVE" ]; then
            echo "⚠️  Warning: Found workflows with write-all or excessive permissions:"
            echo "$OVERLY_PERMISSIVE"
            echo "Please review and minimize permissions"
          else
            echo "✅ No overly permissive workflows found"
          fi
      
      - name: Check for concurrency
        run: |
          echo "Checking for concurrency configuration..."
          NO_CONCURRENCY=$(grep -L "concurrency:" .github/workflows/*.yml .github/workflows/*.yaml 2>/dev/null || true)
          if [ -n "$NO_CONCURRENCY" ]; then
            echo "⚠️  Warning: Some workflows lack concurrency configuration:"
            echo "$NO_CONCURRENCY"
            echo "Consider adding concurrency to prevent duplicate runs"
          else
            echo "✅ All workflows have concurrency configured"
          fi
      
      - name: Generate workflow summary
        run: |
          echo "## Workflow Governance Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "✅ All governance checks passed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Statistics" >> $GITHUB_STEP_SUMMARY
          echo "- Workflow count: $(find .github/workflows -name '*.yml' -o -name '*.yaml' | wc -l)" >> $GITHUB_STEP_SUMMARY
          echo "- Average size: $(find .github/workflows -name '*.yml' -o -name '*.yaml' -exec wc -l {} \; | awk '{sum+=$1; count++} END {print int(sum/count)} lines')" >> $GITHUB_STEP_SUMMARY