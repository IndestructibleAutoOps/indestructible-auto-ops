name: "[L1-Auto] Automatic Fix Bot"

# @GL-governed
# @GL-layer: GL10-29
# @GL-semantic: auto-fix-bot
# @GL-audit-trail: ../../governance/GL_SEMANTIC_ANCHOR.json

on:
  schedule:
    - cron: "0 */6 * * *"  # Every 6 hours
  workflow_dispatch:
    inputs:
      fix-type:
        description: 'Type of fix to apply'
        required: true
        type: choice
        options:
          - all
          - naming
          - security
          - lint
          - dependencies
      dry-run:
        description: 'Dry run mode'
        type: boolean
        default: true

permissions:
  contents: write
  pull-requests: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  detect-issues:
    name: Detect Issues
    runs-on: ubuntu-latest
    outputs:
      naming-issues: ${{ steps.detect.outputs.naming }}
      security-issues: ${{ steps.detect.outputs.security }}
      lint-issues: ${{ steps.detect.outputs.lint }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@8ade135a41bc03ea155e62e844d188df1ea18608
        with:
          fetch-depth: 0

      - name: Detect naming issues
        id: naming
        run: |
          conftest test \
            --policy .config/conftest/policies/ \
            --output json \
            deploy/ > naming-issues.json 2>&1 || true
          
          NAMING_ISSUES=$(jq '[.[] | select(.failures != [])] | length' naming-issues.json 2>/dev/null || echo 0)
          echo "count=$NAMING_ISSUES" >> $GITHUB_OUTPUT
          echo "naming=$NAMING_ISSUES" >> $GITHUB_OUTPUT

      - name: Detect security issues
        id: security
        run: |
          trivy fs \
            --format json \
            --output trivy-report.json \
            . || true
          
          SECURITY_ISSUES=$(jq '.Results | length' trivy-report.json 2>/dev/null || echo 0)
          echo "count=$SECURITY_ISSUES" >> $GITHUB_OUTPUT
          echo "security=$SECURITY_ISSUES" >> $GITHUB_OUTPUT

      - name: Detect lint issues
        id: lint
        run: |
          npm ci
          npm run lint -- --format json --output-file eslint-report.json || true
          
          LINT_ISSUES=$(jq '.[].errorCount' eslint-report.json | add 2>/dev/null || echo 0)
          echo "count=$LINT_ISSUES" >> $GITHUB_OUTPUT
          echo "lint=$LINT_ISSUES" >> $GITHUB_OUTPUT

      - name: Upload detection results
        uses: actions/upload-artifact@v3.1.2
        with:
          name: detection-results-${{ github.sha }}
          path: |
            naming-issues.json
            trivy-report.json
            eslint-report.json
          retention-days: 7

  apply-fixes:
    name: Apply Fixes
    needs: detect-issues
    runs-on: ubuntu-latest
    if: |
      (github.event.inputs.fix-type == 'all' || github.event.inputs.fix-type == 'naming') && needs.detect-issues.outputs.naming-issues > 0 ||
      (github.event.inputs.fix-type == 'all' || github.event.inputs.fix-type == 'security') && needs.detect-issues.outputs.security-issues > 0 ||
      (github.event.inputs.fix-type == 'all' || github.event.inputs.fix-type == 'lint') && needs.detect-issues.outputs.lint-issues > 0
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@8ade135a41bc03ea155e62e844d188df1ea18608

      - name: Download detection results
        uses: actions/download-artifact@v3.0.2
        with:
          name: detection-results-${{ github.sha }}

      - name: Apply naming fixes
        if: (github.event.inputs.fix-type == 'all' || github.event.inputs.fix-type == 'naming') && needs.detect-issues.outputs.naming-issues > 0
        run: |
          node scripts/auto-fix/naming-fixer.js \
            --input naming-issues.json \
            --output artifacts/reports/auto-fix/naming-fixes.json \
            --dry-run ${{ github.event.inputs.dry-run || 'true' }}

      - name: Apply security fixes
        if: (github.event.inputs.fix-type == 'all' || github.event.inputs.fix-type == 'security') && needs.detect-issues.outputs.security-issues > 0
        run: |
          node scripts/auto-fix/security-fixer.js \
            --input trivy-report.json \
            --output artifacts/reports/auto-fix/security-fixes.json \
            --dry-run ${{ github.event.inputs.dry-run || 'true' }}

      - name: Apply lint fixes
        if: (github.event.inputs.fix-type == 'all' || github.event.inputs.fix-type == 'lint') && needs.detect-issues.outputs.lint-issues > 0
        run: |
          npm run lint:fix

      - name: Update dependencies
        if: github.event.inputs.fix-type == 'all' || github.event.inputs.fix-type == 'dependencies'
        run: |
          npx npm-check-updates -u
          npm ci
          npm audit fix

      - name: Generate fix summary
        id: summary
        run: |
          node scripts/auto-fix/generate-summary.js \
            --output artifacts/reports/auto-fix/summary.md

      - name: Upload fix artifacts
        uses: actions/upload-artifact@v3.1.2
        with:
          name: fix-artifacts-${{ github.sha }}
          path: artifacts/reports/auto-fix/
          retention-days: 30

      - name: Create Pull Request
        if: github.event.inputs.dry-run != 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "ðŸ”§ [Auto-fix] Apply automatic fixes"
          title: "ðŸ”§ [Auto-fix] Apply automatic fixes"
          body: |
            ## Automatic Fixes Applied
            
            This PR was automatically generated by the Auto-Fix Bot.
            
            ### Summary
            $(cat artifacts/reports/auto-fix/summary.md)
            
            ### Details
            - Naming fixes: ${{ needs.detect-issues.outputs.naming-issues }}
            - Security fixes: ${{ needs.detect-issues.outputs.security-issues }}
            - Lint fixes: ${{ needs.detect-issues.outputs.lint-issues }}
            
            ### Verification
            Please review the changes and ensure they are correct before merging.
            
            ### Risk Assessment
            - Low risk: Automatic fixes have been tested
            - Rollback: Can be easily reverted if needed
          branch: auto-fix/${{ github.run_number }}
          labels: |
            auto-fix
            automated
          draft: false

      - name: Report results
        run: |
          echo "Auto-fix completed successfully"
          echo "Naming fixes: ${{ needs.detect-issues.outputs.naming-issues }}"
          echo "Security fixes: ${{ needs.detect-issues.outputs.security-issues }}"
          echo "Lint fixes: ${{ needs.detect-issues.outputs.lint-issues }}"

  validate-fixes:
    name: Validate Fixes
    needs: [detect-issues, apply-fixes]
    runs-on: ubuntu-latest
    if: github.event.inputs.dry-run != 'true'
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@8ade135a41bc03ea155e62e844d188df1ea18608

      - name: Run naming validation
        run: |
          conftest test \
            --policy .config/conftest/policies/ \
            deploy/

      - name: Run security validation
        run: |
          trivy fs .

      - name: Run lint validation
        run: |
          npm run lint

      - name: Run tests
        run: |
          npm test

      - name: Push metrics to Prometheus
        run: |
          NAMING_FIXED=${{ needs.detect-issues.outputs.naming-issues }}
          SECURITY_FIXED=${{ needs.detect-issues.outputs.security-issues }}
          LINT_FIXED=${{ needs.detect-issues.outputs.lint-issues }}
          
          cat <<EOF | curl --data-binary @- http://${{ secrets.PROMETHEUS_PUSHGATEWAY }}/metrics/job/auto-fix/instance/${{ github.run_number }}
            # HELP auto_fix_naming_total Total naming fixes applied
            # TYPE auto_fix_naming_total gauge
            auto_fix_naming_total{repo="${{ github.repository }}"} $NAMING_FIXED
            
            # HELP auto_fix_security_total Total security fixes applied
            # TYPE auto_fix_security_total gauge
            auto_fix_security_total{repo="${{ github.repository }}"} $SECURITY_FIXED
            
            # HELP auto_fix_lint_total Total lint fixes applied
            # TYPE auto_fix_lint_total gauge
            auto_fix_lint_total{repo="${{ github.repository }}"} $LINT_FIXED
            
            # HELP auto_fix_success_total Total successful auto-fix operations
            # TYPE auto_fix_success_total gauge
            auto_fix_success_total{repo="${{ github.repository }}"} 1
          EOF

  report-metrics:
    name: Report Metrics
    needs: [detect-issues, validate-fixes]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: Generate metrics report
        run: |
          cat <<EOF > metrics-report.json
          {
            "timestamp": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")",
            "pipeline": "auto-fix-bot",
            "metrics": {
              "naming_issues_detected": ${{ needs.detect-issues.outputs.naming-issues }},
              "security_issues_detected": ${{ needs.detect-issues.outputs.security-issues }},
              "lint_issues_detected": ${{ needs.detect-issues.outputs.lint-issues }},
              "validation_status": "${{ needs.validate-fixes.result }}"
            }
          }
          EOF

      - name: Upload metrics report
        uses: actions/upload-artifact@v3.1.2
        with:
          name: metrics-report-${{ github.sha }}
          path: metrics-report.json
          retention-days: 90