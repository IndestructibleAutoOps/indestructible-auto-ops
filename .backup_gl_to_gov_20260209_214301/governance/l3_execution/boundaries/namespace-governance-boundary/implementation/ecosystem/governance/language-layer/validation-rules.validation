# Validation Rules Configuration
# Semantic Anchor: LANGUAGELAYER.VALIDATION
# Version: 1.0.0

meta:
  spec_name: Validation Rules Configuration
  version: "1.0.0"
  semantic_anchor: LANGUAGELAYER.VALIDATION
  created_at: "2024-02-03T00:00:00Z"
  updated_at: "2024-02-03T00:00:00Z"

type_system:
  primitives:
    string:
      constraints:
        - name: max_length
          default: 1024
          message: "String length must not exceed {max}"
        - name: min_length
          default: 1
          message: "String length must be at least {min}"
        - name: pattern
          default: null
          message: "String must match pattern {pattern}"
    
    integer:
      constraints:
        - name: min
          default: null
          message: "Integer must be >= {min}"
        - name: max
          default: null
          message: "Integer must be <= {max}"
        - name: precision
          default: 16
          message: "Integer precision must not exceed {precision} bits"
    
    float:
      constraints:
        - name: min
          default: null
          message: "Float must be >= {min}"
        - name: max
          default: null
          message: "Float must be <= {max}"
        - name: decimal_places
          default: 6
          message: "Float must not exceed {decimal_places} decimal places"
    
    boolean:
      constraints:
        - name: strict
          default: true
          message: "Boolean must be true or false (case-sensitive)"
    
    null:
      constraints:
        - name: allowed_values
          default: ["null", "~", "None"]
          message: "Null must be represented as {allowed_values}"
    
    timestamp:
      constraints:
        - name: format
          default: "RFC3339"
          pattern: "^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}(?:\.\d+)?Z?$"
          message: "Timestamp must be RFC3339 format"
        - name: timezone
          default: "UTC"
          message: "Timestamps must be in UTC timezone"
    
    version:
      constraints:
        - name: format
          default: "semver"
          pattern: "^\d+\.\d+\.\d+(-[a-zA-Z0-9]+)?$"
          message: "Version must follow semantic versioning"
    
    semantic_anchor:
      constraints:
        - name: format
          default: "uppercase_with_underscores"
          pattern: "^[A-Z_]+$"
          message: "Semantic anchors must be uppercase with underscores"
        - name: uniqueness
          default: true
          message: "Semantic anchors must be globally unique"
    
    git_ref:
      constraints:
        - name: format
          default: "hexadecimal"
          pattern: "^[0-9a-f]{7,40}$"
          message: "Git refs must be valid hexadecimal hashes"

  composites:
    array:
      constraints:
        - name: max_items
          default: 1000
          message: "Array must not exceed {max_items} items"
        - name: min_items
          default: 0
          message: "Array must have at least {min_items} items"
        - name: unique_items
          default: false
          message: "Array items must be unique"
        - name: item_type
          default: null
          message: "All array items must be of type {item_type}"
    
    object:
      constraints:
        - name: max_properties
          default: 100
          message: "Object must not exceed {max_properties} properties"
        - name: min_properties
          default: 0
          message: "Object must have at least {min_properties} properties"
        - name: required_fields
          default: []
          message: "Object must contain required fields: {required_fields}"
        - name: additional_properties
          default: true
          message: "Object must not have additional properties"
    
    map:
      constraints:
        - name: key_type
          default: "string"
          message: "Map keys must be of type {key_type}"
        - name: value_type
          default: null
          message: "Map values must be of type {value_type}"
    
    tuple:
      constraints:
        - name: fixed_length
          default: null
          message: "Tuple must have exactly {fixed_length} elements"
        - name: element_types
          default: null
          message: "Tuple elements must match types {element_types}"
    
    enum:
      constraints:
        - name: allowed_values
          default: []
          message: "Value must be one of: {allowed_values}"

validity_rules:
  # YAML Specific Rules
  yaml_syntax:
    - name: proper_indentation
      description: "YAML must use 2-space indentation minimum"
      severity: CRITICAL
      enforcement: BLOCK
      pattern: "^(  |\t)"
      message: "Use 2 spaces for indentation, not tabs"
    
    - name: key_separator
      description: "YAML keys must use ': ' separator"
      severity: HIGH
      enforcement: WARN
      pattern: ":\\s[^\\s]"
      message: "Use ': ' (colon + space) for key separator"
    
    - name: forbidden_keys
      description: "YAML keys cannot be reserved words"
      severity: HIGH
      enforcement: WARN
      forbidden: ["null", "true", "false", "yes", "no", "y", "n"]
      message: "Key '{key}' is a reserved word in YAML"
    
    - name: max_indentation_levels
      description: "YAML must not exceed max indentation levels"
      severity: MEDIUM
      enforcement: LOG
      max_levels: 10
      message: "YAML exceeds maximum indentation depth of {max_levels}"

  # JSON Specific Rules
  json_syntax:
    - name: double_quotes_only
      description: "JSON strings must use double quotes"
      severity: CRITICAL
      enforcement: BLOCK
      message: "Use double quotes for JSON strings"
    
    - name: no_trailing_commas
      description: "JSON must not have trailing commas"
      severity: HIGH
      enforcement: WARN
      message: "Remove trailing commas in JSON"
    
    - name: no_comments
      description: "Standard JSON does not support comments"
      severity: MEDIUM
      enforcement: LOG
      message: "Comments are not allowed in standard JSON"
    
    - name: max_depth
      description: "JSON nesting depth must not exceed limit"
      severity: MEDIUM
      enforcement: LOG
      max_depth: 20
      message: "JSON exceeds maximum nesting depth of {max_depth}"

  # Python Specific Rules
  python_syntax:
    - name: pep8_compliance
      description: "Python code must follow PEP 8 style guide"
      severity: HIGH
      enforcement: WARN
      linter: ruff
      message: "Code violates PEP 8 style guide"
    
    - name: max_line_length
      description: "Python lines must not exceed length limit"
      severity: MEDIUM
      enforcement: LOG
      max_length: 100
      message: "Line exceeds maximum length of {max_length} characters"
    
    - name: naming_convention
      description: "Python names must follow conventions"
      severity: MEDIUM
      enforcement: LOG
      conventions:
        function: "snake_case"
        class: "PascalCase"
        constant: "UPPER_CASE"
        variable: "snake_case"
        private: "_leading_underscore"
      message: "Name '{name}' should use {convention} convention"

  # Markdown Specific Rules
  markdown_syntax:
    - name: heading_hierarchy
      description: "Markdown headings must follow hierarchy"
      severity: MEDIUM
      enforcement: LOG
      message: "Heading level jumps should not exceed 1 level"
    
    - name: code_block_language
      description: "Markdown code blocks should specify language"
      severity: LOW
      enforcement: LOG
      message: "Code block should specify language for syntax highlighting"

  # Semantic Rules
  semantic:
    - name: semantic_anchor_format
      description: "Semantic anchors must follow naming convention"
      severity: HIGH
      enforcement: WARN
      pattern: "^[A-Z_]+$"
      message: "Semantic anchor '{anchor}' must be uppercase with underscores"
    
    - name: semantic_anchor_uniqueness
      description: "Semantic anchors must be globally unique"
      severity: CRITICAL
      enforcement: BLOCK
      message: "Semantic anchor '{anchor}' is already used"
    
    - name: version_semantic
      description: "Versions must follow semantic versioning"
      severity: HIGH
      enforcement: WARN
      pattern: "^\d+\.\d+\.\d+(-[a-zA-Z0-9]+)?$"
      message: "Version '{version}' must follow semantic versioning (MAJOR.MINOR.PATCH)"
    
    - name: timestamp_format
      description: "Timestamps must be RFC3339 format"
      severity: MEDIUM
      enforcement: LOG
      pattern: "^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}(?:\.\d+)?Z?$"
      message: "Timestamp '{timestamp}' must be RFC3339 format"
    
    - name: contract_adapter_compatibility
      description: "Adapters must implement all contract capabilities"
      severity: CRITICAL
      enforcement: BLOCK
      message: "Adapter '{adapter}' missing capabilities: {missing_capabilities}"
    
    - name: enforcer_severity_enforcement
      description: "CRITICAL severity must use BLOCK enforcement"
      severity: CRITICAL
      enforcement: BLOCK
      message: "CRITICAL severity enforcers must use BLOCK enforcement"

compiler_checks:
  syntax_validation:
    enabled: true
    tools:
      - name: yaml_lint
        command: ecosystem/tools/compilers/yaml_lint.py
        languages: [yaml]
      - name: json_lint
        command: ecosystem/tools/compilers/json_lint.py
        languages: [json]
      - name: python_compile
        command: python -m py_compile
        languages: [python]
      - name: markdown_lint
        command: ecosystem/tools/compilers/markdown_lint.py
        languages: [markdown]
  
  type_inference:
    enabled: true
    tools:
      - name: pyright
        command: pyright
        languages: [python]
      - name: mypy
        command: mypy
        languages: [python]
  
  semantic_validation:
    enabled: true
    tools:
      - name: semantic_check
        command: ecosystem/tools/compilers/semantic_check.py
        languages: [yaml, json]
      - name: contract_validator
        command: ecosystem/tools/compilers/contract_validator.py
        languages: [yaml, json]

audit_logging:
  enabled: true
  log_format: "jsonl"
  fields:
    - name: actor
      type: string
      required: true
    - name: action
      type: string
      required: true
    - name: resource
      type: string
      required: true
    - name: result
      type: enum
      values: [PASS, FAIL, WARNING]
      required: true
    - name: hash
      type: string
      required: true
    - name: version
      type: version
      required: true
    - name: request_id
      type: string
      required: true
    - name: correlation_id
      type: string
      required: false
    - name: ip
      type: string
      required: false
    - name: user_agent
      type: string
      required: false
    - name: timestamp
      type: timestamp
      required: true
      format: RFC3339
      timezone: UTC
  
  log_destination:
    - type: file
      path: ecosystem/logs/validation-audit.logl
    - type: stdout
      format: json

metrics:
  validation_performance:
    - name: parse_success_rate
      type: gauge
      description: "Percentage of successful parses"
      labels: [language, file_type]
    
    - name: validation_error_rate
      type: gauge
      description: "Percentage of validation errors"
      labels: [language, severity]
    
    - name: type_safety_score
      type: gauge
      description: "Score indicating type safety compliance"
      labels: [module, language]
    
    - name: semantic_compliance_rate
      type: gauge
      description: "Percentage of semantically valid files"
      labels: [domain, file_type]
    
    - name: validation_latency_seconds
      type: histogram
      description: "Time taken to validate files"
      labels: [language, validation_type]
      buckets: [0.01, 0.05, 0.1, 0.5, 1, 5, 10]

  enforcement_actions:
    - name: blocks_issued
      type: counter
      description: "Number of BLOCK enforcements issued"
      labels: [rule, severity, language]
    
    - name: warnings_issued
      type: counter
      description: "Number of WARN enforcements issued"
      labels: [rule, severity, language]
    
    - name: logs_issued
      type: counter
      description: "Number of LOG enforcements issued"
      labels: [rule, severity, language]

evolution:
  versioning_strategy: semantic
  backward_compatibility: required
  
  breaking_changes:
    require_major_version_bump: true
    deprecation_period_days: 90
    migration_guide_required: true
  
  migration_support:
    auto_migrate_minor: true
    manual_migrate_major: true
    version_adapter_for_compat: true
  
  compatibility_matrix:
    yaml:
      - version: "1.2.2"
        compatible_with: ["1.1", "1.2"]
        notes: "YAML 1.2 is backward compatible with 1.1"
    
    json:
      - version: "ECMA-404"
        compatible_with: []
        notes: "JSON has no versioning, always compatible"
    
    python:
      - version: "3.11"
        compatible_with: ["3.10", "3.9"]
        notes: "Python 3.11 is backward compatible with 3.10 and 3.9"