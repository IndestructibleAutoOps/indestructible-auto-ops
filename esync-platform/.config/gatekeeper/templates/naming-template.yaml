# @GL-governed
# @GL-layer: GL00-09
# @GL-semantic: naming-governance
# @GL-audit-trail: gl-platform-universe/governance/audit-trails/GL00_09-audit.json
#
# GL Unified Charter Activated
# GL Root Semantic Anchor: gl-platform-universe/governance/GL-ROOT-SEMANTIC-ANCHOR.yaml
# GL Unified Naming Charter: gl-platform-universe/governance/GL-UNIFIED-NAMING-CHARTER.yaml


apiVersion: templates.gatekeeper.sh/v1
kind: ConstraintTemplate
metadata:
  name: esyncnamingconvention
  annotations:
    description: "Enforces ESync platform naming convention for Kubernetes resources"
spec:
  crd:
    spec:
      names:
        kind: ESyncNamingConvention
      validation:
        openAPIV3Schema:
          type: object
          properties:
            regex:
              type: string
            excludedNamespaces:
              type: array
              items:
                type: string
  targets:
    - target: admission.k8s.gatekeeper.sh
      rego: |
        package esyncnamingconvention
        
        violation[{"msg": msg}] {
          input.review.kind.kind in ["Deployment", "Service", "Ingress", "ConfigMap", "Secret"]
          not is_excluded_namespace(input.review.object.metadata.namespace)
          name := input.review.object.metadata.name
          pattern := input.parameters.regex
          not re_match(pattern, name)
          msg := sprintf("Resource name '%s' does not match naming pattern: %s", [name, pattern])
        }
        
        violation[{"msg": msg}] {
          input.review.kind.kind in ["Deployment", "Service", "Ingress", "ConfigMap", "Secret"]
          not is_excluded_namespace(input.review.object.metadata.namespace)
          not input.review.object.metadata.labels.environment
          msg := "Resource must have 'environment' label"
        }
        
        violation[{"msg": msg}] {
          input.review.kind.kind in ["Deployment", "Service", "Ingress", "ConfigMap", "Secret"]
          not is_excluded_namespace(input.review.object.metadata.namespace)
          not input.review.object.metadata.labels.component
          msg := "Resource must have 'component' label"
        }
        
        violation[{"msg": msg}] {
          input.review.kind.kind in ["Deployment", "Service", "Ingress", "ConfigMap", "Secret"]
          not is_excluded_namespace(input.review.object.metadata.namespace)
          not input.review.object.metadata.labels.version
          msg := "Resource must have 'version' label"
        }
        
        is_excluded_namespace(ns) {
          ns in input.parameters.excludedNamespaces
        }