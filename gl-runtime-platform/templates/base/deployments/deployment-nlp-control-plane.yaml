# GL Runtime Platform NLP Control Plane 部署

apiVersion: apps/v1
kind: Deployment
metadata:
  name: gl-runtime-nlp-control-plane-deploy-v1
  namespace: team-gl-runtime-base
  labels:
    # Kubernetes 標準標籤
    app.kubernetes.io/name: 'gl-runtime-nlp-control-plane'
    app.kubernetes.io/component: 'nlp-service'
    app.kubernetes.io/part-of: 'gl-runtime-platform'
    app.kubernetes.io/version: 'v1.0.0'
    app.kubernetes.io/managed-by: 'kubectl'
    
    # 企業治理標籤
    tenant: 'gl-runtime-team'
    cost-center: 'platform-engineering'
    business-unit: 'infrastructure'
    project: 'gl-runtime-platform'
    
    # 操作標籤
    tier: 'ai-service'
    scaling.group: 'nlp-services'
    
  annotations:
    # 描述性註解
    description: 'GL Runtime Platform 自然語言控制平面'
    owner: 'platform-team@gl-runtime.io'
    architecture.doc: 'https://docs.gl-runtime.io/architecture/nlp-control-plane'
    
    # 部署註解
    deployment.config.kubernetes.io/revision: '1'
    deployment.strategy: 'RollingUpdate'
    
spec:
  replicas: 2
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 1
      maxUnavailable: 0
  selector:
    matchLabels:
      app.kubernetes.io/name: 'gl-runtime-nlp-control-plane'
      app.kubernetes.io/component: 'nlp-service'
  template:
    metadata:
      labels:
        # Kubernetes 標準標籤
        app.kubernetes.io/name: 'gl-runtime-nlp-control-plane'
        app.kubernetes.io/component: 'nlp-service'
        app.kubernetes.io/part-of: 'gl-runtime-platform'
        app.kubernetes.io/version: 'v1.0.0'
        
        # 運行時標籤
        tier: 'ai-service'
        environment: 'base'
        
      annotations:
        # Prometheus 監控
        prometheus.io/scrape: 'true'
        prometheus.io/port: '9090'
        prometheus.io/path: '/metrics'
        
        # 健康檢查註解
        health.check.enabled: 'true'
        health.check.path: '/health'
        
    spec:
      serviceAccountName: gl-runtime-nlp-control-plane-sa
      securityContext:
        fsGroup: 1000
        runAsNonRoot: true
        runAsUser: 1000
      
      containers:
      - name: nlp-control-plane
        image: gl-registry.io/gl-runtime-platform/nlp-control-plane:v1.0.0
        imagePullPolicy: IfNotPresent
        ports:
        - containerPort: 5001
          name: http
          protocol: TCP
        - containerPort: 9090
          name: metrics
          protocol: TCP
        
        env:
        - name: NODE_ENV
          value: 'production'
        - name: PORT
          value: '5001'
        - name: LOG_LEVEL
          value: 'info'
        - name: CONTROL_PLANE_MODE
          value: 'HIGH_PRIVILEGE'
        - name: AGENT_ORCHESTRATION
          value: 'enabled'
        - name: GOVERNANCE_VALIDATION
          value: 'enabled'
        
        resources:
          requests:
            cpu: '500m'
            memory: '1Gi'
          limits:
            cpu: '2000m'
            memory: '4Gi'
        
        livenessProbe:
          httpGet:
            path: /health/live
            port: 5001
          initialDelaySeconds: 30
          periodSeconds: 10
          timeoutSeconds: 5
          failureThreshold: 3
        
        readinessProbe:
          httpGet:
            path: /health/ready
            port: 5001
          initialDelaySeconds: 10
          periodSeconds: 5
          timeoutSeconds: 3
          failureThreshold: 3
        
        volumeMounts:
        - name: config-volume
          mountPath: /etc/gl-runtime/nlp-control/config
          readOnly: true
        - name: models-volume
          mountPath: /models
          readOnly: true
      
      volumes:
      - name: config-volume
        configMap:
          name: gl-runtime-nlp-control-plane-config
          defaultMode: 0644
      - name: models-volume
        persistentVolumeClaim:
          claimName: gl-runtime-models-pvc
      
      affinity:
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
          - weight: 100
            podAffinityTerm:
              labelSelector:
                matchExpressions:
                - key: app.kubernetes.io/name
                  operator: In
                  values:
                  - gl-runtime-nlp-control-plane
              topologyKey: kubernetes.io/hostname