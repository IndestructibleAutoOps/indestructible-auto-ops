# @GL-governed
# @GL-layer: GL00-09
# @GL-semantic: general-component
# @GL-audit-trail: gl-platform-universe/governance/audit-trails/GL00_09-audit.json
#
# GL Unified Charter Activated
# GL Root Semantic Anchor: gl-platform-universe/governance/GL-ROOT-SEMANTIC-ANCHOR.yaml
# GL Unified Naming Charter: gl-platform-universe/governance/GL-UNIFIED-NAMING-CHARTER.yaml


# GL Runtime Platform REST API 部署

apiVersion: apps/v1
kind: Deployment
metadata:
  name: gl-runtime-rest-api-deploy-v1
  namespace: team-gl-runtime-base
  labels:
    # Kubernetes 標準標籤
    app.kubernetes.io/name: 'gl-runtime-rest-api'
    app.kubernetes.io/component: 'api-gateway'
    app.kubernetes.io/part-of: 'gl-runtime-platform'
    app.kubernetes.io/version: 'v1.0.0'
    app.kubernetes.io/managed-by: 'kubectl'
    
    # 企業治理標籤
    tenant: 'gl-runtime-team'
    cost-center: 'platform-engineering'
    business-unit: 'infrastructure'
    project: 'gl-runtime-platform'
    
    # 操作標籤
    tier: 'gateway'
    scaling.group: 'api-services'
    
  annotations:
    # 描述性註解
    description: 'GL Runtime Platform RESTful API 網關'
    owner: 'platform-team@gl-runtime.io'
    architecture.doc: 'https://docs.gl-runtime.io/architecture/rest-api'
    
    # 部署註解
    deployment.config.kubernetes.io/revision: '1'
    deployment.strategy: 'RollingUpdate'
    
spec:
  replicas: 2
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 1
      maxUnavailable: 0
  selector:
    matchLabels:
      app.kubernetes.io/name: 'gl-runtime-rest-api'
      app.kubernetes.io/component: 'api-gateway'
  template:
    metadata:
      labels:
        # Kubernetes 標準標籤
        app.kubernetes.io/name: 'gl-runtime-rest-api'
        app.kubernetes.io/component: 'api-gateway'
        app.kubernetes.io/part-of: 'gl-runtime-platform'
        app.kubernetes.io/version: 'v1.0.0'
        
        # 運行時標籤
        tier: 'gateway'
        environment: 'base'
        
      annotations:
        # Prometheus 監控
        prometheus.io/scrape: 'true'
        prometheus.io/port: '9090'
        prometheus.io/path: '/metrics'
        
        # 健康檢查註解
        health.check.enabled: 'true'
        health.check.path: '/health'
        
    spec:
      serviceAccountName: gl-runtime-rest-api-sa
      securityContext:
        fsGroup: 1000
        runAsNonRoot: true
        runAsUser: 1000
      
      containers:
      - name: rest-api
        image: gl-registry.io/gl-runtime-platform/rest-api:v1.0.0
        imagePullPolicy: IfNotPresent
        ports:
        - containerPort: 8080
          name: http
          protocol: TCP
        - containerPort: 9090
          name: metrics
          protocol: TCP
        
        env:
        - name: FLASK_ENV
          value: 'production'
        - name: PORT
          value: '8080'
        - name: LOG_LEVEL
          value: 'info'
        - name: UPSTREAM_API_URL
          value: 'http://gl-runtime-platform-api-svc:3000'
        
        resources:
          requests:
            cpu: '200m'
            memory: '256Mi'
          limits:
            cpu: '800m'
            memory: '1Gi'
        
        livenessProbe:
          httpGet:
            path: /health/live
            port: 8080
          initialDelaySeconds: 30
          periodSeconds: 10
          timeoutSeconds: 5
          failureThreshold: 3
        
        readinessProbe:
          httpGet:
            path: /health/ready
            port: 8080
          initialDelaySeconds: 10
          periodSeconds: 5
          timeoutSeconds: 3
          failureThreshold: 3
        
        volumeMounts:
        - name: config-volume
          mountPath: /etc/gl-runtime/rest-api/config
          readOnly: true
      
      volumes:
      - name: config-volume
        configMap:
          name: gl-runtime-rest-api-config
          defaultMode: 0644
      
      affinity:
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
          - weight: 100
            podAffinityTerm:
              labelSelector:
                matchExpressions:
                - key: app.kubernetes.io/name
                  operator: In
                  values:
                  - gl-runtime-rest-api
              topologyKey: kubernetes.io/hostname