# @GL-governed
# @GL-layer: GL00-09
# @GL-semantic: general-component
# @GL-audit-trail: gl-enterprise-architecture/governance/audit-trails/GL00_09-audit.json
#
# GL Unified Charter Activated
# GL Root Semantic Anchor: gl-enterprise-architecture/governance/GL-ROOT-SEMANTIC-ANCHOR.yaml
# GL Unified Naming Charter: gl-enterprise-architecture/governance/GL-UNIFIED-NAMING-CHARTER.yaml


# GL Runtime Platform PostgreSQL 配置映射

apiVersion: v1
kind: ConfigMap
metadata:
  name: gl-runtime-postgres-config
  namespace: team-gl-runtime-base
  labels:
    # Kubernetes 標準標籤
    app.kubernetes.io/name: 'gl-runtime-postgres'
    app.kubernetes.io/component: 'configmap'
    app.kubernetes.io/part-of: 'gl-execution-runtime'
    app.kubernetes.io/version: 'v1.0.0'
    app.kubernetes.io/managed-by: 'kubectl'
    
    # 企業治理標籤
    tenant: 'gl-runtime-team'
    cost-center: 'platform-engineering'
    business-unit: 'infrastructure'
    project: 'gl-execution-runtime'
    
    # 操作標籤
    config.type: 'database'
    
  annotations:
    # 描述性註解
    description: 'GL Runtime Platform PostgreSQL 資料庫配置'
    owner: 'platform-team@gl-runtime.io'
    
    # 配置註解
    config.version: 'v1.0.0'
    config.last-updated: '2024-01-31'
    
data:
  # PostgreSQL 配置
  postgresql.conf: |
    # 連接配置
    max_connections = 200
    shared_buffers = 256MB
    effective_cache_size = 1GB
    maintenance_work_mem = 64MB
    checkpoint_completion_target = 0.9
    wal_buffers = 16MB
    default_statistics_target = 100
    random_page_cost = 1.1
    effective_io_concurrency = 200
    work_mem = 2621kB
    min_wal_size = 1GB
    max_wal_size = 4GB
    
    # 日誌配置
    logging_collector = on
    log_destination = 'stderr'
    log_directory = '/var/log/postgresql'
    log_filename = 'postgresql-%Y-%m-%d_%H%M%S.log'
    log_rotation_age = 1d
    log_rotation_size = 100MB
    log_truncate_on_rotation = on
    log_line_prefix = '%t [%p]: [%l-1] user=%u,db=%d,app=%a,client=%h '
    log_timezone = 'UTC'
    
    # 性能配置
    shared_preload_libraries = 'pg_stat_statements'
    track_io_timing = on
    track_functions = all
    
    # 安全配置
    ssl = on
    ssl_cert_file = '/var/lib/postgresql/server.crt'
    ssl_key_file = '/var/lib/postgresql/server.key'
    password_encryption = scram-sha-256
    
    # 時區配置
    timezone = 'UTC'
    
  # pg_hba.conf
  pg_hba.conf: |
    # TYPE  DATABASE        USER            ADDRESS                 METHOD
    
    # 本地連接
    local   all             postgres                                peer
    local   all             all                                     peer
    
    # IPv4 本地連接
    host    all             all             127.0.0.1/32            scram-sha-256
    host    all             all             10.0.0.0/8              scram-sha-256
    host    all             all             172.16.0.0/12           scram-sha-256
    host    all             all             192.168.0.0/16          scram-sha-256
    
    # IPv6 本地連接
    host    all             all             ::1/128                 scram-sha-256
    host    all             all             fe80::/10               scram-sha-256
    
    # 拒絕其他連接
    host    all             all             0.0.0.0/0               reject
    
  # 初始化腳本
  init-script.sql: |
    -- 創建擴展
    CREATE EXTENSION IF NOT EXISTS pg_stat_statements;
    CREATE EXTENSION IF NOT EXISTS pgcrypto;
    
    -- 創建監控用戶
    DO
    $$
    BEGIN
      IF NOT EXISTS (SELECT FROM pg_catalog.pg_roles WHERE rolname = 'gl_monitor') THEN
        CREATE ROLE gl_monitor WITH LOGIN PASSWORD 'gl_monitor_password' NOSUPERUSER INHERIT NOCREATEDB NOCREATEROLE;
      END IF;
    END
    $$;
    
    -- 授予監控權限
    GRANT pg_read_all_stats TO gl_monitor;
    GRANT CONNECT ON DATABASE gl_governance TO gl_monitor;