# @GL-governed
# @GL-layer: GL00-09
# @GL-semantic: general-component
# @GL-audit-trail: gl-platform-universe/governance/audit-trails/GL00_09-audit.json
#
# GL Unified Charter Activated
# GL Root Semantic Anchor: gl-platform-universe/governance/GL-ROOT-SEMANTIC-ANCHOR.yaml
# GL Unified Naming Charter: gl-platform-universe/governance/GL-UNIFIED-NAMING-CHARTER.yaml


# GL Runtime Platform Ingress

apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: gl-runtime-platform-ingress
  namespace: team-gl-runtime-prod-us-west
  labels:
    # Kubernetes 標準標籤
    app.kubernetes.io/name: 'gl-runtime-platform'
    app.kubernetes.io/component: 'ingress'
    app.kubernetes.io/part-of: 'gl-runtime-platform'
    app.kubernetes.io/version: 'v1.0.0'
    app.kubernetes.io/managed-by: 'kubectl'
    
    # 企業治理標籤
    tenant: 'gl-runtime-team'
    cost-center: 'platform-engineering'
    business-unit: 'infrastructure'
    project: 'gl-runtime-platform'
    
    # 操作標籤
    tier: 'gateway'
    
  annotations:
    # 描述性註解
    description: 'GL Runtime Platform 入口控制器'
    owner: 'platform-team@gl-runtime.io'
    
    # Nginx Ingress 註解
    nginx.ingress.kubernetes.io/rewrite-target: /
    nginx.ingress.kubernetes.io/ssl-redirect: 'true'
    nginx.ingress.kubernetes.io/force-ssl-redirect: 'true'
    nginx.ingress.kubernetes.io/use-regex: 'true'
    nginx.ingress.kubernetes.io/proxy-body-size: '10m'
    nginx.ingress.kubernetes.io/proxy-connect-timeout: '30'
    nginx.ingress.kubernetes.io/proxy-send-timeout: '30'
    nginx.ingress.kubernetes.io/proxy-read-timeout: '30'
    nginx.ingress.kubernetes.io/proxy-buffering: 'on'
    nginx.ingress.kubernetes.io/proxy-buffer-size: '4k'
    
    # 速率限制
    nginx.ingress.kubernetes.io/limit-rps: '1000'
    nginx.ingress.kubernetes.io/limit-connections: '100'
    
    # 跨域資源共享
    nginx.ingress.kubernetes.io/enable-cors: 'true'
    nginx.ingress.kubernetes.io/cors-allow-origin: 'https://gl-runtime.io,https://app.gl-runtime.io'
    nginx.ingress.kubernetes.io/cors-allow-methods: 'GET, POST, PUT, DELETE, OPTIONS'
    nginx.ingress.kubernetes.io/cors-allow-headers: 'DNT,X-CustomHeader,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Authorization'
    nginx.ingress.kubernetes.io/cors-max-age: '1728000'
    
    # 證書管理器
    cert-manager.io/cluster-issuer: 'letsencrypt-prod'
    cert-manager.io/ACME-challenge-type: 'http01'
    
    # 安全註解
    nginx.ingress.kubernetes.io/configuration-snippet: |
      add_header X-Frame-Options "SAMEORIGIN" always;
      add_header X-Content-Type-Options "nosniff" always;
      add_header X-XSS-Protection "1; mode=block" always;
      add_header Referrer-Policy "strict-origin-when-cross-origin" always;
      add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline';" always;
    
spec:
  ingressClassName: nginx
  tls:
  - hosts:
    - api.gl-runtime.io
    - rest-api.gl-runtime.io
    - control-plane.gl-runtime.io
    secretName: gl-runtime-platform-tls
  
  rules:
  - host: api.gl-runtime.io
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: gl-runtime-platform-api-svc
            port:
              number: 80
  
  - host: rest-api.gl-runtime.io
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: gl-runtime-rest-api-svc
            port:
              number: 80
  
  - host: control-plane.gl-runtime.io
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: gl-runtime-nlp-control-plane-svc
            port:
              number: 80