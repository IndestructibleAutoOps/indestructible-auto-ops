// @GL-governed
// @GL-layer: GL90-99
// @GL-semantic: pipeline-governance-audit
// @GL-charter-version: 2.0.0
// @GL-audit-trail: ../../engine/governance/GL_SEMANTIC_ANCHOR.json

# @GL-governed
# @GL-layer: GL90-99
# @GL-semantic: pipeline-definition
# @GL-audit-trail: ../../engine/governance/GL_SEMANTIC_ANCHOR.json
#
# GL Unified Charter Activated
# Directory Audit Pipeline

apiVersion: pipeline.machinenativeops.io/v1
kind: Pipeline
metadata:
  name: directory-audit-pipeline
  version: "1.0.0"
  created_at: "2026-01-28T00:00:00Z"
  layer: "GL90-99"
  annotations:
    governance.machinenativeops.io/classification: "internal"
    governance.machinenativeops.io/approval: "approved"

spec:
  description: "Directory-level GL governance audit pipeline"
  triggers:
    - type: "manual"
    - type: "scheduled"
      schedule: "0 0 * * *"  # Daily at midnight
    - type: "webhook"
      endpoint: "/api/v1/pipelines/directory-audit/trigger"

  stages:
    - id: "scan"
      name: "Directory Scanning"
      type: "scan"
      config:
        scan_type: "directory"
        include_patterns:
          - "**/*.js"
          - "**/*.ts"
          - "**/*.py"
          - "**/*.yaml"
          - "**/*.yml"
          - "**/*.json"
          - "**/*.md"
        exclude_patterns:
          - "node_modules/**"
          - ".git/**"
          - "dist/**"
          - "build/**"
      continue_on_error: false

    - id: "validate"
      name: "GL Governance Validation"
      type: "validation"
      depends_on: ["scan"]
      config:
        validators:
          - "gl-governance-validator"
          - "gl-policy-engine"
          - "gl-schema-validator"
        strict_mode: true
        enforce_semantic_anchors: true
      continue_on_error: false

    - id: "analyze"
      name: "Semantic Analysis"
      type: "analysis"
      depends_on: ["validate"]
      config:
        analyzers:
          - "semantic-anchoring-analyzer"
          - "naming-convention-analyzer"
          - "path-structure-analyzer"
        generate_annotations: true
      continue_on_error: false

    - id: "report"
      name: "Report Generation"
      type: "report"
      depends_on: ["analyze"]
      config:
        report_formats:
          - "json"
          - "markdown"
          - "html"
        output_path: "../storage/gl-artifacts-store/directory-audit-reports/"
        include_recommendations: true
      continue_on_error: false

    - id: "store"
      name: "Artifact Storage"
      type: "storage"
      depends_on: ["report"]
      config:
        storage_type: "gl-artifacts-store"
        compression: true
        versioning: true
      continue_on_error: false

  hooks:
    pre_pipeline:
      - name: "initialize-governance-context"
        type: "script"
        script: "../engine/governance/init.sh"
      - name: "validate-environment"
        type: "validation"
        validators: ["environment-validator"]

    post_pipeline:
      - name: "generate-executive-summary"
        type: "report"
        template: "../engine/governance/templates/executive-summary.md"
      - name: "notify-stakeholders"
        type: "notification"
        channels: ["slack", "email"]
        on_failure: true

  resources:
    memory_limit_mb: 1024
    cpu_limit_cores: 2
    timeout_seconds: 600
    max_retries: 3

  monitoring:
    enabled: true
    metrics:
      - "execution_time"
      - "files_scanned"
      - "violations_found"
      - "compliance_score"
    alert_thresholds:
      execution_time_ms: 300000
      compliance_score: 80

status:
  phase: "ready"
  last_execution: null
  success_rate: 0