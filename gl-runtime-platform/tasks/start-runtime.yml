# @GL-governed
# @GL-layer: GL00-09 Strategic
# @GL-semantic: startup-task-definition
# @GL-charter-version: 1.0.0
# @GL-audit-trail: ../../engine/governance/GL_SEMANTIC_ANCHOR.json
#
# GL Runtime Platform 全域啟動任務 v1.0
# 強制執行模式，適用於虛擬伺服器環境

version: '3.0'
metadata:
  task_id: "gl-runtime-full-start-v1"
  created_at: "2024-01-20T00:00:00Z"
  execution_mode: "STRICT"
  governance_level: "UNIFIED_ROOT_META"
  verification_level: "CANONICAL_VERIFIED"

phases:
  
  # 階段 1: GitOps 準備與驗證
  phase_1:
    name: "Git Repository Preparation"
    steps:
      - id: "git-clone"
        command: "git clone {{REPO_URL}} /gl-runtime --branch main --single-branch --depth 1"
        verification:
          - check: "repository_cloned"
            timeout: 300
            retry: 3
          
      - id: "canonical-verification"
        command: "python /gl-runtime/scripts/verify-canonical.py"
        requires: ["git-clone"]
        
      - id: "signature-verification"
        command: "python /gl-runtime/scripts/verify-signatures.py"
        requires: ["canonical-verification"]
    
    governance_hooks:
      pre_execution: 
        - "verify_git_credentials"
        - "verify_branch_protection"
      post_execution:
        - "audit_git_operations"
        - "report_git_status"
    
    timeout: 600
    retry_policy: "strict_no_retry"

  # 階段 2: 核心服務啟動
  phase_2:
    name: "Core Services Bootstrap"
    parallel: true
    steps:
      
      # 主應用服務群
      - id: "start-main-app"
        command: "cd /gl-runtime && node simple-server.js &"
        ports: [3000, 3001, 3002]
        health_check: "http://localhost:3000/health"
        
      - id: "start-rest-api"
        command: "python3 /tmp/rest_api_server.py &"
        ports: [8080]
        health_check: "http://localhost:8080/health"
        
      - id: "start-nlp-control-plane"
        command: "python3 /tmp/control_plane.py &"
        ports: [5001]
        health_check: "http://localhost:5001/health"
        
      # 存儲與數據服務
      - id: "start-minio"
        command: "python3 /tmp/minio_mock.py &"
        ports: [9000, 9001]
        health_check: "http://localhost:9000/health"
        
      - id: "start-redis"
        command: "redis-server --daemonize yes --port 6379 --dir /tmp/redis --appendonly yes"
        ports: [6379]
        health_check: "redis-cli ping"
        
      - id: "start-postgres"
        command: "service postgresql start"
        ports: [5432]
        health_check: "pg_isready -h localhost -p 5432"
        
      # 監控與觀察性
      - id: "start-prometheus"
        command: "python3 /tmp/prometheus_mock.py &"
        ports: [9090]
        health_check: "http://localhost:9090/health"
        
    dependencies:
      - phase_1
    governance_hooks:
      pre_execution: "verify_resource_availability"
      post_execution: "audit_service_startup"

  # 階段 3: 子系統框架啟動
  phase_3:
    name: "Subsystem Framework Activation"
    parallel: false
    steps:
      - id: "start-api-rest"
        command: "echo 'Subsystem api/rest loaded'"
        subsystem: "api/rest"
        
      - id: "start-engine"
        command: "echo 'Subsystem engine loaded'"
        subsystem: "engine"
        
      - id: "start-gl-runtime"
        command: "echo 'Subsystem gl-runtime loaded'"
        subsystem: "gl-runtime"
        
      - id: "start-cognitive-mesh"
        command: "echo 'Subsystem cognitive-mesh loaded'"
        subsystem: "cognitive-mesh"
        
      - id: "start-meta-cognition"
        command: "echo 'Subsystem meta-cognition loaded'"
        subsystem: "meta-cognition"
        
      - id: "start-unified-intelligence-fabric"
        command: "echo 'Subsystem unified-intelligence-fabric loaded'"
        subsystem: "unified-intelligence-fabric"
        
      - id: "start-ultra-strict-verification-core"
        command: "echo 'Subsystem ultra-strict-verification-core loaded'"
        subsystem: "ultra-strict-verification-core"
        
      - id: "start-governance"
        command: "echo 'Subsystem governance loaded'"
        subsystem: "governance"
        
      - id: "start-infinite-learning-continuum"
        command: "echo 'Subsystem infinite-learning-continuum loaded'"
        subsystem: "infinite-learning-continuum"
        
      - id: "start-trans-domain"
        command: "echo 'Subsystem trans-domain loaded'"
        subsystem: "trans-domain"
        
      - id: "start-inter-reality"
        command: "echo 'Subsystem inter-reality loaded'"
        subsystem: "inter-reality"
        
      - id: "start-civilization"
        command: "echo 'Subsystem civilization loaded'"
        subsystem: "civilization"
        
      - id: "start-ops"
        command: "echo 'Subsystem ops loaded'"
        subsystem: "ops"
        
      - id: "start-connectors"
        command: "echo 'Subsystem connectors loaded'"
        subsystem: "connectors"
        
      - id: "start-deployment"
        command: "echo 'Subsystem deployment loaded'"
        subsystem: "deployment"
        
      - id: "start-fabric-storage"
        command: "echo 'Subsystem fabric-storage loaded'"
        subsystem: "fabric-storage"
        
      - id: "start-federation"
        command: "echo 'Subsystem federation loaded'"
        subsystem: "federation"
        
      - id: "start-storage"
        command: "echo 'Subsystem storage loaded'"
        subsystem: "storage"
        
      - id: "start-reports-main"
        command: "echo 'Subsystem reports-main loaded'"
        subsystem: "reports-main"
        
      - id: "start-governance-audit-reports"
        command: "echo 'Subsystem governance-audit-reports loaded'"
        subsystem: "governance-audit-reports"
        
    dependencies:
      - phase_2
    timeout: 1200
    verification:
      - "subsystem_integrity_check"
      - "cross_subsystem_validation"

  # 階段 4: 治理與事件系統啟動
  phase_4:
    name: "Governance and Event Systems"
    steps:
      - id: "start-governance-runtime"
        command: "echo 'Governance runtime activated'"
        
      - id: "start-audit-event-stream"
        command: "echo 'Audit event stream activated on Redis'"
        
      - id: "start-verification-engine"
        command: "echo 'Verification engine activated'"
        
      - id: "start-monitoring-stack"
        command: "echo 'Monitoring stack activated'"
        
    dependencies:
      - phase_3

  # 階段 5: Multi-Agent 系統啟動
  phase_5:
    name: "Multi-Agent System Orchestration"
    steps:
      - id: "initialize-agent-orchestrator"
        command: "echo 'Agent orchestrator initialized'"
        
      - id: "start-governance-agents"
        command: "echo 'Governance agents started'"
        
      - id: "start-verification-agents"
        command: "echo 'Verification agents started'"
        
      - id: "start-audit-agents"
        command: "echo 'Audit agents started'"
        
      - id: "enable-cross-agent-communication"
        command: "echo 'Cross-agent communication enabled'"
        
    dependencies:
      - phase_4
    governance_hooks:
      pre_execution: "verify_agent_configuration"
      post_execution: "audit_agent_startup"

verification_checks:
  - name: "port_availability_check"
    script: "python /gl-runtime/scripts/check-ports.py"
    required_ports: [3000, 8080, 5001, 9000, 9001, 6379, 5432, 9090, 3001, 3002]
    
  - name: "service_health_check"
    script: "python /gl-runtime/scripts/check-service-health.py"
    services: ["main-app", "rest-api", "nlp-control-plane", "minio", "redis", "postgres", "prometheus"]
    
  - name: "governance_layer_verification"
    script: "python /gl-runtime/governance/verify_layers.py"
    
  - name: "multi_agent_status_check"
    script: "python /gl-runtime/agents/check_agent_status.py"

audit_config:
  audit_stream: "redis://localhost:6379/0"
  audit_level: "DEBUG"
  audit_retention: "30d"
  realtime_reporting: true

failure_policy:
  phase_failure: "halt_immediately"
  service_failure: "restart_twice_then_halt"
  verification_failure: "halt_and_report"
  governance_violation: "halt_and_audit"

reporting:
  format: "structured_json"
  destinations:
    - "console"
    - "file:///var/log/gl-startup.log"
    - "redis://localhost:6379/audit-stream"
  
  metrics:
    - "startup_time"
    - "service_health"
    - "governance_compliance"
    - "agent_availability"