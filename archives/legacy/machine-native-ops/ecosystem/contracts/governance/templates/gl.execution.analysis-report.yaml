#
# @GL-governed
# @GL-layer: GL90-99
# @GL-semantic: governance
# @GL-audit-trail: ../../governance/GL_SEMANTIC_ANCHOR.json
#
apiVersion: gl-execution/v1
kind: ExecutionAnalysisReport
metadata:
  executionId: "{{ auto_generated_uuid }}"
  executionType: "{{ pipeline_type }}"  # fact-pipeline, validation, deployment, etc.
  timestamp: "{{ iso8601_timestamp }}"
  triggeredBy: "{{ user_or_agent }}"
  correlationId: "{{ trace_id }}"
  version: "1.0.0"

spec:
  # 第一部分：執行概覽
  executionSummary:
    duration: "{{ duration_seconds }}s"
    status: "{{ success|partial_failure|failure }}"
    exitCode: "{{ exit_code }}"
    resourceUsage:
      cpu: "{{ cpu_seconds }}"
      memory: "{{ memory_mb }}MB"
      storage: "{{ storage_mb }}MB"
    
    governanceLayersInvolved:
      - layer: "gl.contracts"
        triggeredCount: "{{ count }}"
        coverage: "{{ percentage }}%"
      - layer: "gl.validation"
        triggeredCount: "{{ count }}"
        coverage: "{{ percentage }}%"
      - layer: "gl.platforms"
        triggeredCount: "{{ count }}"
        coverage: "{{ percentage }}%"
    
    triggeredRules:
      total: "{{ total_rules }}"
      byPriority:
        p0: "{{ count }}"
        p1: "{{ count }}"
        p2: "{{ count }}"
        p3: "{{ count }}"

  # 第二部分：語意解析結果
  semanticAnalysis:
    inputIntent:
      original: "{{ original_input }}"
      interpreted: "{{ interpreted_intent }}"
      confidence: "{{ confidence_score }}"
    
    reasoningChain:
      steps:
        - step: 1
          phase: "input-parsing"
          description: "解析輸入意圖"
          input: "{{ raw_input }}"
          output: "{{ parsed_intent }}"
          ruleApplied: "gl.input-parsing-rule-v1"
          confidence: 0.95
          evidence: "{{ evidence_path }}"
        
        - step: 2
          phase: "contract-selection"
          description: "選擇適用的契約"
          input: "{{ parsed_intent }}"
          output:
            selectedContracts:
              - "contracts/{{ contract_name }}.yaml"
            selectionReason: "{{ rationale }}"
          ruleApplied: "gl.contract-matching-rule-v2"
          confidence: 0.88
          evidence: "{{ evidence_path }}"
        
        - step: 3
          phase: "validation-execution"
          description: "執行驗證規則"
          input: "{{ selected_contracts }}"
          output:
            validationResults:
              - rule: "gl.validation.consistency-check"
                status: "passed"
                evidence: "{{ evidence_path }}"
              - rule: "gl.validation.completeness-check"
                status: "failed"
                reason: "{{ failure_reason }}"
                suggestion: "{{ fix_suggestion }}"
          ruleApplied: "gl.validation-engine-v1"
          confidence: 0.92
          evidence: "{{ evidence_path }}"
    
    successPatterns:
      - pattern: "{{ pattern_name }}"
        description: "描述成功的模式"
        occurrences: "{{ count }}"
        efficiency: "{{ efficiency_metric }}"
        recommendation: "{{ how_to_replicate }}"
        evidence: "{{ evidence_path }}"
    
    failurePatterns:
      - pattern: "{{ pattern_name }}"
        description: "描述失敗的模式"
        occurrences: "{{ count }}"
        rootCause: "{{ identified_root_cause }}"
        mitigation: "{{ suggested_mitigation }}"
        recurrenceRisk: "{{ low|medium|high }}"
        evidence: "{{ evidence_path }}"

  # 第三部分：學習與改進點
  learnings:
    discoveredPatterns:
      - pattern: "{{ new_pattern }}"
        context: "{{ when_it_occurs }}"
        implication: "{{ what_it_means }}"
        actionRequired: "{{ yes|no }}"
        confidence: "{{ confidence_score }}"
    
    optimizationOpportunities:
      - opportunity: "{{ optimization_name }}"
        currentState: "{{ current_metric }}"
        potentialState: "{{ potential_metric }}"
        effort: "{{ low|medium|high }}"
        priority: "{{ p0|p1|p2|p3 }}"
        estimatedImpact: "{{ high|medium|low }}"
        evidence: "{{ evidence_path }}"
    
    knowledgeGaps:
      - gap: "{{ gap_description }}"
        evidence: "{{ supporting_evidence }}"
        impact: "{{ low|medium|high }}"
        researchNeeded: "{{ yes|no }}"
        priority: "{{ p0|p1|p2|p3 }}"

  # 第四部分：治理影響評估
  governanceImpact:
    contracts:
      validated: "{{ count }}"
      created: "{{ count }}"
      updated: "{{ count }}"
      deprecated: "{{ count }}"
    
    validationRules:
      triggered: "{{ count }}"
      passed: "{{ count }}"
      failed: "{{ count }}"
      newlyGenerated: "{{ count }}"
    
    complianceMetrics:
      semverCompliance: "{{ percentage }}%"
      namingConventionCompliance: "{{ percentage }}%"
      documentationCompliance: "{{ percentage }}%"
      testCoverageCompliance: "{{ percentage }}%"
    
    driftDetection:
      detectedDrifts: "{{ count }}"
      severity:
        critical: "{{ count }}"
        high: "{{ count }}"
        medium: "{{ count }}"
        low: "{{ count }}"
      autoRemediated: "{{ count }}"

  # 第五部分：執行質量評估
  executionQuality:
    reliability: "{{ score_0_100 }}"
    efficiency: "{{ score_0_100 }}"
    completeness: "{{ score_0_100 }}"
    correctness: "{{ score_0_100 }}"
    
    bottlenecks:
      - phase: "{{ phase_name }}"
        duration: "{{ seconds }}"
        percentageOfTotal: "{{ percentage }}%"
        optimizationPotential: "{{ low|medium|high }}"
        evidence: "{{ evidence_path }}"
    
    anomalies:
      - anomaly: "{{ description }}"
        timestamp: "{{ when }}"
        severity: "{{ low|medium|high|critical }}"
        resolved: "{{ yes|no }}"
        evidence: "{{ evidence_path }}"

  # 第六部分：建議與後續行動
  recommendations:
    immediateActions:
      - action: "{{ what_to_do }}"
        reason: "{{ why }}"
        owner: "{{ who }}"
        deadline: "{{ when }}"
        priority: "{{ p0|p1|p2|p3 }}"
        evidence: "{{ evidence_path }}"
    
    processImprovements:
      - improvement: "{{ what_to_improve }}"
        currentState: "{{ as_is }}"
        targetState: "{{ to_be }}"
        metricsToTrack: "{{ metrics }}"
        effort: "{{ low|medium|high }}"
        expectedBenefit: "{{ benefit }}"
        evidence: "{{ evidence_path }}"
    
    knowledgeBaseUpdates:
      - update: "{{ what_to_update }}"
        location: "{{ where }}"
        content: "{{ what_content }}"
        reviewer: "{{ who_reviews }}"
        priority: "{{ p0|p1|p2|p3 }}"
        evidence: "{{ evidence_path }}"

  # 第七部分：證據鏈
  evidenceChain:
    sources:
      - source: "{{ source_name }}"
        type: "{{ contract|registry|log|output }}"
        location: "{{ path }}"
        checksum: "{{ sha256_hash }}"
        timestamp: "{{ timestamp }}"
        trustLevel: "{{ high|medium|low }}"
    
    coverage:
      totalStatements: "{{ count }}"
      statementsWithEvidence: "{{ count }}"
      coveragePercentage: "{{ percentage }}%"
      statementsWithoutEvidence:
        - statement: "{{ statement_text }}"
          location: "{{ where }}"
          severity: "{{ high|medium|low }}"

  # 第八部分：禁用短語檢查
  forbiddenPhraseCheck:
    enabled: true
    scannedText:
      - section: "semanticAnalysis"
        violations: []
      - section: "recommendations"
        violations: []
    
    totalViolations: "{{ count }}"
    bySeverity:
      critical: "{{ count }}"
      high: "{{ count }}"
      medium: "{{ count }}"
      low: "{{ count }}"
    
    autoCorrected: "{{ count }}"
    manuallyReviewed: "{{ count }}"

  # 審計信息
  auditTrail:
    generatedBy: "gl.execution.analysis-engine"
    generationTimestamp: "{{ iso8601_timestamp }}"
    sourceDataHash: "{{ sha256_hash }}"
    verificationSignature: "{{ digital_signature }}"
    
    dependencies:
      - component: "gl-fact-pipeline"
        version: "{{ version }}"
        contribution: "{{ how_it_contributed }}"
      - component: "gl-validation-engine"
        version: "{{ version }}"
        contribution: "{{ how_it_contributed }}"
      - component: "gl-governance-engine"
        version: "{{ version }}"
        contribution: "{{ how_it_contributed }}"
    
    reviewers:
      - reviewer: "{{ name }}"
        role: "{{ role }}"
        timestamp: "{{ timestamp }}"
        status: "{{ approved|rejected|pending }}"
        comments: "{{ comments }}"

  # 質量閘門
  qualityGates:
    gate1:
      name: "evidence_coverage"
      threshold: 0.90
      actual: "{{ actual_value }}"
      status: "{{ passed|failed }}"
    gate2:
      name: "forbidden_phrase_check"
      threshold: 0
      actual: "{{ actual_value }}"
      status: "{{ passed|failed }}"
    gate3:
      name: "reasoning_quality"
      threshold: 0.85
      actual: "{{ actual_value }}"
      status: "{{ passed|failed }}"
    
    overallStatus: "{{ passed|failed }}"
    canProceed: "{{ yes|no }}"