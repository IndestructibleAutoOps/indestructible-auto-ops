#!/bin/bash
# GL Governance Pre-Commit Hook
set -e

echo "GL Unified Charter Activated - Pre-Commit Validation"

# Check for GL metadata in changed files
CHANGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(ts|tsx|js|json|yaml|yml)$' || true)

if [ -n "$CHANGED_FILES" ]; then
  echo "Validating GL compliance for changed files..."
  
  for FILE in $CHANGED_FILES; do
    # Check for GL governance markers
    if ! grep -q "@GL-" "$FILE" 2>/dev/null; then
      echo "⚠️  Warning: $FILE missing GL governance markers"
    fi
    
    # Check for semantic annotations
    if grep -q "engine/" <<< "$FILE"; then
      if ! grep -q "governance:" "$FILE" 2>/dev/null; then
        echo "⚠️  Warning: $FILE missing governance metadata"
      fi
    fi
  done
fi

# Run GL validation if engine files changed
if echo "$CHANGED_FILES" | grep -q "^engine/"; then
  echo "Running GL Engine validation..."
  cd engine && npm run validate || {
    echo "❌ GL Validation Failed - Commit blocked"
    exit 1
  }
fi

echo "✓ GL Governance Pre-Commit Check Passed"