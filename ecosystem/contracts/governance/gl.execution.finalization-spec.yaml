apiVersion: gl-governance/v1
kind: ExecutionFinalizationSpec
metadata:
  name: gl.execution.finalization-spec
  version: 1.0.0
  description: "每次執行結束前，進行流程解析與流程升級的標準規範"
  lastUpdated: "2025-01-18T00:00:00Z"

spec:
  lifecycle:
    requiredStages:
      - gl.execution.analysis
      - gl.execution.delta
      - gl.flow.upgrade

    outputArtifacts:
      - gl.execution.analysis-report.yaml
      - gl.execution.delta-report.yaml
      - gl.flow.upgrade-log.yaml

    constraints:
      - "不得跳過分析階段"
      - "不得跳過升級階段"
      - "不得產生無推理的報告"

  gl.execution.analysis:
    inputs:
      - executionLog
      - contractReferences
      - validationResults
      - reasoningTrace
    outputs:
      - summary:
          - successRate
          - failurePoints
          - triggeredRules
          - governanceLayersInvolved
      - reasoningChain:
          - steps:
              - description
              - input
              - output
              - ruleApplied
      - patterns:
          - successPatterns
          - failurePatterns
      - learnings:
          - discoveredPatterns
          - optimizationOpportunities
          - knowledgeGaps
    validationRules:
      - rule: "ANALYSIS-001"
        description: "所有推理步驟必須有證據支持"
        enforcement: "strict"
      - rule: "ANALYSIS-002"
        description: "失敗分析必須識別根本原因"
        enforcement: "strict"
      - rule: "ANALYSIS-003"
        description: "成功模式必須可復制"
        enforcement: "recommended"

  gl.execution.delta:
    comparison:
      base: previousExecution
      target: currentExecution
      method: "semantic-diff-with-context"
    dimensions:
      - executionLevel:
          - duration
          - resourceUsage
          - status
      - governanceLevel:
          - contractCoverage
          - validationRules
          - complianceMetrics
      - processStructure:
          - phaseChanges
          - decisionPoints
          - fallbackMechanisms
      - semanticReasoning:
          - inputInterpretation
          - reasoningPaths
          - learningIntegration
      - qualityPerformance:
          - reliability
          - efficiency
          - bottlenecks
    outputs:
      - deltaReport:
          - changedModules
          - newRulesTriggered
          - performanceDelta
          - coverageDelta
          - governanceImpact
          - improvements
          - regressions
    validationRules:
      - rule: "DELTA-001"
        description: "必須使用相同的比較方法"
        enforcement: "strict"
      - rule: "DELTA-002"
        description: "顯著變化必須有門檻"
        enforcement: "strict"
      - rule: "DELTA-003"
        description: "回歸必須被識別"
        enforcement: "critical"

  gl.flow.upgrade:
    triggers:
      - trigger: "ANALYSIS_FAILURE_PATTERN"
        condition: "analysis.failurePatterns > 0"
        severity: "high"
      - trigger: "DELTA_REGRESSION"
        condition: "delta.regressions.length > 0"
        severity: "critical"
      - trigger: "DELTA_SIGNIFICANT_IMPROVEMENT"
        condition: "delta.improvements.score > 0.8"
        severity: "medium"
      - trigger: "ANALYSIS_CRITICAL_OPPORTUNITY"
        condition: "analysis.recommendations.priority == p0"
        severity: "high"
    actions:
      - update:
          - gl.fact-pipeline-spec.yaml
          - gl-governance-engine.yaml
          - gl-validation-rules.yaml
      - append:
          - gl.flow.upgrade-log.yaml
      - create:
          - validationRules
          - fallbackMechanisms
    upgradeTypes:
      - type: "contract_upgrade"
        operation: "create|update|deprecate|delete"
        impact: "breaking|non-breaking|enhancement"
      - type: "rule_upgrade"
        operation: "add|modify|remove"
        trigger: "condition"
        impact: "low|medium|high"
      - type: "pipeline_upgrade"
        operation: "phase_add|phase_modify|phase_remove"
        rollback: "required"
      - type: "governance_upgrade"
        operation: "policy_add|policy_modify|policy_remove"
        compliance: "mandatory|recommended|optional"
    validationRules:
      - rule: "UPGRADE-001"
        description: "所有升級必須有推理支持"
        enforcement: "strict"
      - rule: "UPGRADE-002"
        description: "關鍵升級必須有驗證"
        enforcement: "critical"
      - rule: "UPGRADE-003"
        description: "升級必須記錄到日誌"
        enforcement: "strict"
      - rule: "UPGRADE-004"
        description: "重大變更必須有回滾計畫"
        enforcement: "strict"

  logging:
    retention:
      analysisReports: "180d"
      deltaReports: "365d"
      upgradeLogs: "indefinite"
    format: "yaml"
    compression: "gzip"
    auditTrail: "enabled"

  audit:
    enabled: true
    retention: "180d"
    reviewers:
      - governance-team
      - platform-owner
    scope:
      - executionAnalysis
      - deltaCalculation
      - upgradeExecution
      - impactAssessment

  enforcement:
    preExitChecks:
      - name: "analysis_report_generated"
        check: "file_exists(gl.execution.analysis-report.yaml)"
        action: "block"
        message: "必須先生成分析報告"
      - name: "delta_report_generated"
        check: "file_exists(gl.execution.delta-report.yaml)"
        action: "block"
        message: "必須先生成差異報告"
      - name: "upgrade_logged"
        check: "upgrade_in_gl.flow.upgrade-log.yaml"
        action: "block"
        message: "必須記錄升級日誌"
    runtimeGuards:
      - name: "未分析禁止退出"
        condition: "!analysis.completed"
        action: "block"
        severity: "critical"
      - name: "未升級禁止提交"
        condition: "!upgrade.logged"
        action: "block"
        severity: "high"
      - name: "失敗未分析禁止繼續"
        condition: "status == failed && !failure_analyzed"
        action: "block"
        severity: "critical"

  exceptions:
    type: "manual override"
    process:
      - require: "governance-team approval"
      - document: "reason_for_override"
      - log: "gl.flow.override-log.yaml"
      - review: "within 24h"
    allowedConditions:
      - condition: "system_emergency"
        approval: "platform-owner"
      - condition: "regulatory_compliance"
        approval: "legal-team"
      - condition: "security_vulnerability"
        approval: "security-team"
      - condition: "critical_bug_fix"
        approval: "tech-lead"

  qualityGates:
    gate1:
      name: "evidence_coverage"
      threshold: 0.90
      description: "至少90%的陳述必須有證據支持"
    gate2:
      name: "forbidden_phrase_check"
      threshold: 0
      description: "零禁用短語違規"
    gate3:
      name: "reasoning_quality"
      threshold: 0.85
      description: "推理質量分數必須≥85%"
    gate4:
      name: "upgrade_verification"
      threshold: "100%"
      description: "所有升級必須通過驗證"

  evolutionMetrics:
    - name: "process_maturity_index"
      formula: "(reliability + efficiency + automation_level) / 3"
      target: 85
    - name: "self_evolution_rate"
      formula: "(upgrades_executed / execution_count) * 100"
      target: 10
    - name: "learning_absorption_rate"
      formula: "(learnings_applied / learnings_generated) * 100"
      target: 80
    - name: "failure_to_improvement_cycle"
      formula: "time_between(failure_detected, improvement_deployed)"
      target: "4h"
    - name: "knowledge_compounding_factor"
      formula: "ln(total_knowledge_units) / ln(execution_count)"
      target: 1.0

  monitoring:
    enabled: true
    alertThresholds:
      - metric: "process_maturity_index"
        warning: 70
        critical: 60
      - metric: "self_evolution_rate"
        warning: 5
        critical: 2
      - metric: "learning_absorption_rate"
        warning: 60
        critical: 50
    dashboard: "gl.evolution-metrics.yaml"
    reportInterval: "5m"