# GL Verifiable Report Standard v1.0.0 - Executable Contract
# @GL-governed
# @GL-layer: GL90-99
# @GL-semantic: verifiable-report

version: "1.0.0"
status: "PRODUCTION_READY"
component_type: "Standard"

metadata:
  gl_semantic_layer: "GL90-99"
  gl_semantic_domain: "verification"
  gl_semantic_context: "governance"
  audit_trail_enabled: true

# 觸發條件
trigger:
  conditions:
    - type: "operation_completion"
      scope: "all"
    - type: "report_request"
      scope: "all"
    - type: "audit_initiation"
      scope: "all"

# 驗證規則
verify:
  # P0 FIX: Evidence Validation Rules (CRITICAL)
  evidence_validation:
    - rule: "evidence_must_have_checksum"
      severity: "CRITICAL"
      check: "evidence.checksum exists AND evidence.checksum format_valid(SHA256)"
      error_message: "Evidence missing SHA-256 checksum"
      remediation: "Generate SHA-256 checksum for all evidence"
      
    - rule: "evidence_must_be_verifiable"
      severity: "CRITICAL"
      check: "evidence.source exists AND evidence.source accessible"
      error_message: "Evidence source not verifiable"
      remediation: "Ensure all evidence sources are accessible"
      
    - rule: "evidence_coverage_minimum"
      severity: "HIGH"
      check: "evidence_coverage_percentage >= 90"
      error_message: "Evidence coverage below 90% threshold"
      remediation: "Add more evidence links to meet 90% coverage"
      
    - rule: "evidence_timestamp_valid"
      severity: "HIGH"
      check: "evidence.timestamp exists AND evidence.timestamp <= report.timestamp"
      error_message: "Evidence timestamp invalid"
      remediation: "Ensure evidence timestamps are valid and pre-date report"
  report_structure:
    mandatory_sections:
      - name: "evidence"
        required: true
        validation:
          - "must_have_source_links"
          - "must_have_checksums"
          - "must_have_timestamps"
      
      - name: "validation"
        required: true
        validation:
          - "must_have_status"
          - "must_have_details"
          - "must_have_recommendations"
      
      - name: "reasoning"
        required: true
        validation:
          - "must_have_chain_of_thought"
          - "must_reference_evidence"
      
      - name: "reproduction"
        required: true
        validation:
          - "must_have_commit_hash"
          - "must_have_environment_info"
          - "must_have_command_line"
      
      - name: "audit"
        required: true
        validation:
          - "must_have_operation_id"
          - "must_have_timestamps"
          - "must_have_performer"

  validation_levels:
    - level: "syntax"
      checks:
        - "yaml_valid"
        - "json_valid"
        - "markdown_valid"
      severity: "CRITICAL"
    
    - level: "semantic"
      checks:
        - "all_sections_present"
        - "evidence_links_valid"
        - "reasoning_coherent"
      severity: "CRITICAL"
    
    - level: "integrity"
      checks:
        - "checksums_match"
        - "signatures_valid"
        - "timestamps_consistent"
      severity: "CRITICAL"
    
    - level: "governance"
      checks:
        - "gl_markers_present"
        - "governance_events_logged"
        - "audit_trail_complete"
      severity: "HIGH"

  quality_gates:
    - gate: "evidence_coverage"
      threshold: 0.90
      measurement: "statements_with_evidence / total_statements"
      on_failure: "block_and_request_evidence"
    
    - gate: "reasoning_quality"
      threshold: 0.85
      measurement: "evidence_referenced / total_claims"
      on_failure: "enhance_reasoning"
    
    - gate: "forbidden_phrases"
      threshold: 0
      measurement: "forbidden_phrase_count"
      on_failure: "block_and_request_rewrite"

# 審計規則
audit:
  governance_events:
    - event: "report_started"
      required_fields: ["report_id", "operation_id", "initiator"]
    
    - event: "report_completed"
      required_fields: ["report_id", "validation_status", "quality_gate_results"]
    
    - event: "report_rejected"
      required_fields: ["report_id", "rejection_reason", "gate_failed"]

  audit_trail:
    - requirement: "all_reports_must_be_signed"
      algorithm: "RSA-2048"
      key_location: "governance/signing_keys"
    
    - requirement: "reports_must_be_immutable"
      storage: "content_addressable"
      retention: "7 years"

# 異常處理策略
fallback:
  on_report_generation_failure:
    action: "log_error_and_return_partial"
    log_level: "ERROR"
    include_partial_results: true
    notify: ["governance_manager"]
  
  on_validation_failure:
    action: "block_and_request_fixes"
    provide_detailed_feedback: true
    max_validation_attempts: 3
  
  on_quality_gate_failure:
    action: "prevent_publication"
    generate_remediation_guide: true
    notify: ["author", "governance_manager"]

# P0 FIX: Audit Rules
audit:
  - rule: "log_all_report_validations"
    scope: "all"
    retention: "90_days"
    storage: "sqlite"
    encryption: "AES-256"
    
  - rule: "log_evidence_validation"
    scope: "evidence_validation"
    include:
      - "validation_timestamp"
      - "report_id"
      - "evidence_coverage"
      - "checksum_validations"
      - "violations"
      - "quality_gate_results"
      
  - rule: "log_quality_gate_checks"
    scope: "quality_gates"
    include:
      - "gate_check_timestamp"
      - "report_id"
      - "gate_name"
      - "threshold"
      - "actual_value"
      - "passed"
      - "remediation_required"

# 合約元數據
metadata:
  created_at: "2026-02-02"
  updated_at: "2026-02-02"
  authors: ["GL-Governance-Team"]
  reviewers: ["GL-Compliance-Team"]
  dependencies:
    - "ecosystem/contracts/verification/gl-proof-model.yaml"
    - "ecosystem/contracts/verification/gl-verification-engine-spec.yaml"
  integration_points:
    - "ReportGenerator.generate()"
    - "GovernanceEnforcer.validate()"
    - "SelfAuditor.audit()"