# Alertmanager Configuration for MNGA
# Handles alert routing, grouping, and inhibition

global:
  resolve_timeout: 5m
  # Slack webhook URL must be provided via environment variable SLACK_API_URL (not committed to VCS).
  slack_api_url: '${SLACK_API_URL}'
  pagerduty_url: 'https://events.pagerduty.com/v2/enqueue'

route:
  receiver: 'default-receiver'
  group_by: ['alertname', 'severity', 'namespace']
  group_wait: 10s
  group_interval: 10s
  repeat_interval: 12h
  routes:
    # P0 - Critical alerts go to PagerDuty
    - match:
        severity: P0
      receiver: 'pagerduty-critical'
      group_wait: 0s
      repeat_interval: 5m
      
    # P1 - High alerts go to PagerDuty and Slack
    - match:
        severity: P1
      receiver: 'pagerduty-high'
      routes:
        - match:
            category: naming
          receiver: 'slack-naming-team'
          
    # P2 - Medium alerts go to Slack
    - match:
        severity: P2
      receiver: 'slack-platform-team'
      routes:
        - match:
            category: naming
          receiver: 'slack-naming-team'
        - match:
            category: security
          receiver: 'slack-security-team'
          
    # P3 - Low alerts go to Slack only
    - match:
        severity: P3
      receiver: 'slack-platform-team'

# Inhibition rules to prevent alert spam
inhibit_rules:
  # If P0 alert fires, inhibit P1-P3 alerts for same resource
  - source_match:
      severity: P0
    target_match_re:
      severity: (P1|P2|P3)
    equal: ['namespace', 'resource_type']
    
  # If P1 alert fires, inhibit P2-P3 alerts for same resource
  - source_match:
      severity: P1
    target_match_re:
      severity: (P2|P3)
    equal: ['namespace', 'resource_type']

receivers:
  - name: 'default-receiver'
    slack_configs:
      - channel: '#mnga-alerts'
        send_resolved: true
        title: '{{ .Status | toUpper }}: {{ .CommonLabels.alertname }}'
        text: |
          {{ range .Alerts }}
          *Alert:* {{ .Labels.alertname }}
          *Severity:* {{ .Labels.severity }}
          *Namespace:* {{ .Labels.namespace }}
          *Description:* {{ .Annotations.description }}
          *Runbook:* {{ .Annotations.runbook_url }}
          {{ end }}
          
  - name: 'pagerduty-critical'
    pagerduty_configs:
      - service_key: 'YOUR_PAGERDUTY_SERVICE_KEY'
        severity: critical
        description: '{{ .CommonLabels.alertname }}'
        
  - name: 'pagerduty-high'
    pagerduty_configs:
      - service_key: 'YOUR_PAGERDUTY_SERVICE_KEY'
        severity: error
        description: '{{ .CommonLabels.alertname }}'
        
  - name: 'slack-naming-team'
    slack_configs:
      - channel: '#naming-governance'
        send_resolved: true
        title: '{{ .Status | toUpper }}: {{ .CommonLabels.alertname }}'
        text: |
          {{ range .Alerts }}
          *Alert:* {{ .Labels.alertname }}
          *Severity:* {{ .Labels.severity }}
          *Resource Type:* {{ .Labels.resource_type }}
          *Violation:* {{ .Labels.violation_type }}
          *Description:* {{ .Annotations.description }}
          *Runbook:* {{ .Annotations.runbook_url }}
          {{ end }}
          
  - name: 'slack-platform-team'
    slack_configs:
      - channel: '#platform-alerts'
        send_resolved: true
        title: '{{ .Status | toUpper }}: {{ .CommonLabels.alertname }}'
        text: |
          {{ range .Alerts }}
          *Alert:* {{ .Labels.alertname }}
          *Severity:* {{ .Labels.severity }}
          *Category:* {{ .Labels.category }}
          *Description:* {{ .Annotations.description }}
          *Runbook:* {{ .Annotations.runbook_url }}
          {{ end }}
          
  - name: 'slack-security-team'
    slack_configs:
      - channel: '#security-alerts'
        send_resolved: true
        title: 'ðŸ”’ Security Alert: {{ .CommonLabels.alertname }}'
        text: |
          {{ range .Alerts }}
          *Alert:* {{ .Labels.alertname }}
          *Severity:* {{ .Labels.severity }}
          *Description:* {{ .Annotations.description }}
          *Investigation:* {{ .Annotations.runbook_url }}
          {{ end }}