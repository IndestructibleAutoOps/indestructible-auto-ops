// Jenkinsfile - 治理合规流水线
pipeline {
    agent { docker { image 'python:3.11' } }
    stages {
        stage('Governance Check') {
            steps {
                sh 'arch-linter validate --strict'
                sh 'dependency-check --format HTML --out reports/'
                sh 'snyk monitor --org=meta-governance'
            }
        }
        stage('Risk Assessment') {
            when {
        or {
          changeset "src/**"
          changeset "validation-rules/**"
          }
      }
            steps {
                sh 'python risk_analyzer.py --impact-level=high'
            }
        }
        stage('Shadow Deployment') {
            when { expression { return env.CHANGE_RISK == 'high' } }
            steps {
                sh 'docker-compose -f docker-compose.shadow.yml up -d'
                sh 'python traffic_shadow.py --duration=2h --sample-rate=5%'
            }
        }
    }
    post {
        failure {
            slackSend channel: '#governance-alerts', message: "治理规范违反: ${currentBuild.fullDisplayName}"
        }
    }
}
