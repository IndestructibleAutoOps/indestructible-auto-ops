#
# @GL-governed
# @GL-layer: GL90-99
# @GL-semantic: version-specification
# @GL-audit-trail: ../../GL_SEMANTIC_ANCHOR.json
#
# Strict Version Specification Schema
# 嚴格版本規範 Schema
#
# Compliance: Aviation Airworthiness-Grade
# Standards: DO-178C, ISO 9001, CCAR-21/R3
#

apiVersion: governance.ecosystem/v1
kind: VersionSpecification
metadata:
  name: strict-version-specification
  version: "1.0.0"
  created_at: "2026-02-02T00:00:00Z"
  owner: governance-committee
  enforcement_level: STRICT

spec:
  # ========================================================================
  # 0.1.1 版本格式規範
  # ========================================================================
  version_format:
    pattern: "^(0|[1-9]\\d*)\\.(0|[1-9]\\d*)\\.(0|[1-9]\\d*)(?:-((?:0|[1-9]\\d*|\\d*[a-zA-Z-][0-9a-zA-Z-]*)(?:\\.(?:0|[1-9]\\d*|\\d*[a-zA-Z-][0-9a-zA-Z-]*))*))?(?:\\+([0-9a-zA-Z-]+(?:\\.[0-9a-zA-Z-]+)*))?$"
    
    components:
      major:
        type: integer
        min: 0
        leading_zeros: forbidden
        
      minor:
        type: integer
        min: 0
        leading_zeros: forbidden
        
      patch:
        type: integer
        min: 0
        leading_zeros: forbidden
        
      prerelease:
        optional: true
        pattern: "^(alpha|beta|rc)\\.(0|[1-9]\\d*)$"
        examples:
          - "alpha.1"
          - "beta.3"
          - "rc.2"
          
      build:
        optional: true
        pattern: "^[0-9a-zA-Z-]+(\\.[0-9a-zA-Z-]+)*$"
        examples:
          - "20240201"
          - "ci.1456"

  # ========================================================================
  # 0.1.2 版本語意規則
  # ========================================================================
  version_semantics:
    major:
      triggers:
        - type: "api_removal"
          description: "移除任何已定義的規則、接口或要求"
          severity: CRITICAL
          
        - type: "behavior_change"
          description: "現有規則的預期行為發生改變"
          severity: CRITICAL
          
        - type: "mandatory_upgrade"
          description: "要求所有驗證器必須修改才能繼續合規"
          severity: CRITICAL
          
        - type: "dependency_breaking"
          description: "變更導致下游規範的兼容性被破壞"
          severity: HIGH
      
      mandatory_actions:
        - action: "migration_period_start"
          duration_days: 90
          
        - action: "downstream_revalidation"
          required: true
          deadline_days: 90
          
        - action: "migration_guide_publication"
          required: true
          
        - action: "impact_assessment_report"
          required: true
    
    minor:
      triggers:
        - type: "rule_addition"
          description: "添加新的驗證規則或檢查項"
          severity: MEDIUM
          
        - type: "optional_extension"
          description: "增加可選參數或配置項"
          severity: LOW
          
        - type: "restriction_relaxation"
          description: "放寬限制或閾值"
          severity: MEDIUM
          
        - type: "interface_addition"
          description: "增加新的API接口"
          severity: MEDIUM
      
      constraints:
        backward_compatibility: MANDATORY
        trial_period_days: 30
        rollback_mechanism: REQUIRED
    
    patch:
      triggers:
        - type: "semantic_clarification"
          description: "修正模糊、歧義或矛盾的描述"
          severity: LOW
          
        - type: "technical_correction"
          description: "修正範例代碼或實現指引中的錯誤"
          severity: LOW
          
        - type: "format_fix"
          description: "修正排版、拼寫錯誤"
          severity: LOW
          
        - type: "security_patch"
          description: "修正安全風險表述缺陷"
          severity: HIGH
      
      prohibitions:
        - "變更實際要求"
        - "新增或移除功能"
        - "改變接口定義"

  # ========================================================================
  # 0.1.3 版本標註要求
  # ========================================================================
  version_annotation:
    specification:
      required_fields:
        - field: "id"
          type: string
          pattern: "^[a-z][a-z0-9-]*$"
          
        - field: "version"
          type: string
          pattern: "^(0|[1-9]\\d*)\\.(0|[1-9]\\d*)\\.(0|[1-9]\\d*)$"
          
        - field: "version-semantics.compatibility"
          type: enum
          values: ["backward-compatible", "breaking", "new-feature"]
          
        - field: "version-semantics.release-type"
          type: enum
          values: ["stable", "beta", "alpha", "rc"]
          
        - field: "published"
          type: timestamp
          format: ISO8601
          
        - field: "effective-from"
          type: timestamp
          format: ISO8601
      
      example:
        id: "security-baseline"
        version: "1.3.5"
        version-semantics:
          compatibility: "backward-compatible"
          release-type: "stable"
        published: "2024-01-15T10:30:00Z"
        effective-from: "2024-02-01T00:00:00Z"
    
    validator:
      required_fields:
        - field: "id"
          type: string
          
        - field: "compliance"
          type: array
          items:
            - spec-id: string
            - version: string (exact)
            - implemented-at: timestamp
      
      example:
        id: "validator-001"
        compliance:
          - spec-id: "security-baseline"
            version: "1.3.5"
            implemented-at: "2024-01-20T15:45:00Z"

  # ========================================================================
  # 0.1.4 版本發布約束
  # ========================================================================
  release_constraints:
    version_continuity:
      skip_prevention: STRICT
      rules:
        - "PATCH: 不允許跳過 (1.0.0→1.0.1→1.0.2)"
        - "MINOR: 不允許跳過 (1.0.0→1.1.0→1.2.0)"
        - "MAJOR: 需完整序列 (1.x.x→2.0.0)"
      
      validation_method: |
        SELECT version FROM versions 
        WHERE spec_id = ?
        ORDER BY CAST(major AS INT), CAST(minor AS INT), CAST(patch AS INT)
        -- 檢查序列連續性
    
    version_permanence:
      reuse_prohibition: ABSOLUTE
      immutability: ENFORCED
      retention_policy: PERMANENT
      
    prerelease_management:
      formats:
        alpha: "X.Y.Z-alpha.N"
        beta: "X.Y.Z-beta.N"
        rc: "X.Y.Z-rc.N"
      
      restrictions:
        - "禁止用於生產環境"
        - "必須標記 release-type: 'beta'"
        - "不計入連續性檢查"

  # ========================================================================
  # 0.1.5 版本兼容性矩陣
  # ========================================================================
  compatibility_matrix:
    version_range_syntax:
      exact: "1.3.5"
      range: ">=1.3.0 <1.4.0"
      wildcard: "1.3.*"
      caret: "^1.3.0"  # 兼容 1.3.x 和 1.y.z (y>3)
      tilde: "~1.3.0"  # 僅兼容 1.3.x
    
    dependency_rules:
      A_depends_on_B:
        - B_patch_update: AUTO_ACCEPT
        - B_minor_update: REQUIRES_TESTING_30_DAYS
        - B_major_update: REQUIRES_MIGRATION_PLAN

  # ========================================================================
  # 0.1.6 變更日誌規範
  # ========================================================================
  changelog_requirements:
    format: markdown
    structure:
      - section: version_header
        pattern: "## [X.Y.Z] - YYYY-MM-DD"
        
      - section: changes
        categories:
          - "Added"
          - "Changed"
          - "Deprecated"
          - "Removed"
          - "Fixed"
          - "Security"
    
    example: |
      # 變更日誌 - 安全基礎規範
      
      ## [1.3.5] - 2024-01-15
      ### Fixed
      - 修正規則 4.2.1 中的措辭歧義
      
      ### Security
      - 修補 CVE-2024-1234 相關的安全建議表述

  # ========================================================================
  # 0.1.7 版本驗證與執行
  # ========================================================================
  version_validation:
    registry_validation:
      enabled: true
      central_registry: required
      
    signature_validation:
      enabled: true
      algorithm: RSA-4096
      required_signers:
        - spec-owner
        - security-reviewer
      
    hash_validation:
      enabled: true
      algorithm: SHA-256
      verification: MANDATORY
    
    non_compliance_handling:
      missing_version:
        action: REJECT_IMMEDIATELY
        grace_period: none
        
      deprecated_version:
        action: WARNING_THEN_REJECT
        grace_period_days: 30
        
      future_version:
        action: REJECT_IMMEDIATELY
        grace_period: none

  # ========================================================================
  # 0.1.8 開發版本管理
  # ========================================================================
  development_versions:
    namespaces:
      internal:
        - "dev-*"
        - "feat-*"
        - "bugfix-*"
        - "hotfix-*"
      
      prerelease:
        - "alpha.*"
        - "beta.*"
        - "rc.*"
      
      automation:
        - "ci-*"
        - "nightly-*"
        - "snapshot-*"
    
    format: "[PREFIX]-[BRANCH]-[COMMIT_HASH]-[TIMESTAMP]"
    
    examples:
      - "feat-mfa-auth-a1b2c3d4-202402020830"
      - "ci-master-e5f6g7h8-202402020900"
      - "nightly-develop-f9g0h1i2-20240201"
    
    usage_constraints:
      allowed_environments:
        - development
        - staging
        - integration-test
        - qa
      
      prohibited_environments:
        - production
        - customer-demo
        - compliance-audit
      
      expiration:
        snapshot: 30_days
        feature: 14_days
        hotfix: 7_days

  # ========================================================================
  # 航空適航級別約束（DO-178C, ISO 9001）
  # ========================================================================
  airworthiness_grade:
    requirements:
      - requirement_id: "RTM-001"
        name: "需求雙向可追溯性"
        coverage: 100%
        enforcement: MANDATORY
        
      - requirement_id: "FMEA-001"
        name: "故障容錯設計"
        method: "FMEA analysis + redundancy verification"
        enforcement: MANDATORY
        
      - requirement_id: "MISRA-C-001"
        name: "代碼規範檢查"
        standard: "MISRA-C:2012"
        enforcement: MANDATORY
        
      - requirement_id: "COV-001"
        name: "測試覆蓋率"
        statement_coverage: ">=95%"
        branch_coverage: ">=90%"
        boundary_test: "100%"
        enforcement: MANDATORY
    
    process_control:
      real_time_monitoring: enabled
      parameter_deviation: "±0.5%"
      auto_failover: "連續3次超差→自動切換"
      blockchain_audit: enabled
      traceability_time: "≤5ms"

enforcement:
  strict_mode: true
  continue_on_error: false
  validation_required: true
  audit_trail_required: true
  digital_signature_required: true
  
monitoring:
  real_time_compliance: enabled
  drift_detection: enabled
  auto_remediation: enabled
  
automation:
  ci_cd_integration: MANDATORY
  pre_commit_hooks: ENABLED
  version_gate_enforcement: STRICT
